package com.ufgov.zc.client.zc.zcppromake;import static com.ufgov.zc.common.system.constants.ZcElementConstants.TITLE_TRANS_ZC_P_PRO_MAKE;import java.math.BigDecimal;import java.util.List;import javax.swing.JComponent;import javax.swing.JFrame;import javax.swing.JOptionPane;import javax.swing.SwingUtilities;import javax.swing.UIManager;import org.apache.commons.lang.ObjectUtils;import org.apache.log4j.Logger;import com.ufgov.smartclient.plaf.BlueLookAndFeel;import com.ufgov.zc.client.common.BillElementMeta;import com.ufgov.zc.client.common.LangTransMeta;import com.ufgov.zc.client.common.ListCursor;import com.ufgov.zc.client.component.GkBaseDialog;import com.ufgov.zc.client.zc.ZcUtil;import com.ufgov.zc.common.commonbiz.model.BillElement;import com.ufgov.zc.common.system.constants.WFConstants;import com.ufgov.zc.common.system.constants.ZcElementConstants;import com.ufgov.zc.common.system.dto.ElementConditionDto;import com.ufgov.zc.common.zc.model.ZcPProMake;import com.ufgov.zc.common.zc.model.ZcPProMitem;import com.ufgov.zc.common.zc.model.ZcPProMitemBi;@SuppressWarnings("unchecked")public class ZcPProMakeXMListPanel extends ZcPProMakeListPanel {  private static final long serialVersionUID = 1277810469937954543L;  public static final Logger logger = Logger.getLogger(ZcPProMakeXMListPanel.class);  public String getCompoId() {    return "ZC_P_PRO_MAKE";  }  public String getTitle() {    return LangTransMeta.translate(ZcElementConstants.FIELD_TRANS_ZC_MAKE_TITEL);  }  public ZcPProMakeEditPanel getEditPanel(GkBaseDialog parent, ListCursor listCursor, String tabStatus, ZcPProMakeListPanel listPanel) {    return new ZcPProMakeXMEditPanel(parent, listCursor, tabStatus, listPanel);  }  public void setElementConditionDto(ElementConditionDto dto) {    // 项目采购    dto.setZcText2(ZcPProMake.CAIGOU_TYPE_XIANGMU);  }  public void setButtonsVisiable() {    String panelId = WFConstants.AUDIT_TAB_STATUS_TODO;    if (topDataDisplay != null && topDataDisplay.getActiveTableDisplay() != null) {      panelId = topDataDisplay.getActiveTableDisplay().getStatus();    }    if (WFConstants.AUDIT_TAB_STATUS_TODO.equalsIgnoreCase(panelId)) {//代办      auditPassButton.setVisible(true);      suggestPassButton.setVisible(true);      isSendToNextButton.setVisible(true);      unTreadButton.setVisible(true);      sendButton.setVisible(false);      deleteButton.setVisible(false);      addButton.setVisible(false);      addReChangeButton.setVisible(false);      callbackButton.setVisible(false);      traceButton.setVisible(true);      editButton.setVisible(false);      unAuditButton.setVisible(false);      cancelButton.setVisible(true);    } else if (WFConstants.AUDIT_TAB_STATUS_DONE.equalsIgnoreCase(panelId)) {//已办      auditPassButton.setVisible(false);      isSendToNextButton.setVisible(false);      unTreadButton.setVisible(false);      sendButton.setVisible(false);      deleteButton.setVisible(false);      addButton.setVisible(false);      addReChangeButton.setVisible(false);      callbackButton.setVisible(true);      traceButton.setVisible(true);      suggestPassButton.setVisible(false);      editButton.setVisible(false);      unAuditButton.setVisible(true);      cancelButton.setVisible(false);    } else if (WFConstants.AUDIT_TAB_STATUS_ALL.equalsIgnoreCase(panelId)) {//全部      auditPassButton.setVisible(false);      isSendToNextButton.setVisible(false);      unTreadButton.setVisible(false);      sendButton.setVisible(false);      deleteButton.setVisible(false);      addButton.setVisible(false);      addReChangeButton.setVisible(false);      callbackButton.setVisible(false);      traceButton.setVisible(true);      suggestPassButton.setVisible(false);      editButton.setVisible(false);      unAuditButton.setVisible(false);      cancelButton.setVisible(false);    } else if (WFConstants.EDIT_TAB_STATUS_EXEC.equalsIgnoreCase(panelId)) {//终审      auditPassButton.setVisible(false);      isSendToNextButton.setVisible(false);      unTreadButton.setVisible(false);      sendButton.setVisible(false);      deleteButton.setVisible(false);      addButton.setVisible(false);      addReChangeButton.setVisible(false);      callbackButton.setVisible(false);      suggestPassButton.setVisible(false);      editButton.setVisible(false);      unAuditButton.setVisible(false);      cancelButton.setVisible(false);    } else if (WFConstants.EDIT_TAB_STATUS_DRAFT.equalsIgnoreCase(panelId)) {//草稿      auditPassButton.setVisible(false);      isSendToNextButton.setVisible(false);      unTreadButton.setVisible(false);      sendButton.setVisible(true);      deleteButton.setVisible(true);      addButton.setVisible(true);      addReChangeButton.setVisible(true);      callbackButton.setVisible(false);      suggestPassButton.setVisible(false);      editButton.setVisible(true);      unAuditButton.setVisible(false);      cancelButton.setVisible(true);    } else if ("cancel".equalsIgnoreCase(panelId)) {      traceButton.setVisible(false);      sendButton.setVisible(false);      suggestPassButton.setVisible(false);      unTreadButton.setVisible(false);      addButton.setVisible(false);      deleteButton.setVisible(false);      printButton.setVisible(false);      printPreviewButton.setVisible(false);      printSettingButton.setVisible(false);      callbackButton.setVisible(false);      unAuditButton.setVisible(false);      exportButton.setVisible(false);      confirmSupplyButton.setVisible(false);      cancelButton.setVisible(false);    }  }  /**   * 保存前校验   * @param cpApply   * @return   */  public boolean checkBeforeSave(ZcPProMake zcPProMake, JComponent panel) {    List mainNotNullList = ((BillElementMeta) billElementMeta).getNotNullBillElement();    List biNotNullList = biBillElementMeta.getNotNullBillElement();    List itemNotNullList = itemBillElementMeta.getNotNullBillElement();    //当采购方式为协议供货二次竞价时对竞价品牌的非空验证  add by humina    for (int i = 0; i < mainNotNullList.size(); i++) {      BillElement b = (BillElement) mainNotNullList.get(i);      if ("ZC_FIELD_JJPP".equals(b.getElementCode())) {        if (!"7".equals(zcPProMake.getZcPitemOpiway())) {          mainNotNullList.remove(b);        }      }      if ("ZC_TRUST_AGEY_CODE".equals(b.getElementCode())) {        if (suggestPassCZButton.isVisible()) {          mainNotNullList.remove(b);        }      }    }    StringBuilder errorInfo = new StringBuilder();    String mainValidateInfo = ZcUtil.validateBillElementNull(zcPProMake, mainNotNullList);    String biValidateInfo = ZcUtil.validateDetailBillElementNull(zcPProMake.getBiList(), biNotNullList, false);    String itemValidateInfo = ZcUtil.validateDetailBillElementNull(zcPProMake.getItemList(), itemNotNullList, false);    if (mainValidateInfo.length() != 0) {      errorInfo.append(LangTransMeta.translate(TITLE_TRANS_ZC_P_PRO_MAKE)).append("：\n").append(mainValidateInfo.toString());    }    String tel = zcPProMake.getZcMakeTel();    if (tel != null && !"".equals(tel)) {//暂不处理电话的格式 20130924 chenjl//      if (!checkTel(tel)) {////        errorInfo.append("[联系电话]必须按规格输入！").append("\n");////      }    }    if (this.budgetFlag && biValidateInfo.length() == 0) {      biValidateInfo = checkBiMoney(zcPProMake.getBiList());    }    if (biValidateInfo.length() != 0) {      //errorInfo.append("资金构成：\n").append(biValidateInfo.toString()).append("\n"); //wangwei notes 2011-04-07-23:17      errorInfo.append("资金构成：\n").append(biValidateInfo.toString()).append("\n");    }    if (itemValidateInfo.length() != 0) {        errorInfo.append("计划明细：\n").append(itemValidateInfo.toString());    }    //计划明细：计划明细附件和基本规格要求的判空    for (int i = 0; i < zcPProMake.getItemList().size(); i++) {      ZcPProMitem mItem = (ZcPProMitem) zcPProMake.getItemList().get(i);      if (mItem.getZcCaigNum() == null || mItem.getZcCaigNum().intValue() == 0) {        errorInfo.append("计划明细 第 [" + (i + 1) + "] 行 [采购数量] 必须填写！").append("\n");      }      if (mItem.getZcPitemName() == null) {        errorInfo.append("计划明细 第 [" + (i + 1) + "] 行 [项目清单] 必须填写！").append("\n");      }      if (mItem.getZcPitemAttachBlobid() == null && mItem.getZcBaseGgyq() == null) {        errorInfo.append("计划明细 第 [" + (i + 1) + "] 行 [规格] 或 [计划明细附件] 至少需要填写一条！").append("\n");      }    }    for (int i = 0; i < zcPProMake.getBiList().size(); i++) {      ZcPProMitemBi bi = (ZcPProMitemBi) zcPProMake.getBiList().get(i);      if (!"A".equals(bi.getPaytypeCode()) && (bi.getZcBiNo() == null || "".equals(bi.getZcBiNo()))) {        errorInfo.append("资金构成：\n政策性资金指标余额表ID不能为空！\n");        break;      }    }    //计划明细总和    BigDecimal sum = new BigDecimal(0);    for (Object o : zcPProMake.getItemList()) {      ZcPProMitem item = (ZcPProMitem) o;      BigDecimal zcItemSum = (BigDecimal) ObjectUtils.defaultIfNull(item.getZcItemSum(), new BigDecimal(0));      sum = sum.add(zcItemSum);    }    if (sum.compareTo(zcPProMake.getZcMoneyBiSum()) == 1) {      errorInfo.append("计划明细：\n单项预算金额合计应小于等于项目预算！\n");    }    if (errorInfo.length() != 0) {      JOptionPane.showMessageDialog(panel, errorInfo.toString(), "提示", JOptionPane.WARNING_MESSAGE);      return true;    }    return false;  }  public static void main(String[] args) throws Exception {    SwingUtilities.invokeLater(new Runnable() {      public void run() {        try {          UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());          UIManager.setLookAndFeel(new BlueLookAndFeel());        } catch (Exception e) {          e.printStackTrace();        }        //        UIManager.getDefaults().put("SplitPaneUI", BigButtonSplitPaneUI.class.getName());        ZcPProMakeXMListPanel bill = new ZcPProMakeXMListPanel();        JFrame frame = new JFrame("frame");        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);        frame.setSize(800, 600);        frame.setLocationRelativeTo(null);        frame.getContentPane().add(bill);        frame.setVisible(true);      }    });  }}