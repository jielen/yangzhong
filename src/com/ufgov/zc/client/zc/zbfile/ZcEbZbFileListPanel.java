/**   * @(#) project: ZFCG* @(#) file: ZcEbZbFileListPanel.java* * Copyright 2011 UFGOV, Inc. All rights reserved.* UFGOV PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.* */package com.ufgov.zc.client.zc.zbfile;import java.awt.Color;import java.awt.Container;import java.awt.DefaultKeyboardFocusManager;import java.awt.Font;import java.awt.Window;import java.awt.Dialog.ModalityType;import java.awt.event.ActionEvent;import java.awt.event.ActionListener;import java.awt.event.MouseAdapter;import java.awt.event.MouseEvent;import java.util.ArrayList;import java.util.HashMap;import java.util.List;import java.util.Map;import javax.swing.BorderFactory;import javax.swing.JFrame;import javax.swing.JOptionPane;import javax.swing.SwingUtilities;import javax.swing.UIManager;import javax.swing.border.TitledBorder;import javax.swing.table.TableModel;import org.apache.log4j.Logger;import com.ufgov.smartclient.common.DefaultInvokeHandler;import com.ufgov.smartclient.common.UIUtilities;import com.ufgov.smartclient.component.table.JGroupableTable;import com.ufgov.smartclient.plaf.BlueLookAndFeel;import com.ufgov.zc.client.common.LangTransMeta;import com.ufgov.zc.client.common.MyTableModel;import com.ufgov.zc.client.common.ParentWindowAware;import com.ufgov.zc.client.common.ServiceFactory;import com.ufgov.zc.client.common.WorkEnv;import com.ufgov.zc.client.common.converter.zc.ZcEbZbFileToTableModelConverter;import com.ufgov.zc.client.component.GkCommentDialog;import com.ufgov.zc.client.component.GkCommentUntreadDialog;import com.ufgov.zc.client.component.JFuncToolBar;import com.ufgov.zc.client.component.ui.AbstractDataDisplay;import com.ufgov.zc.client.component.ui.AbstractEditListBill;import com.ufgov.zc.client.component.ui.AbstractSearchConditionArea;import com.ufgov.zc.client.component.ui.MultiDataDisplay;import com.ufgov.zc.client.component.ui.SaveableSearchConditionArea;import com.ufgov.zc.client.component.ui.TableDisplay;import com.ufgov.zc.client.component.ui.conditionitem.AbstractSearchConditionItem;import com.ufgov.zc.client.component.ui.conditionitem.SearchConditionUtil;import com.ufgov.zc.client.util.BalanceUtil;import com.ufgov.zc.client.util.ListUtil;import com.ufgov.zc.client.zc.ZcUtil;import com.ufgov.zc.common.commonbiz.model.SearchCondition;import com.ufgov.zc.common.system.RequestMeta;import com.ufgov.zc.common.system.constants.ZcSettingConstants;import com.ufgov.zc.common.system.dto.ElementConditionDto;import com.ufgov.zc.common.system.exception.BaseException;import com.ufgov.zc.common.system.exception.DataAlreadyDeletedException;import com.ufgov.zc.common.system.exception.OtherException;import com.ufgov.zc.common.system.util.ObjectUtil;import com.ufgov.zc.common.zc.model.ZcEbProjZbFile;import com.ufgov.zc.common.zc.publish.IZcEbZbFileServiceDelegate;/*** @ClassName: ZcEbZbFileListPanel* @Description: TODO(这里用一句话描述这个类的作用)* @date: 2011-3-17 下午03:19:56* @version: V1.0 * @since: 1.0* @author: fanpl* @modify: */public class ZcEbZbFileListPanel extends AbstractEditListBill implements ParentWindowAware {  private static final Logger logger = Logger.getLogger(ZcEbZbFileListPanel.class);  private ZcEbZbFileListPanel self = this;  private Window parentWindow;  private String compoId = "ZC_EB_PROJ_ZBFILE";  private RequestMeta requestMeta = WorkEnv.getInstance().getRequestMeta();  private ElementConditionDto elementConditionDto = new ElementConditionDto();  public IZcEbZbFileServiceDelegate zcEbZbFileServiceDelegate = (IZcEbZbFileServiceDelegate) ServiceFactory  .create(IZcEbZbFileServiceDelegate.class, "zcEbZbFileServiceDelegate");  public IZcEbZbFileServiceDelegate getZcEbZbFileServiceDelegate() {    return zcEbZbFileServiceDelegate;  }  public void setZcEbZbFileServiceDelegate(IZcEbZbFileServiceDelegate zcEbZbFileServiceDelegate) {    this.zcEbZbFileServiceDelegate = zcEbZbFileServiceDelegate;  }  public Window getParentWindow() {    return parentWindow;  }  public void setParentWindow(Window parentWindow) {    this.parentWindow = parentWindow;  }  private final class DataDisplay extends MultiDataDisplay {    private DataDisplay(List<TableDisplay> displays, List<TableDisplay> showingDisplays,    AbstractSearchConditionArea conditionArea, boolean showConditionArea) {      super(displays, showingDisplays, conditionArea, showConditionArea,      ZcSettingConstants.TAB_ID_ZC_EB_ZB_FILE);      setBorder(BorderFactory.createTitledBorder(BorderFactory.createEtchedBorder(), "招标文件审核",      TitledBorder.CENTER, TitledBorder.TOP, new Font("宋体", Font.BOLD, 15), Color.BLUE));    }    @Override    protected void preprocessShowingTableDisplay(List<TableDisplay> showingTableDisplays) {      for (final TableDisplay d : showingTableDisplays) {        final JGroupableTable table = d.getTable();        table.addMouseListener(new MouseAdapter() {          @Override          public void mouseClicked(MouseEvent e) {            if (e.getClickCount() == 2 && SwingUtilities.isLeftMouseButton(e)) {              String tabStatus = d.getStatus();              JGroupableTable table = d.getTable();              MyTableModel model = (MyTableModel) table.getModel();              int row = table.getSelectedRow();              List viewList = (List) ObjectUtil.deepCopy(ListUtil.convertToTableViewOrderList(              model.getList(), table));              new ZcEbZbFileDialog(self, viewList, row, tabStatus);            }          }        });      }    }    @Override    protected void handleTableDisplayActived(AbstractSearchConditionItem[] searchConditionItems,    final TableDisplay tableDisplay) {      elementConditionDto.setWfcompoId(compoId);      elementConditionDto.setExecutor(WorkEnv.getInstance().getCurrUserId());      elementConditionDto.setNd(WorkEnv.getInstance().getTransNd());      elementConditionDto.setStatus(tableDisplay.getStatus());      elementConditionDto.setMonth(BalanceUtil.getMonthIdBySysOption());      for (AbstractSearchConditionItem item : searchConditionItems) {        item.putToElementConditionDto(elementConditionDto);      }      final Container c = tableDisplay.getTable().getParent();      UIUtilities.asyncInvoke(new DefaultInvokeHandler<TableModel>() {        @Override        public void before() {          assert c != null;          installLoadingComponent(c);        }        @Override        public void after() {          assert c != null;          unInstallLoadingComponent(c);          c.add(tableDisplay.getTable());        }        @Override        public TableModel execute() throws Exception {          ZcEbZbFileToTableModelConverter mc = new ZcEbZbFileToTableModelConverter();          return mc.convertToTableModel(self.zcEbZbFileServiceDelegate.getZcebZbFileList(elementConditionDto,          requestMeta));        }        @Override        public void success(TableModel model) {          tableDisplay.setTableModel(model);          setButtonsVisiable();        }      });    }  }  static {    LangTransMeta.init("ZC%");  }  /**   * 构造函数   */  public ZcEbZbFileListPanel() {    UIUtilities.asyncInvoke(new DefaultInvokeHandler<List<SearchCondition>>() {      @Override      public List<SearchCondition> execute() throws Exception {        List<SearchCondition> needDisplaySearchConditonList = SearchConditionUtil        .getNeedDisplaySearchConditonListJoinRole(WorkEnv.getInstance().getCurrUserId(),        ZcSettingConstants.TAB_ID_ZC_EB_ZB_FILE);        return needDisplaySearchConditonList;      }      @Override      public void success(List<SearchCondition> needDisplaySearchConditonList) {        List<TableDisplay> showingDisplays = SearchConditionUtil        .getNeedDisplayTableDisplay(needDisplaySearchConditonList);        init(createDataDisplay(showingDisplays), null);//调用父类方法        revalidate();        repaint();      }    });    requestMeta.setCompoId(compoId);  }  private AbstractSearchConditionArea topSearchConditionArea;  private AbstractSearchConditionArea createTopConditionArea() {    Map defaultValueMap = new HashMap();    topSearchConditionArea = new SaveableSearchConditionArea(    ZcSettingConstants.CONDITION_ID_TAB_ID_ZC_EB_ZB_FILE, null, true, defaultValueMap, null);    return topSearchConditionArea;  }  private AbstractDataDisplay createDataDisplay(List<TableDisplay> showingDisplays) {    return new DataDisplay(SearchConditionUtil.getAllTableDisplayJoinRole(WorkEnv.getInstance()    .getCurrUserId(), ZcSettingConstants.TAB_ID_ZC_EB_ZB_FILE), showingDisplays, createTopConditionArea(),    true);//true:显示收索条件区 false：不显示收索条件区  }  @Override  protected void addToolBarComponent(JFuncToolBar toolBar) {    toolBar.setModuleCode("ZC");    toolBar.setCompoId(compoId);    toolBar.add(addButton);    toolBar.add(deleteButton);    toolBar.add(sendButton);    //toolBar.add(isSendToNextButton);    //toolBar.add(suggestPassButton);//填写意见审核通过    //toolBar.add(auditPassButton);    //toolBar.add(auditFinalButton);    //toolBar.add(callbackButton);    //toolBar.add(unTreadButton);//退回    toolBar.add(traceButton);    traceButton.addActionListener(new ActionListener() {      public void actionPerformed(ActionEvent e) {        // 流程跟踪        doTrace();      }    });    sendButton.addActionListener(new ActionListener() {      public void actionPerformed(ActionEvent e) {        doSend();      }    });    isSendToNextButton.addActionListener(new ActionListener() {      public void actionPerformed(ActionEvent e) {        doSendNext();      }    });    auditPassButton.addActionListener(new ActionListener() {      public void actionPerformed(ActionEvent e) {        doAuditPass();      }    });    suggestPassButton.addActionListener(new ActionListener() {      public void actionPerformed(ActionEvent e) {        doSuggestPass();      }    });    callbackButton.addActionListener(new ActionListener() {      public void actionPerformed(ActionEvent e) {        doCallBack();      }    });    unTreadButton.addActionListener(new ActionListener() {      public void actionPerformed(ActionEvent e) {        doUnTread();      }    });    printButton.addActionListener(new ActionListener() {      public void actionPerformed(ActionEvent arg0) {        //        doPrint();      }    });    printPreviewButton.addActionListener(new ActionListener() {      public void actionPerformed(ActionEvent arg0) {        //        doPrintPreview();      }    });    deleteButton.addActionListener(new ActionListener() {      public void actionPerformed(ActionEvent e) {        doDelete();      }    });    auditFinalButton.addActionListener(new ActionListener() {      public void actionPerformed(ActionEvent e) {        doAuditFinal();      }    });  }  private void doAuditFinal() {    List beanList = getCheckedList();    if (beanList.size() == 0) {      JOptionPane.showMessageDialog(this, "没有选择数据！", " 提示", JOptionPane.INFORMATION_MESSAGE);      return;    }    requestMeta.setFuncId(this.auditFinalButton.getFuncId());    executeAudit(beanList, ZcSettingConstants.IS_GOON_AUDIT_YES);  }  private void doDelete() {    List checkedList = getCheckedList();    if (checkedList.size() == 0) {      JOptionPane.showMessageDialog(this, "请选择需要删除的数据!", "提示", JOptionPane.INFORMATION_MESSAGE);      return;    }    int result = JOptionPane.showConfirmDialog(self, "是否要删除选中的数据?", "删除确认", JOptionPane.YES_NO_OPTION);    if (result != JOptionPane.YES_OPTION) {      return;    }    StringBuffer errorInfo = new StringBuffer("");    boolean success = true;    requestMeta.setFuncId(deleteButton.getFuncId());    try {      for (int i = 0; i < checkedList.size(); i++) {        ZcEbProjZbFile zbFile = (ZcEbProjZbFile) checkedList.get(i);        zcEbZbFileServiceDelegate.deleteZcEbProjZbFileByProjCodeFN(zbFile.getProjCode(), requestMeta);      }    } catch (DataAlreadyDeletedException ex) {      errorInfo.append(ex.getMessage() + "\n");      logger.error(ex.getStackTraceMessage(), ex);      success = false;    } catch (BaseException ex) {      errorInfo.append(ex.getMessage() + "\n");      logger.error(ex.getStackTraceMessage(), ex);      success = false;    } catch (OtherException ex) {      errorInfo.append(ex.getMessage() + "\n");      logger.error(ex.getStackTraceMessage(), ex);      success = false;    } catch (Exception ex) {      errorInfo.append(ex.getMessage() + "\n");      logger.error(ex.getMessage(), ex);      success = false;    }    if (success) {      JOptionPane.showMessageDialog(this, "删除成功！", "提示", JOptionPane.INFORMATION_MESSAGE);      refreshCurrentTabData();    } else {      JOptionPane.showMessageDialog(this, "删除错误!\n" + errorInfo, "错误", JOptionPane.ERROR_MESSAGE);    }  }  public void doTrace() {    ZcUtil.showTraceDialog(getCheckedList(), this);  }  private void doSend() {    List beanList = this.getCheckedList();    if (beanList.size() == 0) {      JOptionPane.showMessageDialog(this, "没有选择数据！", " 提示", JOptionPane.INFORMATION_MESSAGE);      return;    }    boolean success = true;    String errorInfo = "";    requestMeta.setFuncId(this.sendButton.getFuncId());    try {      for (int i = 0; i < beanList.size(); i++) {        ZcEbProjZbFile zcEbProjZbFile = (ZcEbProjZbFile) ObjectUtil.deepCopy(beanList.get(i));        zcEbProjZbFile.setAuditorId(WorkEnv.getInstance().getCurrUserId());        zcEbZbFileServiceDelegate.newCommitFN(zcEbProjZbFile, requestMeta);      }    } catch (Exception ex) {      errorInfo += ex.getMessage();      logger.error(ex.getMessage(), ex);      success = false;      UIUtilities.showStaickTraceDialog(ex, this, "错误", ex.getMessage());    }    if (success) {      JOptionPane.showMessageDialog(this, "送审成功！", "提示", JOptionPane.INFORMATION_MESSAGE);      this.refreshCurrentTabData();    }  }  private void doSendNext() {    List beanList = getCheckedList();    if (beanList.size() == 0) {      JOptionPane.showMessageDialog(this, "没有选择数据！", " 提示", JOptionPane.INFORMATION_MESSAGE);      return;    }    //    int sel = JOptionPane.showConfirmDialog(this, "是否送主任审核？");    //    if (sel == JOptionPane.OK_OPTION) {    //      executeAudit(beanList, ZcSettingConstants.IS_GOON_AUDIT_YES);    //    } else {    //      executeAudit(beanList, ZcSettingConstants.IS_GOON_AUDIT_NO);    //    }    requestMeta.setFuncId(this.isSendToNextButton.getFuncId());    executeAudit(beanList, ZcSettingConstants.IS_GOON_AUDIT_YES);  }  private void executeAudit(List beanList, int isGoonAudit) {    GkCommentDialog commentDialog = new GkCommentDialog(DefaultKeyboardFocusManager    .getCurrentKeyboardFocusManager().getActiveWindow(), ModalityType.APPLICATION_MODAL);    if (commentDialog.cancel) {      return;    }    boolean success = true;    String errorInfo = "";    try {      for (int i = 0; i < beanList.size(); i++) {        ZcEbProjZbFile bill = (ZcEbProjZbFile) beanList.get(i);        bill.setIsGoonAudit(isGoonAudit);        bill.setComment(commentDialog.getComment());        bill.setAuditorId(WorkEnv.getInstance().getCurrUserId());      }      for (int i = 0; i < beanList.size(); i++) {        ZcEbProjZbFile zcEbProjZbFile = (ZcEbProjZbFile) ObjectUtil.deepCopy(beanList.get(i));        zcEbProjZbFile.setAuditorId(WorkEnv.getInstance().getCurrUserId());        this.zcEbZbFileServiceDelegate.saveZcEbProjZbFileFN(zcEbProjZbFile, requestMeta);        this.zcEbZbFileServiceDelegate.auditFN(zcEbProjZbFile, requestMeta);      }    } catch (Exception e) {      success = false;      logger.error(e.getMessage(), e);      errorInfo += e.getMessage();    }    if (success) {      JOptionPane.showMessageDialog(this, "审核成功！", "提示", JOptionPane.INFORMATION_MESSAGE);      this.refreshCurrentTabData();    } else {      JOptionPane.showMessageDialog(this, "审核失败 ！" + errorInfo, "错误", JOptionPane.ERROR_MESSAGE);    }  }  public RequestMeta getRequestMeta() {    return requestMeta;  }  public void setRequestMeta(RequestMeta requestMeta) {    this.requestMeta = requestMeta;  }  private void doAuditPass() {    List beanList = this.getCheckedList();    if (beanList.size() == 0) {      JOptionPane.showMessageDialog(this, "没有选择数据！", " 提示", JOptionPane.INFORMATION_MESSAGE);      return;    }    requestMeta.setFuncId(this.auditPassButton.getFuncId());    executeAudit(beanList, ZcSettingConstants.IS_GOON_AUDIT_NO);  }  private void doSuggestPass() {    List beanList = this.getCheckedList();    if (beanList.size() == 0) {      JOptionPane.showMessageDialog(this, "没有选择数据！", " 提示", JOptionPane.INFORMATION_MESSAGE);      return;    }    boolean success = true;    String errorInfo = "";    requestMeta.setFuncId(this.suggestPassButton.getFuncId());    try {      for (int i = 0; i < beanList.size(); i++) {        ZcEbProjZbFile bill = (ZcEbProjZbFile) ObjectUtil.deepCopy(beanList.get(i));        bill.setAuditorId(WorkEnv.getInstance().getCurrUserId());        bill.setIsGoonAudit(ZcSettingConstants.IS_GOON_AUDIT_NO);        this.zcEbZbFileServiceDelegate.saveZcEbProjZbFileFN(bill, requestMeta);        zcEbZbFileServiceDelegate.auditFN(bill, requestMeta);      }    } catch (Exception ex) {      errorInfo += ex.getMessage();      logger.error(ex.getMessage(), ex);      success = false;      UIUtilities.showStaickTraceDialog(ex, this, "错误", ex.getMessage());    }    if (success) {      JOptionPane.showMessageDialog(this, "审核成功！", "提示", JOptionPane.INFORMATION_MESSAGE);      this.refreshCurrentTabData();    }  }  private void doCallBack() {    List beanList = this.getCheckedList();    if (beanList.size() == 0) {      JOptionPane.showMessageDialog(this, "没有选择数据！", " 提示", JOptionPane.INFORMATION_MESSAGE);      return;    }    boolean success = true;    String errorInfo = "";    try {      for (int i = 0; i < beanList.size(); i++) {        requestMeta.setFuncId(this.callbackButton.getFuncId());        ZcEbProjZbFile bill = (ZcEbProjZbFile) beanList.get(i);        bill.setAuditorId(WorkEnv.getInstance().getCurrUserId());        zcEbZbFileServiceDelegate.callbackFN(bill, requestMeta);      }    } catch (Exception e) {      success = false;      logger.error(e.getMessage(), e);      errorInfo += e.getMessage();    }    if (success) {      JOptionPane.showMessageDialog(this, "收回成功！", "提示", JOptionPane.INFORMATION_MESSAGE);      this.refreshCurrentTabData();    } else {      JOptionPane.showMessageDialog(this, "收回失败 ！" + errorInfo, "错误", JOptionPane.ERROR_MESSAGE);    }  }  private void doUnTread() {    List beanList = this.getCheckedList();    if (beanList.size() == 0) {      JOptionPane.showMessageDialog(this, "没有选择数据！", " 提示", JOptionPane.INFORMATION_MESSAGE);      return;    }    GkCommentUntreadDialog commentDialog = new GkCommentUntreadDialog(DefaultKeyboardFocusManager    .getCurrentKeyboardFocusManager().getActiveWindow(), ModalityType.APPLICATION_MODAL);    if (commentDialog.cancel) {      return;    }    boolean success = true;    String errorInfo = "";    try {      for (int i = 0; i < beanList.size(); i++) {        requestMeta.setFuncId(unTreadButton.getFuncId());        ZcEbProjZbFile bill = (ZcEbProjZbFile) beanList.get(i);        bill.setAuditorId(WorkEnv.getInstance().getCurrUserId());        bill.setComment(commentDialog.getComment());        zcEbZbFileServiceDelegate.untreadFN(bill, requestMeta);      }    } catch (Exception e) {      success = false;      logger.error(e.getMessage(), e);      errorInfo += e.getMessage();    }    if (success) {      JOptionPane.showMessageDialog(this, "退回成功！", "提示", JOptionPane.INFORMATION_MESSAGE);      this.refreshCurrentTabData();    } else {      JOptionPane.showMessageDialog(this, "退回失败 ！" + errorInfo, "错误", JOptionPane.ERROR_MESSAGE);    }  }  public void refreshCurrentTabData() {    topSearchConditionArea.doSearch();  }  public List getCheckedList() {    List<ZcEbProjZbFile> beanList = new ArrayList<ZcEbProjZbFile>();    JGroupableTable table = topDataDisplay.getActiveTableDisplay().getTable();    MyTableModel model = (MyTableModel) table.getModel();    //Modal的数据    List list = model.getList();    Integer[] checkedRows = table.getCheckedRows();    for (Integer checkedRow : checkedRows) {      int accordDataRow = table.convertRowIndexToModel(checkedRow);      ZcEbProjZbFile bean = (ZcEbProjZbFile) list.get(accordDataRow);      beanList.add(bean);    }    return beanList;  }  public static void main(String[] args) throws Exception {    SwingUtilities.invokeLater(new Runnable() {      public void run() {        try {          UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());          UIManager.setLookAndFeel(new BlueLookAndFeel());        } catch (Exception e) {          e.printStackTrace();        }        //        UIManager.getDefaults().put("SplitPaneUI", BigButtonSplitPaneUI.class.getName());        ZcEbZbFileListPanel bill = new ZcEbZbFileListPanel();        JFrame frame = new JFrame("frame");        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);        frame.setSize(800, 600);        frame.setLocationRelativeTo(null);        frame.getContentPane().add(bill);        frame.setVisible(true);      }    });  }  public void refreshCurrentTabData(List dataList) {    ZcEbZbFileToTableModelConverter mc = new ZcEbZbFileToTableModelConverter();    topDataDisplay.getActiveTableDisplay().getTable().setModel(mc.convertToTableModel(dataList));  }}