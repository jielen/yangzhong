/**   * @(#) project: ZC* @(#) file: CreateFormulaXmlTree.java* * Copyright 2010 UFGOV, Inc. All rights reserved.* UFGOV PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.* */package com.ufgov.zc.client.zc.formula;import java.awt.BorderLayout;import java.io.BufferedWriter;import java.io.File;import java.io.FileReader;import java.io.FileWriter;import java.io.IOException;import java.util.HashMap;import java.util.Map;import javax.swing.JFrame;import javax.swing.JPanel;import javax.swing.SwingUtilities;import javax.swing.UIManager;import com.thoughtworks.xstream.XStream;import com.thoughtworks.xstream.io.xml.DomDriver;import com.ufgov.smartclient.common.UIUtilities;import com.ufgov.smartclient.plaf.BlueLookAndFeel;import com.ufgov.zc.client.common.UIConstants;import com.ufgov.zc.client.zc.ztb.fileResumeBroken.authentication.Transfer;import com.ufgov.zc.common.system.exception.BaseException;import com.ufgov.zc.common.zc.model.ZcEbFormula;/*** @ClassName: CreateFormulaXmlTree* @Description: TODO(这里用一句话描述这个类的作用)* @date: 2010-12-13 下午06:03:11* @version: V1.0 * @since: 1.0* @author: fanpl* @modify: */public class CreateFormulaXmlTree extends JPanel {  private ZcEbFormula zcEbFormula;  private String projCode;  private String packCode;  private ZcEbFormula formula;  private String filePath = "C:\\ufgov\\eb\\download\\ztb\\formula.xml";  /**   *    * <p>Description:从数据库中读取评标方法生成xml文件 </p>    * @param formulaCode   */  public CreateFormulaXmlTree(String projCode, String packCode, boolean isOffLine, String fullPath) {    this.filePath = fullPath;    this.init(projCode, packCode, isOffLine);  }  public CreateFormulaXmlTree(String projCode, String packCode, boolean isOffLine) {    this.init(projCode, packCode, isOffLine);  }  private void init(String projCode, String packCode, boolean isOffLine) {    this.projCode = projCode;    this.packCode = packCode;    this.setLayout(new BorderLayout());    this.add(createFormulaTree(isOffLine), BorderLayout.CENTER);  }  private String createFormulaXml(ZcEbFormula zcEbFormula) {    XStream xstream = new XStream(new DomDriver());    String xml = xstream.toXML(zcEbFormula);//转换成 xml 格式        String xml2 = xstream.toXML(zcEbFormula.getScoreItemList());//转换成 xml 格式        System.out.println(xml2); //输出 xml 字符串       return xml;  }  private ZcEbFormula getZcEbFormulaFromDB(String projCode, String packCode) {    Map map = new HashMap();    map.put("PROJCODE", projCode);    map.put("PACKCODE", packCode);    ZcEbFormula formula = null;    try {      formula = this.getZcEbFormula(map);    } catch (BaseException e) {      UIUtilities.showStaickTraceDialog(e, this, "错误", "数据库连接错误!");      e.printStackTrace();      return new ZcEbFormula();    }    return formula;  }  private ZcEbFormula getZcEbFormulaFromXml(String path) {    XStream xstream = new XStream(new DomDriver());    ZcEbFormula formula = (ZcEbFormula) xstream.fromXML(readFormulaXml(path));    return formula;  }  public void downLoadFormulaXml(String projCode, String packCode, String srcPath) {    this.formula = this.getZcEbFormulaFromDB(projCode, packCode);    String temp = filePath;    if (srcPath != null || !"".equals(srcPath)) {      temp = srcPath;    }    File formlaXmlFile = new File(temp);    BufferedWriter brWriter = null;    if (!formlaXmlFile.exists()) {      formlaXmlFile.getParentFile().mkdirs();    }    try {      brWriter = new BufferedWriter(new FileWriter(formlaXmlFile));      brWriter.write(createFormulaXml(formula));    } catch (IOException e) {      e.printStackTrace();    } finally {      try {        if (brWriter != null) {          brWriter.close();        }      } catch (IOException e) {        e.printStackTrace();      }    }  }  private String readFormulaXml(String path) {    String temp = filePath;    if (path != null && !"".equals(path)) {      temp = path;    }    File formlaXmlFile = new File(temp);    FileReader reader = null;    String formulaXml = null;    try {      reader = new FileReader(formlaXmlFile);      StringBuffer buffer = new StringBuffer();      char[] c = new char[1024];      int len = reader.read(c);      while (len != -1) {        buffer.append(c, 0, len);        len = reader.read(c);      }      formulaXml = buffer.toString();      System.out.println("读取的XML文件:");      System.out.println(formulaXml);      return formulaXml;    } catch (IOException e) {      e.printStackTrace();    } finally {      try {        reader.close();      } catch (IOException e) {        e.printStackTrace();      }    }    return null;  }  /**  * @Description:  创建评标指标树修改面板。在招投标制作工具，右侧树，双击评标方法时左侧面板显示该Panel  * @return JTree 返回类型  * @since 1.0  */  private JPanel createFormulaTree(boolean isOffLine) {    if (isOffLine) {      ZcEbFormula formula = getZcEbFormulaFromXml(filePath);      FormulaShowPanel panel = new FormulaShowPanel(formula);      return panel;    } else {      ZcEbFormula formula = getZcEbFormulaFromDB(projCode, packCode);      //      FormulaSetMainPanel panel = new FormulaSetMainPanel(formula);      FormulaShowPanel panel = new FormulaShowPanel(formula);      return panel;    }  }  public ZcEbFormula getFormula() {    return formula;  }  public ZcEbFormula getZcEbFormula(Map map) {    if (zcEbFormula == null) {      Transfer transfer = new Transfer(map, "getZcEbFormula");      transfer.startTransfer();      Map returnMap = transfer.getReturnMap();      zcEbFormula = (ZcEbFormula) returnMap.get("zcEbFormula");    }    return zcEbFormula;  }  public static void main(String[] args) {    SwingUtilities.invokeLater(new Runnable() {      public void run() {        try {          UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());          UIManager.setLookAndFeel(new BlueLookAndFeel());        } catch (Exception e) {          e.printStackTrace();        }        CreateFormulaXmlTree bean = new CreateFormulaXmlTree("XCZX2010-106", "1821", false);        bean.downLoadFormulaXml("XCZX2010-106", "1821", bean.filePath);        //        CreateFormulaXmlTree bean2 = new CreateFormulaXmlTree("XCZX2010-106", "1821", true);        JFrame frame = new JFrame("frame");        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);        frame.setSize(UIConstants.DIALOG_2_LEVEL_WIDTH, UIConstants.DIALOG_2_LEVEL_HEIGHT);        frame.setLocationRelativeTo(null);        //        frame.getContentPane().add(bean2);        frame.setVisible(true);      }    });  }}