package com.ufgov.zc.client.zc.zcebxy;import java.util.ArrayList;import java.util.Date;import java.util.HashMap;import java.util.List;import java.util.Map;import com.ufgov.zc.client.common.ServiceFactory;import com.ufgov.zc.client.component.zc.dataexchange.DataExchangeListPanel;import com.ufgov.zc.client.component.zc.dataexchange.model.ABaseData;import com.ufgov.zc.client.component.zc.dataexchange.model.AttachmentFile;import com.ufgov.zc.common.system.RequestMeta;import com.ufgov.zc.common.system.dto.ElementConditionDto;import com.ufgov.zc.common.zc.model.DataExchangeLog;import com.ufgov.zc.common.zc.model.ZcPProMake;import com.ufgov.zc.common.zc.publish.IZcPProMakeServiceDelegate;/** * 电子竞价数据导入导出 * @author LEO * */public class ZcEbXieYiGonghuoDataExchangeExecutor extends ABaseData {  private static final long serialVersionUID = 1619825736456968019L;  public transient IZcPProMakeServiceDelegate zcPProMakeServiceDelegate = null;  @Override  public int doExportData(ElementConditionDto dto, RequestMeta meta, String saveRootPath) {    DataExchangeListPanel.setProgressText(this.getDataTypeName() + "正在查询需要导出的记录...");    if (this.getNeedExportDataRedoList() != null && this.getNeedExportDataRedoList().size() > 0) {      dto.setPmAdjustCodeList(this.getNeedExportDataIDList());      this.setDataList(this.getZcPProMakeServiceDelegate().findTransDataForXieyiGongHuo(dto, meta));    } else {      this.setDataList(new ArrayList<ZcPProMake>());    }    DataExchangeLog log = null;    int total = this.getDataList().size();    //先处理一下没有对应数据的部分    for (int i = 0; i < this.getDataList().size(); i++) {      ZcPProMake make = (ZcPProMake) this.getDataList().get(i);      if (make == null) {        ZcPProMake tmp = new ZcPProMake();        String id = this.getNeedExportDataIDList().get(i);        log = new DataExchangeLog();        tmp.setZcMakeName("");        tmp.setZcMakeCode(id);        this.makeDataExchangeLog(log, meta.getSvUserID(), "导出失败", "", "未在对应的表中找相应的记录", "OUT", tmp);        this.getExchangeDataLogModel().getExportDataList().add(log);        this.successRecordMap.put(id, getDataExchangeRedo(id));        total--;      }    }    doClearNullObject();    DataExchangeListPanel.setProgressText(this.getDataTypeName() + "查询到" + total + "条有效记录...");    if (total == 0) {      this.getDataList().clear();      return 0;    }    List<DataExchangeLog> exportDataList = new ArrayList<DataExchangeLog>();    for (int i = 0; i < this.getDataList().size(); i++) {      ZcPProMake make = (ZcPProMake) this.getDataList().get(i);      this.successRecordMap.put(make.getZcMakeCode(), getDataExchangeRedo(make.getZcMakeCode()));      log = new DataExchangeLog();      this.makeDataExchangeLog(log, meta.getSvUserID(), "导出成功", "", "", "OUT", make);      exportDataList.add(log);    }    this.getExchangeDataLogModel().setExportDataList(exportDataList);    return this.getDataList().size();  }  @Override  public int doImportData(ElementConditionDto dto, RequestMeta meta, String readRootPath) {    String info = null;    DataExchangeLog log = null;    List<DataExchangeLog> importDataList = new ArrayList<DataExchangeLog>();    int size = this.getDataList().size();    for (int i = 0; i < size; i++) {      DataExchangeListPanel.setProgressText(this.getDataTypeName() + "正在发送数据到服务器..." + (i + 1) + "/" + size);      ZcPProMake make = (ZcPProMake) this.getDataList().get(i);      info = this.getZcPProMakeServiceDelegate().importJingJiaTransData(make, meta);      DataExchangeListPanel.setProgressText(this.getDataTypeName() + info);      log = new DataExchangeLog();      this.makeDataExchangeLog(log, meta.getSvUserID(), "导入成功", "", info, "IN", make);      importDataList.add(log);    }    this.getExchangeDataLogModel().setImportDataList(importDataList);    return this.getDataList().size();  }  private void makeDataExchangeLog(DataExchangeLog log, String userID, String succFail, String exceptionMsg, String detail, String type,  ZcPProMake make) {    log.setDataTypeID(this.getDataTypeID());    log.setDataTypeName(this.getDataTypeName());    log.setUserID(userID);    log.setRecStatus(succFail);    log.setDetailInfo(detail);    log.setExceptText(exceptionMsg);    log.setGentType(type);    log.setOptDateTime(new Date());    log.setRecSrcID(make.getZcMakeCode());    log.setRecSrcName(make.getZcMakeName());    log.setRecSrcTab("ZC_P_PRO_MAKE");  }  @Override  public Map<String, Map<String, AttachmentFile>> getAttachmentDataMap() {    return new HashMap<String, Map<String, AttachmentFile>>();  }  public IZcPProMakeServiceDelegate getZcPProMakeServiceDelegate() {    if (zcPProMakeServiceDelegate == null) {      zcPProMakeServiceDelegate = (IZcPProMakeServiceDelegate) ServiceFactory.create(IZcPProMakeServiceDelegate.class, "zcPProMakeServiceDelegate");    }    return zcPProMakeServiceDelegate;  }  public void setZcPProMakeServiceDelegate(IZcPProMakeServiceDelegate zcPProMakeServiceDelegate) {    this.zcPProMakeServiceDelegate = zcPProMakeServiceDelegate;  }}