package com.ufgov.zc.client.zc.project.integration.zbbook;import com.ufgov.zc.client.zc.ztb.JobThreads;import com.ufgov.zc.client.zc.ztb.component.ProjectInfoPanel;import com.ufgov.zc.client.zc.ztb.component.SingleSeletionTree;import com.ufgov.zc.client.zc.ztb.dao.AsFileDao;import com.ufgov.zc.client.zc.ztb.util.GV;import com.ufgov.zc.common.zc.model.ZcZBFileTemplate;import javax.swing.*;import javax.swing.tree.DefaultTreeModel;import java.awt.*;import java.awt.event.ActionEvent;import java.awt.event.ActionListener;import java.io.File;import java.text.SimpleDateFormat;import java.util.Date;public class TemplateSavePanel extends JPanel {  private static final long serialVersionUID = -6487099716031196715L;  private SingleSeletionTree singleSeletionTree;  private JDialog parentDialog = null;  private JLabel tplBelongBidWay_jl;  private JLabel appType_jl;  private JLabel description_jl;  private JLabel tplNo_jl;  private JTextField tplBelongBidWay_jt;  private JComboBox appType_jt;  private JTextArea description_jt;  private JTextField tplNo_jt;  private JLabel lbTitle;  private JButton btnOK;  private JButton btnExit;  private AsFileDao asFileDao = null;  private String tplBelongBidWay_Text = null;  /**   * 模板另存为操作面板操作   */  public TemplateSavePanel(SingleSeletionTree singleSeletionTree, JDialog parentDialog) throws Exception {    this.singleSeletionTree = singleSeletionTree;    this.parentDialog = parentDialog;    this.asFileDao = AsFileDao.getInstance();    tplBelongBidWay_Text = ProjectInfoPanel.getBusinessProject().getPurType();    initPanel();  }  /**   * 创建模板另存为操作面板   */  public void initPanel() {    this.setLayout(new BorderLayout());    try {      JPanel p1 = new JPanel(new FlowLayout());      JPanel p2 = new JPanel(new GridLayout(3, 1));      JPanel p21 = new JPanel(new FlowLayout());      JPanel p22 = new JPanel(new FlowLayout());      JPanel p23 = new JPanel(new FlowLayout());      JPanel p24 = new JPanel(new FlowLayout());      JPanel p3 = new JPanel(new FlowLayout());      JPanel p4 = new JPanel(new FlowLayout());      JPanel p5 = new JPanel(new GridLayout(4, 1));      Font f = new Font("宋体", Font.BOLD, 13);      this.lbTitle = new JLabel("招标书模板上传到服务器，请输入模板保存信息");      this.lbTitle.setFont(f);      this.tplBelongBidWay_jl = new JLabel("招标方式：");      this.appType_jl = new JLabel("应用类型：");      this.description_jl = new JLabel("模板说明：");      this.tplNo_jl = new JLabel("模板名称：");      // 投标方式  设置当前项目的投标方式      this.tplBelongBidWay_jt = new JTextField(tplBelongBidWay_Text, 30);      this.tplBelongBidWay_jt.setEnabled(false);      this.appType_jt = new JComboBox(GV.getAppTypeList());      this.appType_jt.setMaximumRowCount(5);      this.appType_jt.setPreferredSize(new Dimension(188, 25));      this.appType_jt.setEditable(true);      this.description_jt = new JTextArea(3, 30);      this.description_jt.setLineWrap(true);      this.description_jt.setWrapStyleWord(true);      this.tplNo_jt = new JTextField(30);      this.btnOK = new JButton("上传到服务器");      this.btnExit = new JButton("取消");      this.btnOK.addActionListener(new ActionListener() {        @Override        public void actionPerformed(ActionEvent e) {          upLoadListener(e);        }      });      this.btnExit.addActionListener(new ActionListener() {        @Override        public void actionPerformed(ActionEvent e) {          parentDialog.setVisible(false);        }      });      p1.add(this.lbTitle);      p21.add(this.tplBelongBidWay_jl);      p21.add(this.tplBelongBidWay_jt);      p22.add(this.appType_jl);      p22.add(this.appType_jt);      p23.add(this.description_jl);      p23.add(new JScrollPane(this.description_jt));      p24.add(this.tplNo_jl);      p24.add(this.tplNo_jt);      p3.add(this.btnOK);      p3.add(this.btnExit);      //一个jpanel  前三个      p2.add(p24);      p2.add(p21);      p2.add(p22);      //一个jpanel textarea      p4.add(p23);      p5.add(p2);      p5.add(p4);      JPanel tmp = new JPanel();      tmp.add(new JLabel("说明：模板名称会自动添加[_yyyyMMdd]后缀."));      tmp.setLayout(new FlowLayout());      p5.add(tmp);      p5.add(p3);      this.add(p1, BorderLayout.NORTH);      this.add(p5, BorderLayout.CENTER);    } catch (Exception e1) {      GV.showMessageDialog(this.singleSeletionTree, e1.getMessage());      e1.printStackTrace();    }  }  public void upLoadListener(ActionEvent e) {    SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd");    String dateStr = "_" + sdf.format(new Date());    String tplNo_Text = "";    if (!tplNo_jt.getText().endsWith(dateStr)) {      tplNo_Text = tplNo_jt.getText() + dateStr;    }    String appType_Text = (String) appType_jt.getSelectedItem();    String tplBelongBidWay_Text = (String) tplBelongBidWay_jt.getText();    String description_Text = description_jt.getText();    //模板名称 模板类型，招标方式不为空    if (tplNo_Text == null || "".equals(tplNo_Text.trim())) {      GV.showMessageDialog(null, "‘模板名称’不能为空，请修改后再操作！");      return;    } else {      //判断输入的模板名称不能为特殊字符！!@#$%^&*()+=|}""'':{,.<>?\/      String illegalStr = GV.CREATE_ERROR_CHARS;      char[] tplNo_Texts = tplNo_Text.toCharArray();      if (tplNo_Text.length() > 30) {        GV.showMessageDialog(null, "‘模板名称’长度不能超过30个字符。");        return;      }      for (char chr : tplNo_Texts) {        String string2 = String.valueOf(chr);        if (illegalStr.contains(string2)) {          GV.showMessageDialog(null, "‘模板名称’中不能包含非法字符：\n" + illegalStr);          return;        }      }    }    if (appType_Text == null || "".equals(appType_Text.trim())) {      GV.showMessageDialog(null, "‘应用类型’不能为空，请修改后再操作！");      return;    }    if (tplBelongBidWay_Text == null || "".equals(tplBelongBidWay_Text.trim())) {      GV.showMessageDialog(null, "‘招标方式’不能为空，请修改后再操作！");      return;    }    //判断模板是否存在 判断模板名称是否存在，如果存在告知模板名称存在    boolean isExistTemplateNo = false;    try {      isExistTemplateNo = asFileDao.isExistTemplateNo(tplNo_Text);    } catch (Exception e1) {      e1.printStackTrace();    }    if (isExistTemplateNo) {      GV.showMessageDialog(null, "招标书模板名称【" + tplNo_Text + "】重复，请修改后再另存为模板！");      return;    }    parentDialog.setVisible(false);    ZcZBFileTemplate template = new ZcZBFileTemplate();    template.setTplNo(tplNo_Text);    template.setTplAppType(appType_Text);    template.setTplBelongBidWay(tplBelongBidWay_Text);    template.setDescription(description_Text);    template.setLatestUsed(new Date());    template.setTplFullPath(File.separator + tplBelongBidWay_Text + "_TPL" + File.separator + appType_Text + GV.TEMPLATE_APPTYPE);    //  liuyunbin　流程是先将xml打包成tpl文件    DefaultTreeModel defaultTreeModel = (DefaultTreeModel) singleSeletionTree.getTree().getModel();    defaultTreeModel.reload();    singleSeletionTree.getTree().repaint();    singleSeletionTree.getTree().setSelectionPath(singleSeletionTree.getCurrentPath());    new JobThreads().startUploadTemplateThread(singleSeletionTree, template);  }}