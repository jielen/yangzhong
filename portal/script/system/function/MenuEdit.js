ufgov.portal.system.MenuEdit=function(){};Ext.extend(ufgov.portal.system.MenuEdit,ufgov.portal.Base,{getUserGroup:function(){var a=new Ext.Panel({layout:"fit",border:false,applyTo:"menuGroup",items:{layout:"table",defaults:{bodyStyle:"padding:10px"},layoutConfig:{columns:2},border:false,items:[{width:120,border:false,html:"&nbsp;&nbsp;&nbsp;&nbsp;请选择用户组："},{width:200,border:false,html:'<input type="text" id="userMenuGroup" size="20"/>'}]}});var b=new Ext.form.ComboBox({store:new Ext.data.JsonStore({autoLoad:true,url:"getJsonData.action",baseParams:{ruleID:"portal-common.getGroup"},fields:[{name:"groupId",mapping:"groupid"},{name:"groupName",mapping:"groupname"}]}),displayField:"groupName",valueField:"groupId",hiddenName:"groupId",typeAhead:true,mode:"local",forceSelection:true,triggerAction:"all",editable:false,allowBlank:false,emptyText:"选择用户组...",width:120,height:30,selectOnFocus:true,applyTo:"userMenuGroup"});b.on({select:{fn:function(e,c,d){groupId=c.data.groupId;groupName=c.data.groupName;MenuEdit.createMenuWindow(groupName);Ext.getCmp("menuRegion").setTitle(groupName+"菜单")},scope:this}});return a},createMenuWindow:function(a){Ext.Ajax.request({url:"getJsonData.action",params:{groupId:groupId,ruleID:"portal-common.getMenuGroupPage"},success:function(b){var d=Ext.util.JSON.decode(b.responseText);if(this.panel!=null){for(var e=this.panel.items.length;e>0;e--){this.panel.remove(this.panel.items.items[e-1])}}if(d.length>0){var f=new Array();for(var c=0;c<d.length;c++){f[c]=MenuEdit.createMenuTree(d[c].page_id,d[c].page_title)}this.panel=new Ext.Panel({layout:"fit",id:"treePanel",applyTo:"menuTree",autoScroll:true,layout:"accordion",layoutConfig:{animate:true},items:f}).show()}else{MenuEdit.showMsg("温馨提示",a+"没有菜单，请修改栏目设定")}}})},createMenuTree:function(a,c){var b=new Ext.tree.TreePanel({id:a+"_Panel",title:c,xtype:"treepanel",iconCls:"nav",border:false,autoScroll:true,split:true,singleExpand:true,useArrows:true,loader:new Ext.tree.TreeLoader({dataUrl:"getMenuTree.action?isInMenu=all"}),rootVisible:true,root:new Ext.tree.AsyncTreeNode({id:a,text:"根结点"}),listeners:{click:function(e){var d=Ext.get("menuConf").getUpdater();d.update({url:"html/system/function/menuEditConf.jsp",scripts:true,method:"POST",params:{id:e.attributes.id},text:"数据装载中，请稍候...",scope:this,nocache:true})},contextmenu:function(e,d){d.preventDefault();var f=new Ext.menu.Menu({id:"rightClickCont",ignoreParentClicks:false,items:[{id:"addNewNode",text:"添加分类结点",iconCls:"add",handler:function(){if(groupId=="sa"||groupId=="admin"){MenuEdit.showMsg("提示信息",groupName+"不能编辑")}else{MenuEdit.addNewNode(e)}}},"-",{id:"editPage",text:"更改结点名称",iconCls:"settings",handler:function(){if(groupId=="sa"||groupId=="admin"){MenuEdit.showMsg("提示信息",groupName+"不能编辑")}else{if(e.attributes.text=="根结点"){MenuEdit.showMsg("提示信息","根结点不可以修改名称")}else{MenuEdit.changeNodeName(e)}}}},"-",{id:"deletePage",text:"删除当前结点",iconCls:"delete",handler:function(){if(groupId=="sa"||groupId=="admin"){MenuEdit.showMsg("提示信息",groupName+"不能编辑")}else{if(e.attributes.text=="根结点"){MenuEdit.showMsg("提示信息","根结点不可以删除")}else{Ext.Msg.confirm("确认删除","删除结点将同时删除该结点下的所有子结点和挂接到该结点和子结点下的所有部件，确实要删除该结点吗？",function(g){if(g=="yes"){MenuEdit.deleteNode(e)}})}}}},"-",{id:"sortNode",text:"子结点重新排序",iconCls:"grid",handler:function(){if(groupId=="sa"||groupId=="admin"){MenuEdit.showMsg("提示信息",groupName+"不能编辑")}else{MenuEdit.sortNode(e)}}}]});if(!e.isLeaf()){f.showAt(d.getXY())}}}});return b},createMainFrame:function(){var a=new Ext.Panel({layout:"border",border:false,items:[{region:"north",height:40,border:false,html:'<div id="menuGroup" style="width:100%;height:60"></div>'},{region:"center",title:"操作区",layout:"fit",border:true,margins:"0 5 5 0",items:{id:"menuConf",border:false,html:'<span id="menuConf" style="width:100%"></span>'}},{region:"west",title:"菜单区",id:"menuRegion",border:true,split:true,layout:"fit",collapsible:true,margins:"0 0 5 5",minSize:150,maxSize:250,width:200,items:{id:"menuTree",border:false,html:'<span id="menuTree" style="width:100%"></span>'}}]});new Ext.Panel({layout:"fit",id:"menu",applyTo:"menu",border:false,items:a});Ext.getCmp("mainFrame").on("resize",function(){a.setWidth(0);a.setWidth(Ext.getCmp("menu").getInnerWidth());a.syncSize()});window.onresize=function(){a.setWidth(0);a.setWidth(Ext.get("menu").getInnerWidth())}},addNewNode:function(a){var b=new Ext.Window({title:"添加分类结点",width:400,height:150,layout:"fit",closable:false,defaults:{bodyStyle:"padding:5px"},border:true,items:new Ext.form.FormPanel({border:false,id:"newNode",layout:"form",items:[{xtype:"textfield",fieldLabel:"分类结点代码",name:"nodeCode",value:(new Date()).getTime(),width:200},{xtype:"textfield",fieldLabel:"分类结点名称",name:"nodeName",width:200},{xtype:"hidden",name:"parentId",value:a.attributes.id}],buttons:[{xtype:"button",text:"保存",width:150,handler:function(){var c=Ext.getCmp("newNode");if(c.getForm().isValid()){var d=Ext.get("nodeName").dom.value;if(d==""){alert("结点名称不能为空")}else{c.getForm().submit({url:"saveMenuInfo.action",params:{action:"newNode",nodeName:Ext.get("nodeName").dom.value,nodeCode:Ext.get("nodeCode").dom.value,parentId:Ext.get("parentId").dom.value},method:"post",waitMsg:"正在保存数据，请稍候...",success:function(e,f){MenuEdit.showMsg("提示信息",f.result.sign);b.close();a.reload()},failure:function(e,f){MenuEdit.showMsg("提示信息",f.result.sign);b.close()}})}}}},{xtype:"button",text:"取消",width:150,handler:function(){b.close()}}]})});b.show();b.center()},changeNodeName:function(a){var b=new Ext.Window({title:"更改当前结点名称",width:400,height:150,layout:"fit",closable:false,defaults:{bodyStyle:"padding:5px"},border:true,items:new Ext.form.FormPanel({border:false,id:"modifyNode",layout:"form",items:[{xtype:"textfield",fieldLabel:"当前结点名称",name:"nodeCode",value:a.attributes.text,width:200},{xtype:"textfield",fieldLabel:"修改后结点名称",name:"nodeName",width:200}],buttons:[{xtype:"button",text:"保存",width:150,handler:function(){var c=Ext.getCmp("modifyNode");if(c.getForm().isValid()){c.getForm().submit({url:"saveMenuInfo.action?action=modifyNode",params:{nodeCode:a.attributes.id,nodeName:Ext.get("nodeName").dom.value},waitMsg:"正在保存数据，请稍候...",success:function(d,e){MenuEdit.showMsg("提示信息",e.result.sign);a.setText(Ext.get("nodeName").dom.value);b.close()}})}}},{xtype:"button",text:"取消",width:150,handler:function(){b.close()}}]})});b.show();b.center()},deleteNode:function(a){Ext.Ajax.request({url:"saveMenuInfo.action?action=deleteNode&nodeCode="+a.attributes.id,success:function(c){var b=Ext.util.JSON.decode(c.responseText);alert(b.sign);a.parentNode.reload()},failure:function(c){var b=c.responseText;alert(b.sign)}})},sortNode:function(a){var b=new Ext.Window({title:"子结点重新排序",width:550,height:400,layout:"fit",id:"sortPanel",defaults:{bodyStyle:"padding:0px"},border:false,items:new Ext.grid.EditorGridPanel({store:new Ext.data.JsonStore({autoLoad:true,url:"getJsonData.action",baseParams:{ruleID:"portal-common.getSubMenu",menuId:a.attributes.id},fields:[{name:"menuid"},{name:"menuname"},{name:"menutype"},{name:"ordindex"}]}),columns:[{id:"id",header:"代码",align:"center",width:100,sortable:true,dataIndex:"menuid"},{id:"menuname",header:"名称",align:"center",width:200,sortable:true,dataIndex:"menuname"},{id:"menutype",header:"类别",align:"center",width:80,sortable:true,dataIndex:"menutype",renderer:function(c,d){return(c==="1")?"菜单":"部件"}},{id:"ordindex",header:"排序",align:"center",sortable:true,dataIndex:"ordindex",editor:new Ext.form.TextField({allowBlank:false})}],id:"sortGrid",viewConfig:{forceFit:true},frame:false,clicksToEdit:2,buttonAlign:"center",buttons:[{id:"saveSort",text:"保存",handler:function(){var c=Ext.getCmp("sortGrid").getStore().getModifiedRecords();if(c.length>0){var e="[";for(var f=0;f<c.length;f++){var d="{menuId: '"+c[f].data.menuid+"',";d+="parentId: '"+a.attributes.id+"',";d+="menuType: '"+c[f].data.menutype+"',";d+="ordIndex: '"+c[f].data.ordindex+"'}";e+=d+","}if(e.length>1){e=e.substring(0,e.length-1)}e+="]";Ext.Ajax.request({url:"saveMenuInfo.action",params:{action:"sortNode",jsonData:e},success:function(h){var g=Ext.util.JSON.decode(h.responseText);alert(g.sign);b.close();a.reload()}})}else{MenuEdit.showMsg("提示信息","页面没有修改信息，不用保存！")}}},{text:"关闭",handler:function(){b.close()}}]})});b.show();b.center()}});var MenuEdit=new ufgov.portal.system.MenuEdit();var groupId;var groupName;Ext.onReady(function(){Ext.QuickTips.init();MenuEdit.createMainFrame();MenuEdit.getUserGroup()});