ufgov.portal.system.ArticleAttach=function(){};Ext.extend(ufgov.portal.system.ArticleAttach,ufgov.portal.Base,{getAttachGrid:function(c){var h=this;var g=new Ext.grid.CheckboxSelectionModel();var f=new Ext.grid.ColumnModel([g,{id:"fileName",header:"附件",align:"center",sortable:true,dataIndex:"attachName",renderer:function(k,m,i,n,l,j){return"<a href='downloadFile.action?attachId="+i.get("attachId")+"'>"+k+"</a>"}}]);f.defaultSortable=true;var e=new Ext.data.JsonStore({autoLoad:true,url:"getJsonData.action",baseParams:{articleId:Ext.isEmpty(c)?"":c,ruleID:"portal-publish.getArticleAttachByParams"},fields:[{name:"attachId",mapping:"attach_id"},{name:"articleId",mapping:"article_id"},{name:"attachName",mapping:"attach_name"},{name:"attachContent",mapping:"attach_content"},{name:"operType"}]});var d=new Ext.Toolbar({items:[{text:"添加附件",iconCls:"new-tab",icon:"/style/img/gp5/ico/add_g.jpg",handler:function(){h.onAddFile(h)}},{iconCls:"new-tab",icon:"/style/img/gp5/ico/delete_style_g.jpg",text:"删除附件",handler:b}]});var a=new Ext.grid.EditorGridPanel({store:e,cm:f,sm:g,id:"editFileGrid",autoExpandColumn:"fileName",height:120,frame:false,clicksToEdit:1,bbar:d});function b(){var i=a.getSelectionModel().getSelections();if(Ext.isEmpty(i)||i.length===0){alert("请选择要删除的记录");return}Ext.Msg.confirm("系統提示","确认删除吗?(注意,该删除不可恢复！)",function(l){if(l!="yes"){return}var k="";c=i[0].data.articleId;for(var j=0;j<i.length;j++){if(!Ext.isEmpty(k)){k+=","}k+=i[j].data.attachId}Ext.Ajax.request({url:"doBasicOper.action",params:{articleId:c,deleteString:k,ruleID:"portal-publish.deleteArticleAttach",action:"delete"},success:function(o){var m=Ext.util.JSON.decode(o.responseText);alert(m.sign);for(var p=0;p<i.length;p++){var n=i[p];a.getStore().remove(n)}a.getSelectionModel().selectAll()}})})}return a},addNewFileToGrid:function(d,g,c){var e={attachId:c,attachName:g,attachContent:"",operType:"add"};var a=new Ext.data.Record.create([{name:"attachId",mapping:"attach_id"},{name:"attachName",mapping:"attach_name"},{name:"attachContent",mapping:"attach_content"},{name:"operType"}]);var b=new a(e);var f=0;d.getStore().insert(f,b);b.dirty=true;b.modified=e;if(d.getStore().modified.indexOf(b)==-1){d.getStore().modified.push(b)}},onAddFile:function(b){var a=new Ext.Window({height:120,width:450,id:"fileWindow",layout:"fit",closable:true,hideBorders:true,defaults:{bodyStyle:"padding:10px "},title:"添加附件",items:new Ext.form.FormPanel({id:"fileForm",border:false,layout:"table",fileUpload:true,layoutConfig:{columns:2},items:[{border:false,width:90,html:'&nbsp;&nbsp;&nbsp;&nbsp;<font size="2">文件名：</font>'},{layout:"form",border:false,items:[{xtype:"fileuploadfield",hideLabel:true,labelStyle:"text-align:right;",name:"file",id:"file",width:320,buttonText:"浏览...",listeners:{fileselected:function(d,c){var e="";if(Ext.isWindows){e=c.substring(c.lastIndexOf("\\")+1,c.length)}else{e=c.substring(c.lastIndexOf("/")+1,c.length)}Ext.getCmp("fileName").setValue(e)}}},{xtype:"hidden",name:"fileName",id:"fileName"}]}],buttonAlign:"center",buttons:[{text:"确定",handler:function(){var d=Ext.getCmp("fileName").getValue();if(Ext.isEmpty(d)){alert("请选择文件！");return}var c=Ext.getCmp("fileForm");c.getForm().submit({url:"uploadArticleAttach.action",waitMsg:"正在上传文件，请稍候...",success:function(h,f){if(f.result.success){var g=Ext.getCmp("editFileGrid");var i=Ext.getCmp("fileName").getValue();var e=f.result.id;a.close();b.addNewFileToGrid(g,i,e)}}})}}]})});a.show();a.center()}});var ArticleAttach=new ufgov.portal.system.ArticleAttach();var fckInstance=null;var fckObj=null;Ext.onReady(function(){Ext.QuickTips.init();var q=new ufgov.portal.Base();var y=new Ext.TabPanel({autoDestroy:true,renderTo:"articleSearch",collapsible:true,activeTab:0,resizable:true,autoWidth:true,items:[{contentEl:"divArticleFast",title:"搜索",id:"tabSrFast"},{contentEl:"divArticleAdv",title:"高级搜索",id:"tabSrAdv"}]});y.remove("tabSrAdv");var r=new Ext.form.FormPanel({autoDestroy:true,id:"frmSrFast",renderTo:"divArticleFast",title:"",hideLabels:false,buttonAlign:"center",labelAlign:"right",labelWidth:70,border:false,frame:false,items:[{layout:"column",bodyStyle:"padding:3px 3px 3px 3px;border:1px solid;border-width:0 0 1 0",items:[{columnWidth:0.5,layout:"form",border:false},{columnWidth:0.5,layout:"form",border:false}]}],buttons:[{text:"搜索",handler:p},{text:"重置",handler:B}]});var H=new Ext.form.TextField({fieldLabel:"文章文号",name:"sno",width:150});var G=new Ext.form.TextField({fieldLabel:"文章标题",name:"title",width:150});var E=new Ext.form.TextField({fieldLabel:"文章作者",name:"author",width:150});var C=new Ext.form.DateField({fieldLabel:"创作日期",name:"wroteTime",format:"Y-m-d",width:150});r.items.get(0).items.get(0).items.add(H);r.items.get(0).items.get(1).items.add(G);r.items.get(0).items.get(0).items.add(E);r.items.get(0).items.get(1).items.add(C);r.doLayout();function B(){for(nn=0;nn<r.items.get(0).items.length;nn++){for(jj=0;jj<r.items.get(0).items.get(nn).items.length;jj++){var S=r.items.get(0).items.get(nn).items.items[jj];S.setValue("")}}}var F=new Ext.form.FormPanel({autoDestroy:true,id:"fmSrAdv",renderTo:"divArticleAdv",title:"",hideLabels:false,height:80,buttonAlign:"center",labelAlign:"right",labelWidth:40,frame:false,hideLabels:true,bodyStyle:"padding:5 5 5 5;",items:[{xtype:"radio",boxLabel:"新增 ",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",checked:true,anchor:"45%"},{xtype:"radio",boxLabel:"高级搜索1",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",anchor:"45%"},{xtype:"radio",boxLabel:"高级搜索6",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",anchor:"45%"}],buttons:[{text:"搜索",handler:O,id:"execSrAdv"},{text:"设计",handler:s,id:"createSrAdv"}]});var k=[{name:"valId"},{name:"val"}];var v=q.getDs(k,"asService.getListByValsetId_AsVal","valsetId",new ufgov.portal.common.Param("VS_AP_ARTICLE_TYPE","","valsetId"));var i=new Ext.grid.CheckboxSelectionModel();var l=new Ext.grid.ColumnModel([i,{header:"文章标题",dataIndex:"title",id:"title"},{header:"文章文号",width:90,dataIndex:"sno"},{header:"作者",width:50,dataIndex:"author"},{header:"创作日期",renderer:Ext.util.Format.dateRenderer("Y-m-d"),width:80,dataIndex:"wroteTime"},{header:"类型",dataIndex:"type",width:60,renderer:function(S){var T=v.find("valId",S,0,false,false);return(T<0)?"":v.getAt(T).data.val}},{header:"失效日期",renderer:Ext.util.Format.dateRenderer("Y-m-d"),width:80,dataIndex:"expireDate"},{header:"创建人",width:50,dataIndex:"creatorName"},{header:"创建时间",renderer:Ext.util.Format.dateRenderer("Y-m-d H:i"),width:100,dataIndex:"createTime"},{header:"修改人",width:50,dataIndex:"mendorName"},{header:"修改时间",renderer:Ext.util.Format.dateRenderer("Y-m-d H:i"),width:100,dataIndex:"mendTime"}]);l.defaultSortable=true;var b=[{name:"id"},{name:"sno"},{name:"title"},{name:"author"},{name:"wroteTime",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"type"},{name:"attatchBlobid"},{name:"attatch"},{name:"content"},{name:"expireDate",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"mendorName"},{name:"mendTime",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"creatorName"},{name:"createTime",type:"date",dateFormat:"Y-m-d H:i:s"}];var c=q.getInitDs(b,"apService.getListPage_ApArticle","conditions,start,limit,sort,dir,userId");c.on("beforeload",function(){q.showSaveProgressBar("正在装载/刷新数据...")});Ext.Ajax.on("requestcomplete",function(U,S,T){q.hideSaveProgressBar()});var e=10;var L=new Ext.PagingToolbar({pageSize:e,store:c,displayInfo:true,displayMsg:"显示第 {0} 条到 {1} 条数据，共 {2} 条",emptyMsg:"没有数据",items:["-",{tooltip:"新增",text:"新增",iconCls:"new-tab",icon:"/style/img/gp5/ico/add_g.jpg",handler:function(){d(null)}},{tooltip:"编辑",text:"编辑",iconCls:"new-tab",icon:"/style/img/gp5/ico/edit_g.jpg",handler:function(){var T=grid.getSelectionModel();var S=T.getSelected();if(S==null){alert("没有选择数据！");return}w(S.data.id)}},{tooltip:"刪除",text:"刪除",iconCls:"new-tab",icon:"/style/img/gp5/ico/delete_style_g.jpg",handler:M},"-",{tooltip:"发布选中的文章",text:"发布",iconCls:"new-tab",icon:"/style/img/gp5/ico/show_instance_trace_g.jpg",handler:function(){z(null,true)}},{tooltip:"取消发布选中的文章",text:"取消发布",iconCls:"new-tab",icon:"/style/img/gp5/ico/untread_g.jpg",handler:function(){z(null,false)}}]});function f(U,W,X){var T=document.getElementById("mainFrame");var S=620;var Y=700;S=T.document?T.scrollHeight-10:S;if(X&&T){Y=T.document?T.scrollWidth:Y;y.el.setWidth(Y-10)}var V=0;if("tabSrFast"==y.getActiveTab().id){V=r.el.getSize().height;U.width=r.el.getSize().width}else{V=F.el.getSize().height;U.width=F.el.getSize().width}if(W){U.setWidth(y.el.getSize().width);U.setHeight(S-V-50);U.syncSize()}else{U.width=y.el.getSize().width;U.height=S-V-50;U.render()}}grid=new Ext.grid.EditorGridPanel({el:"articleContent",ds:c,cm:l,sm:i,autoExpandMin:320,autoExpandColumn:"title",resizable:true,bbar:L});f(grid,false,false);window.onresize=function(){f(grid,true,false)};y.on("tabchange",function(T,S){f(grid,true,false)});y.on("collapse",function(S){f(grid,true,false)});y.on("expand",function(S){f(grid,true,false)});if(!Ext.isEmpty(Ext.getCmp("mainFrame"))){Ext.getCmp("mainFrame").on("resize",function(){f(grid,true,true)})}function p(){c.baseParams.limit=e;var T={};for(nn=0;nn<r.items.get(0).items.length;nn++){for(jj=0;jj<r.items.get(0).items.get(nn).items.length;jj++){var S=r.items.get(0).items.get(nn).items.items[jj];if(""!=S.getValue()){T[S.name]=S.getValue()}}}c.baseParams.conditions=Ext.util.JSON.encode(T);c.baseParams.userId=Ext.isEmpty(document.getElementById("svUserId"))?"":document.getElementById("svUserId").getAttribute("value");var U=new Object();U.start=0;U.sort="mendTime";U.dir="desc";c.load({params:U})}function O(){alert("onSearchAdv")}function s(){showWin("高级搜索",context_g+"/jsp/platform/searchPage.jsp?componame=AS_PORTLET&pageType=listPage")}grid.on("rowdblclick",function(T){var S=T.getSelectionModel().getSelected();if(!S){return}w(S.get("id"))});var D=new Ext.form.TextField({fieldLabel:"文章文号",name:"snoE",maxlength:20,anchor:"97%"});var m=new Ext.form.TextField({fieldLabel:"文章标题",maxlength:25,name:"titleE",hasFocus:true,anchor:"97%"});var j=new Ext.form.TextField({fieldLabel:"文章作者",name:"authorE",maxlength:10,anchor:"97%"});var h=new Ext.form.ComboBox({fieldLabel:"文章类型",store:v,valueField:"valId",displayField:"val",hiddenName:"typeE",typeAhead:true,mode:"local",triggerAction:"all",emptyText:"请选择文章类型",editable:false,anchor:"97%"});var g=new Ext.form.DateField({fieldLabel:"创作日期",name:"wroteTimeE",format:"Y-m-d",anchor:"97%",readOnly:true,showToday:true});var a=new Ext.form.TextField({fieldLabel:"文章编号",name:"idE",inputType:"hidden"});var t=new Ext.form.DateField({fieldLabel:"失效日期",name:"expireDateE",format:"Y-m-d",anchor:"97%",readOnly:true,showToday:false});var u=new Ext.form.TextArea({fieldLabel:"文章内容",id:"contentE",width:400,anchor:"98%"});var Q=null;var x=new Ext.form.FormPanel({autoDestroy:false,id:"uploadForm",renderTo:"divArticleEditor",title:"",labelAlign:"right",hideLabels:false,buttonAlign:"center",labelWidth:70,bodyStyle:"padding:5 5 3 10 ",border:true,frame:false,fileUpload:true,items:[{layout:"column",border:false,items:[{columnWidth:0.5,layout:"form",border:false},{columnWidth:0.5,layout:"form",border:false}]},{layout:"form",border:false}],buttons:[{text:"发布",handler:function(){var S=a.getValue();if(Boolean(S)){z(S,true)}else{alert("保存后才可以发布！")}}},{text:"取消发布",handler:function(){var S=a.getValue();if(Boolean(S)){z(S,false)}else{alert("保存后才可以取消发布！")}}},{text:"保存",handler:I},{text:"新建",handler:R},{text:"关闭",handler:function(){Q.hide();Q=null}}]});window.FCKeditor_OnComplete=function(S){fckInstance=S};function o(){if(fckObj!=null){return true}try{fckObj=new FCKeditor(u.getId());fckObj.BasePath=fckBasePath;fckObj.Width="98%";fckObj.Height="350px";fckObj.ToolbarSet="Article";fckObj.LinkBrowser=true;fckObj.ImageBrowser=true;fckObj.FlashBrowser=true;fckObj.LinkUpload=true;fckObj.ImageUpload=true;fckObj.FlashUpload=true;fckObj.ReplaceTextarea();FCKeditorAPI.GetInstance(u.getId());return true}catch(S){fckObj=null;return false}}function R(){a.setValue(null);D.setValue(null);m.setValue(null);j.setValue(null);h.setValue(null);g.setValue(new Date());try{fckInstance.SetHTML("")}catch(S){}}x.items.get(0).items.get(0).items.add(h);x.items.get(0).items.get(0).items.add(m);x.items.get(0).items.get(0).items.add(D);x.items.get(0).items.get(0).items.add(j);x.items.get(0).items.get(0).items.add(g);x.items.get(0).items.get(0).items.add(t);var J=ArticleAttach.getAttachGrid();var P=new Ext.Panel({id:"attachPanel",width:400,anchor:"98%",border:false,layout:"fit",items:[J,a]});x.items.get(0).items.get(1).items.add(P);x.items.get(1).items.add(u);x.render();o();function w(S){q.showSaveProgressBar("正在查询,请稍候......");q.executeAjax(function(T){q.hideSaveProgressBar();if(T.id){d(T)}else{alert(T.msg)}},"apService.selectByPrimaryKey_ApArticle",new ufgov.portal.common.Param(S))}function d(V){if(Ext.isEmpty(fckInstance)){q.showMsg("温馨提示","正在加载相关组件，请稍候再试！");return}if(fckInstance.EditMode==FCK_EDITMODE_SOURCE){fckInstance.SwitchEditMode(FCK_EDITMODE_WYSIWYG)}if(V==null){R()}else{J.getStore().baseParams={articleId:V.id,ruleID:"portal-publish.getArticleAttachByParams"};J.getStore().reload();a.setValue(V==null?"":V.id);D.setValue(V==null?"":V.sno);m.setValue(V==null?"":V.title);j.setValue(V==null?"":V.author);h.setValue(V==null?null:V.type);var U=(V==null?"":V.wroteTime);var T=U.indexOf(" ");if(T>8){U=U.substring(0,T)}g.setValue(U);var S=(V==null?"":V.expireDate);T=S.indexOf(" ");if(T>8){S=S.substring(0,T)}t.setValue(S);u.setValue(V==null?null:V.content);try{fckInstance.SetHTML(V==null?null:V.content)}catch(W){}}Q=new Ext.Window({title:"文章编辑窗口",xtype:"window",layout:"fit",modal:"true",width:780,height:600,closeAction:"hide",items:[Ext.getCmp("uploadForm")]});Q.show()}function M(S,V){var U=grid.getSelectionModel();var T=U.getSelections();if(T.length==0){alert("请选择要删除的文章");return}Ext.Msg.confirm("系統提示","确认删除吗?(注意,该删除不可恢复！)",function(Y){if(Y!="yes"){return}var Z=[];for(var X=0;X<T.length;X++){var W=T[X];Z.push(W.get("id"))}q.showSaveProgressBar("正在删除中，请稍候...");q.executeAjax(function(ac){q.hideSaveProgressBar();alert(ac.message);if(ac.ret){for(var ab=0;ab<T.length;ab++){var aa=T[ab];c.remove(aa)}}},"apService.deleteApArticleByIds",new ufgov.portal.common.Param(Z,"0:java.lang.Long"))})}function I(){if(Ext.isEmpty(fckInstance)){q.showMsg("温馨提示","正在加载相关组件，请稍候再试！");return}if(!m.getValue()){alert("请输入文章标题");m.focus(false);return}if(!h.getValue()){alert("请输入文章类型");h.focus(false);return}u.setValue(fckInstance.GetHTML());var T=J.getStore().getModifiedRecords();var S="";for(var U=0;U<T.length;U++){if(!Ext.isEmpty(S)){S+=","}S+=T[U].data.attachId}q.showSaveProgressBar("保存过程中，请稍候...");x.getForm().submit({url:path+"/articleSaveIncFileUploadAction.action",params:{jsonString:S},success:function(V,W){q.hideSaveProgressBar();if(!W||!W.result){alert("保存失败,请查询服务器上的回滚日志！");return false}alert(W.result.msg);if(!W.result.id){return}if(!Ext.isEmpty(a.getValue())){c.reload()}a.setValue(W.result.id)},failure:function(){q.hideSaveProgressBar();alert("系统错误，操作失败, 请查询服务器上的回滚日志！")}})}var N=null;var n=null;var A=null;function z(Z,U){A=[];if(typeof Z=="string"||typeof Z=="number"){A.push(Z)}else{var W=grid.getSelectionModel().getSelections();for(var Y=0;Y<W.length;Y++){var T=W[Y];A.push(T.get("id"))}}if(A.length==0){alert(U?"请选择要发布的文章":"请选择要取消发布的文章");return}function X(aa,ac,ab){if(Boolean(ab.msg)){alert(ab.msg);return}ac.beginUpdate();for(ii=0;ii<ab.length;ii++){var ad=aa.createNode(ab[ii]);if(ad){if(ab[ii].pgPletIdFlag){ad.checkModel="multiple";ad.checkStyle="checkbox";ad.attributes.checked=ab[ii].portletCheck;ad.on("checkchange",function(){var ae=ad.parentNode;while(ae!=N.root){if(ae.checkStyle=="radio"){ae.getUI().toggleCheck(true)}ae=ae.parentNode}})}else{if(ac==N.root){ad.checkModel="multiple";ad.checkStyle="radio"}}ac.appendChild(ad)}}ac.endUpdate()}var V=A.length==1?A[0]:"";N=new Ext.tree.TreePanel({id:"portlet_treePanel",header:false,border:true,autoScroll:true,split:true,singleExpand:false,useArrows:true,height:500,hideCollapseTool:true,tools:[{id:"refresh",handler:function(ac,ab,aa){}}],loader:q.getCustomTreeLoader(X,"apService.getApPagePortletBeans","node,articleFileId,portletType,menuId,compoId,userId",new ufgov.portal.common.Param(V,"","articleFileId"),new ufgov.portal.common.Param("01","","portletType"),new ufgov.portal.common.Param("","","menuId"),new ufgov.portal.common.Param("","","compoId"),new ufgov.portal.common.Param(document.getElementById("svUserId").getAttribute("value"),"","userId")),rootVisible:false,root:new Ext.tree.AsyncTreeNode({id:"0",text:"全部"})});function S(ad,ae,aa){var ac=[];if((!ae||ad.isLeaf())&&ad.getUI().isChecked()&&ad.checkStyle!="radio"){ac.push(ad)}if(!ad.isLeaf()){for(var ab=0;ab<ad.childNodes.length;ab++){if(!aa||ad.childNodes[ab].checkStyle=="radio"&&ad.childNodes[ab].getUI().isChecked()){ac=ac.concat(S(ad.childNodes[ab],ae,false))}}}return ac}n=new Ext.Window({title:U?"请选择发布的目的频道(允许多选)":"请选择取消发布的目的频道(允许多选)",xtype:"window",layout:"fit",modal:"true",width:450,height:450,closeAction:"close",bodyStyle:"padding:7 5 5 5;",items:[N],buttons:[{text:"保存",handler:function(){var aa=[];for(var ab=0;ab<N.root.childNodes.length;ab++){if(N.root.childNodes[ab].attributes.checked){aa=aa.concat(N.root.childNodes[ab].attributes.id)}}var ac=S(N.root,true,true);if(ac.length==0){alert("至少选中一个栏目！");return}Ext.Msg.confirm("系统提示",U?"确认发布这些选择的文章到选中的频道吗?":"确认取消选中的频道里已发布的这些文章吗?",function(ad){if(ad!="yes"){return}K(A,aa,ac,U)})}},{text:"返回",handler:function(){n.hide()}}]});n.show()}function K(U,T,Y,S){var X=[];for(var V=0;V<Y.length;V++){var W=Y[V];X.push(W.attributes.parentId);X.push(W.attributes.id);X.push(W.attributes.portletId)}q.showSaveProgressBar(S?"正在发布中，请稍候...":"正在取消发布中，请稍候...");q.executeAjax(function(Z){q.hideSaveProgressBar();alert(Z.message)},"apService.updatePublishArticle",new ufgov.portal.common.Param(U,"0:java.lang.String"),new ufgov.portal.common.Param(T,"0:java.lang.String"),new ufgov.portal.common.Param(X,"0:java.lang.String"),S)}p()});