Ext.onReady(function(){if(Boolean(window.winEdit)){window.winEdit.destroy();window.winEdit=null}var a=null;var r=null;var g=new ufgov.portal.Base();var d=new Ext.TabPanel({renderTo:"maintainSearch",collapsible:true,activeTab:0,resizable:true,autoWidth:true,items:[{contentEl:"divMaintainFast",title:"搜索",id:"tabSrFast"},{contentEl:"divMaintainAdv",title:"高级搜索",id:"tabSrAdv"}]});d.remove("tabSrAdv");var s=new Ext.form.FormPanel({id:"frmSrFast",renderTo:"divMaintainFast",title:"",hideLabels:false,buttonAlign:"center",labelAlign:"right",labelWidth:90,border:false,frame:false,items:[{layout:"column",bodyStyle:"padding:3px 3px 3px 3px;border:1px solid;border-width:0 0 1 0",items:[{columnWidth:0.5,layout:"form",border:false},{columnWidth:0.5,layout:"form",border:false}]}],buttons:[{text:"搜索",handler:h},{text:"重置",handler:n}]});var c=new Ext.form.TextField({fieldLabel:"记录单号",width:180,name:"hqRecord"});var b=new Ext.form.TextField({fieldLabel:"bug状态",width:180,name:"status"});var C=new Ext.form.DateField({fieldLabel:"制单开始日期",width:180,format:"Y-m-d",name:"startRecordDate"});var A=new Ext.form.DateField({fieldLabel:"制单结束日期",width:180,format:"Y-m-d",name:"endRecordDate"});s.items.get(0).items.get(0).items.add(c);s.items.get(0).items.get(1).items.add(b);s.items.get(0).items.get(0).items.add(C);s.items.get(0).items.get(1).items.add(A);s.doLayout();function n(){for(nn=0;nn<s.items.get(0).items.length;nn++){for(jj=0;jj<s.items.get(0).items.get(nn).items.length;jj++){var D=s.items.get(0).items.get(nn).items.items[jj];D.setValue("")}}}var u=new Ext.form.FormPanel({id:"fmSrAdv",renderTo:"divMaintainAdv",title:"",hideLabels:false,height:80,buttonAlign:"center",labelAlign:"right",labelWidth:40,frame:false,hideLabels:true,bodyStyle:"padding:5 5 5 5;",items:[{xtype:"radio",boxLabel:"新增 ",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",checked:true,anchor:"45%"},{xtype:"radio",boxLabel:"高级搜索1",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",anchor:"45%"},{xtype:"radio",boxLabel:"高级搜索6",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",anchor:"45%"}],buttons:[{text:"搜索",handler:l,id:"execSrAdv"},{text:"设计",handler:j,id:"createSrAdv"}]});var e=[{name:"id"},{name:"hqRecord"},{name:"prodName"},{name:"modelName"},{name:"pointName"},{name:"recordDate"},{name:"remark"},{name:"status"},{name:"closed"},{name:"lineName"},{name:"line2Name"},{name:"databaseName"},{name:"verName"},{name:"errName"},{name:"errChildName"},{name:"errClassName"},{name:"writer"},{name:"writerCode"},{name:"modifier"},{name:"modifierCode"},{name:"rechecker"},{name:"recheckerCode"},{name:"buildtime"},{name:"prodCode"},{name:"modelCode"},{name:"pointCode"}];var q=g.getInitDs(e,"apService.getListPage_ApMaintain","conditions,start,limit,sort,dir");q.on("beforeload",function(){g.showSaveProgressBar("正在装载刷新数据...")});Ext.Ajax.on("requestcomplete",function(F,D,E){g.hideSaveProgressBar()});var y=new Ext.grid.CheckboxSelectionModel();var m=new Ext.grid.ColumnModel([y,{header:" 单号",dataIndex:"hqRecord",width:60,id:"hqRecord"},{header:"产品名称",dataIndex:"prodName"},{header:"模块名称",dataIndex:"modelName"},{header:"功能名称",dataIndex:"pointName"},{header:"问题简述",dataIndex:"remark",width:280},{header:"BUG状态",dataIndex:"status",width:60},{header:"制单日期",dataIndex:"recordDate",width:60},{header:"结单状态",dataIndex:"closed",width:60},{header:"产品线",dataIndex:"lineName"},{header:"业务线",dataIndex:"line2Name"},{header:"数据库",dataIndex:"databaseName"},{header:"版本号",dataIndex:"verName",width:60},{header:"一级错误",dataIndex:"errName"},{header:"二级错误",dataIndex:"errChildName"},{header:"严重程度",dataIndex:"errClassName"},{header:"制单人",dataIndex:"writer"},{header:"制单人代码",dataIndex:"writerCode"},{header:"维护人",dataIndex:"modifier"},{header:"维护人代码",dataIndex:"modifierCode"},{header:"复核人",dataIndex:"rechecker"},{header:"复核人代码",dataIndex:"recheckerCode"},{header:"编译时间",dataIndex:"buildtime"},{header:"产品代码",dataIndex:"prodCode"},{header:"模块代码",dataIndex:"modelCode"},{header:"功能代码",dataIndex:"pointCode"}]);m.defaultSortable=true;var f=null;function B(D){g.showSaveProgressBar("正在查询,请稍候......");g.executeAjax(function(E){g.hideSaveProgressBar();if(E.id){k(E)}else{alert(E.msg)}},"apService.selectByPrimaryKey_ApMaintain",new ufgov.portal.common.Param(D))}var x=10;var w=new Ext.PagingToolbar({pageSize:x,store:q,displayInfo:true,displayMsg:"显示第 {0} 条到 {1} 条数据，共 {2} 条",emptyMsg:"没有数据",items:["-",{tooltip:"刪除",iconCls:"new-tab",icon:"/style/img/gp5/ico/delete_style_g.jpg",handler:v},{tooltip:"新增",iconCls:"new-tab",icon:"/style/img/gp5/ico/add_g.jpg",handler:function(){k(null)}},{tooltip:"编辑",iconCls:"new-tab",icon:"/style/img/gp5/ico/edit_g.jpg",handler:function(){var E=f.getSelectionModel();var D=E.getSelected();if(D==null){alert("没有选择数据！");return}B(D.data.id)}}]});function o(F,H,I){var E=document.getElementById("mainFrame");var D=640;var J=700;if(E){D=E.contentDocument?E.offsetHeight:(E.document?E.scrollHeight-10:D)}if(I&&E){J=E.contentDocument?E.offsetWidth:(E.document?E.scrollWidth:J);d.el.setWidth(J-10)}var G=0;if("tabSrFast"==d.getActiveTab().id){G=s.el.getSize().height;F.width=s.el.getSize().width}else{G=u.el.getSize().height;F.width=u.el.getSize().width}if(H){F.setWidth(d.el.getSize().width);F.setHeight(D-G-50);F.syncSize()}else{F.width=d.el.getSize().width;F.height=D-G-50;F.render()}}f=new Ext.grid.GridPanel({el:"maintainContent",ds:q,cm:m,sm:y,resizable:true,autoScroll:true,bbar:w});o(f,false);window.onresize=function(){o(f,true)};d.on("tabchange",function(E,D){o(f,true)});d.on("collapse",function(D){o(f,true)});d.on("expand",function(D){o(f,true)});Ext.getCmp("mainFrame").on("resize",function(){o(f,true,true)});f.on("rowdblclick",function(E){var D=E.getSelectionModel().getSelected();if(!D){return}B(D.data.id)});function h(){q.baseParams.limit=x;var E=new Object();for(nn=0;nn<s.items.get(0).items.length;nn++){for(jj=0;jj<s.items.get(0).items.get(nn).items.length;jj++){var D=s.items.get(0).items.get(nn).items.items[jj];if(""!=D.getValue()){E[D.name]=D.getValue()}}}q.baseParams.conditions=Ext.util.JSON.encode(E);var F=new Object();F.start=0;q.load({params:F})}function l(){alert("onSearchAdv")}function j(){showWin("高级搜索",context_g+"/jsp/platform/searchPage.jsp?componame=AS_LINK&pageType=listPage")}function v(D,G){var F=f.getSelectionModel();var E=F.getSelections();if(E.length==0){alert("请选择要删除的行");return}Ext.Msg.confirm("系統提示","确认删除吗?(注意,该删除不可恢复！)",function(J){if(J!="yes"){return}var K=[];for(var I=0;I<E.length;I++){var H=E[I];K.push(H.get("id"))}g.showSaveProgressBar("正在删除中，请稍候...");g.executeAjax(function(N){g.hideSaveProgressBar();alert(N.message);if(N.ret){for(var M=0;M<E.length;M++){var L=E[M];q.remove(L)}}},"apService.deleteApMaintainByIds",new ufgov.portal.common.Param(K,"0:java.lang.Long"))})}function k(G){if(!window.winEdit){var E=[{name:"mainId",type:"int"},{name:"recordId",type:"int"},{name:"recDate",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"doDate",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"endDate",type:"date",dateFormat:"Y-m-d H:i:s"},{name:"recorderId",type:"string"},{name:"recorder",type:"string"},{name:"description",type:"string"},{name:"oper_type",type:"string"}];var I=Ext.data.Record.create(E);r=g.getInitDs(E,"apService.getListPageByMainId_ApMaintainRecord","mainId");var D=new Ext.grid.CheckboxSelectionModel();var H=new Ext.grid.ColumnModel([D,{header:"序号",width:60,dataIndex:"recordId"},{header:"接收日期",dataIndex:"recDate",width:80,renderer:Ext.util.Format.dateRenderer("Y-m-d"),editor:new Ext.grid.GridEditor(new Ext.form.DateField({allowBlank:false,format:"Y-m-d"})),id:"recDate"},{header:"处理日期",dataIndex:"doDate",renderer:Ext.util.Format.dateRenderer("Y-m-d"),width:80,editor:new Ext.grid.GridEditor(new Ext.form.DateField({allowBlank:false,format:"Y-m-d"})),id:"doDate"},{header:"备注",dataIndex:"description",editor:new Ext.grid.GridEditor(new Ext.form.TextField({allowBlank:true,maxLength:250})),id:"description"},{header:"记录人",dataIndex:"recorder",editor:new Ext.grid.GridEditor(new Ext.form.TextField({allowBlank:false,maxLength:25})),id:"recorder"}]);a=new Ext.grid.EditorGridPanel({autoScroll:true,title:"",sm:D,cm:H,ds:r,resizable:true,bodyStyle:"width:100%",autoWidth:true,height:170,autoExpandColumn:"description"});window.winEdit=new Ext.Window({labelAlign:"top",title:"在线维护单编辑",closeAction:"hide",modal:true,width:700,items:[{border:false,xtype:"form",id:"frmMaintainEdit",fileUpload:true,items:[{layout:"column",border:false,defaults:{bodyStyle:"padding:10 0 0 15"},items:[{columnWidth:0.5,labelWidth:60,layout:"form",border:false,items:[{xtype:"textfield",fieldLabel:"单号",id:"hqRecord_Edit",readOnly:true,style:"background:orange",value:Boolean(G)?G.hqRecord:"",anchor:"95%"},{xtype:"textfield",fieldLabel:"产品信息",id:"prodName_Edit",value:Boolean(G)?G.prodName:"",anchor:"95%"},{xtype:"textfield",fieldLabel:"产品线",id:"lineName_Edit",value:Boolean(G)?G.lineName:"",anchor:"95%"},{xtype:"textfield",fieldLabel:"数据库",id:"databaseName_Edit",value:Boolean(G)?G.databaseName:"",anchor:"95%"},{xtype:"textfield",fieldLabel:"模块信息",id:"modelName_Edit",value:Boolean(G)?G.modelName:"",anchor:"95%"},{xtype:"textfield",fieldLabel:"维护人员",id:"modifier_Edit",value:Boolean(G)?G.modifier:"",anchor:"95%"},{xtype:"textfield",fieldLabel:"一级错误",id:"errName_Edit",value:Boolean(G)?G.errName:"",anchor:"95%"}]},{columnWidth:0.5,labelWidth:60,layout:"form",border:false,items:[{xtype:"textfield",fieldLabel:"记录状态",id:"phone_Edit",value:Boolean(G)?G.prodName:"",anchor:"95%"},{xtype:"textfield",fieldLabel:"bug状态",id:"msgStatus2_Edit",value:Boolean(G)?G.msgStatus2:"",anchor:"95%"},{xtype:"textfield",fieldLabel:"业务线",id:"line2Name_Edit",value:Boolean(G)?G.line2Name:"",anchor:"95%"},{xtype:"textfield",fieldLabel:"版本号",id:"verName_Edit",value:Boolean(G)?G.verName:"",anchor:"95%"},{xtype:"textfield",fieldLabel:"功能信息",id:"pointName_Edit",value:Boolean(G)?G.pointName:"",anchor:"95%"},{xtype:"textfield",fieldLabel:"严重程度",id:"errClassName_Edit",value:Boolean(G)?G.errClassName:"",anchor:"95%"},{xtype:"textfield",fieldLabel:"二级错误",id:"errChildName_Edit",value:Boolean(G)?G.errChildName:"",anchor:"95%"}]}]},{layout:"form",bodyStyle:"padding:1 0 0 15",border:false,labelWidth:60,items:[{xtype:"textfield",fieldLabel:"问题标题",id:"remark_Edit",allowBlank:false,value:Boolean(G)?G.remark:"",anchor:"97.6%"},{xtype:"textarea",fieldLabel:"问题详述",id:"remarkDetail_Edit",value:Boolean(G)?G.remarkDetail:"",anchor:"97.6%"},{xtype:"fieldset",layout:"table",border:false,height:35,items:[{xtype:"label",text:"附件:",width:58,anchor:"95%"},{xtype:"fileuploadfield",buttonText:"添加...",id:"addiFile_Edit",width:150,value:"",anchor:"95%"},{xtype:"textfield",fieldLabel:"文件名",id:"addiFileName_Edit",hidden:true,anchor:"97.6%"},{xtype:"textfield",fieldLabel:"mainId",id:"id_Edit",value:Boolean(G)?G.id:"0",hidden:true,anchor:"97.6%"}]}]}]},{xtype:"tabpanel",plain:true,activeTab:0,id:"tabPanel1",tools:[{qtip:"增加新行",id:"plus",handler:function(O,N,L){var J={oper_type:"add",mainId:"0",recordId:"",recDate:"",doDate:"",endDate:"",description:"",recorderId:"",recorder:""};var K=new I(J);var M=r.getCount();a.stopEditing();r.insert(M,K);a.startEditing(M,2);K.dirty=true;K.modified=J;if(r.modified.indexOf(K)==-1){r.modified.push(K)}}},{qtip:"删除当前行",id:"minus",handler:function(L,K,J){v()}}],height:200,items:[{title:"缺陷处理过程",layout:"form",id:"tabPanel1-item0",defaults:{width:"100%"},items:[a]}]}],buttons:[{text:"保存",handler:function(){t()}},{text:"关闭",handler:function(){window.winEdit.hide()}}]})}else{for(p in G){var F=Ext.getCmp(p+"_Edit");if(!F){continue}if(F.setValue){F.setValue(G[p])}}}window.winEdit.show();r.load({params:{mainId:G?G.id:"0",start:0,limit:300000}})}function t(){if(Ext.get("remark_Edit").dom.value==""){alert("没有输入'问题标题'");Ext.get("remark_Edit").focus();return}var D=r.modified.slice(0);var G=[];var E=[];var K=[];var H=false;Ext.each(D,function(L){if(L.data.oper_type=="add"){if(L.data.recorder==""){alert("记录人不能为空");var M=a.colModel.getIndexById("recorder");if(a.colModel.isHidden(M)){a.colModel.setHidden(M,false)}a.startEditing(a.store.indexOf(L),M);H=true;return false}E.push(L.data)}else{if(L.data.oper_type=="del"){G.push(L.data)}else{if(L.data.recorder==""){alert("记录人不能为空");var M=a.colModel.getIndexById("recorder");if(a.colModel.isHidden(M)){a.colModel.setHidden(M,false)}a.startEditing(a.store.indexOf(L),M);H=true;return false}K.push(L.data)}}});if(H){return}var J=Ext.get("addiFile_Edit").dom.value;if(Boolean(J)){var F=J.lastIndexOf("\\");Ext.get("addiFileName_Edit").dom.value=encodeURIComponent(J.substring(F+1));Ext.get("addiFileName_Edit").dom.value=""}var I=Ext.getCmp("frmMaintainEdit").getForm();g.showSaveProgressBar("保存主表过程中，请稍候...");I.submit({url:path+"/onlineMaintainAction.action",success:function(L,M){g.hideSaveProgressBar();if(!M||!M.result){alert("保存失败！");return false}Ext.get("id_Edit").dom.value=M.result.id;Ext.get("hqRecord_Edit").dom.value=M.result.hqRecord;Ext.get("addiFile_Edit").dom.value="";z(M.result.id,G,E,K)},failure:function(){g.hideSaveProgressBar();alert("系统错误，操作失败！")}})}function z(D,F,E,G){if(E.length+G.length+F.length==0){alert("保存成功！");return}g.showSaveProgressBar("保存子表过程中，请稍候...");g.executeAjax(function(K){g.hideSaveProgressBar();alert(K.message);if(K.ret){var J=(K.insertIds).split(",");var H=0;for(i=0,cnt=r.getCount();i<cnt;i+=1){var I=r.getAt(i);if(I.data.oper_type=="add"){I.data.recordId=J[H];H++}I.data.oper_type="";I.dirty=false}r.pruneModifiedRecords=true;r.modified=[];a.view.refresh()}},"apService.saveMaintainRecord",D[0],new ufgov.portal.common.Param(E,"0:com.ufgov.portal.tools.ap.domain.ApMaintainRecord"),new ufgov.portal.common.Param(F,"0:com.ufgov.portal.tools.ap.domain.ApMaintainRecord"),new ufgov.portal.common.Param(G,"0:com.ufgov.portal.tools.ap.domain.ApMaintainRecord"))}function v(){var E=a.getSelectionModel();var D=E.getSelections();if(D.length==0){alert("请选择要删除的数据");return}Ext.Msg.confirm("系統提示","确认删除吗?\n(注意,这个客户端删除的动作,数据没有正式提交！)",function(H){if(H!="yes"){return}a.stopEditing();for(var G=0;G<D.length;G++){var F=D[G];F.data.oper_type="del";if(r.modified.indexOf(F)==-1){r.modified.push(F)}r.remove(F)}})}h()});