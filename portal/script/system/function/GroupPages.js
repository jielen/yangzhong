var portalJson,portalArray;var groupId,pageId,pageOrient,groupName;var portletInfo;var currentPageArray;var token,userId,userName;var logoHtml="";var logoWidth=null;var logoHeight=null;$import("script/common/File.js");$import("script/common/PublicFunction.js");$import("html/portlet/PageTemp.js");$import("html/home_in/FuncLink.js");$import("html/portlet/myProfile/UserProfileEdit.js");$import("html/portlet/workFlow/WorkApp.js");$import("html/portlet/download/Download.js");$import("html/portlet/msgBoard/MsgBoardEdit.js");$import("html/portlet/msgBoard/MsgBoardView.js");$import("html/portlet/expressApp/ExpressApp.js");$import("html/portlet/link/Link.js");$import("html/portlet/login/LoginPortlet.js");$import("html/portlet/calendar/CalendarApp.js");$import("html/portlet/calendar/DailyPlanDetail.js");$import("html/portlet/search/Search.js");$import("html/portlet/article/ArticleApp.js");$import("html/portlet/article/ArticleSearch.js");$import("html/portlet/workFlow/OAFileWorkApp.js");$import("html/portlet/fileBox/FileBoxPortlet.js");$import("html/portlet/monitorItem/MonitorItemPortlet.js");$import("html/portlet/fileRead/FileReadPortlet.js");$import("html/portlet/menu/MenuPortlet.js");$import("html/portlet/other/BlankPortlet.js");ufgov.portal.MainPageIn=function(){return{pageInit:function(){this.createMainFrame();this.getBottomPanel();this.getMenuPanel();this.setStatusScroll()},createLogoPanel:function(){var logoUrl=portalArray[0].logo_url;logoUrl="html/themes/"+portalArray[0].theme_code+"/"+logoUrl;var logo;var width,height;if(logoUrl){if(logoUrl.indexOf("|")>0){var logoUrlArray=logoUrl.split("|");logo=logoUrlArray[0];if(logoUrlArray[1]){width=logoUrlArray[1]}else{width=portalWidth}if(logoUrlArray[2]){height=logoUrlArray[2]}else{height=100}}else{logo=logoUrl;height=100}}else{logo="resources/top.jpg";height=100}var params=new Array();params[0]=logo;params[1]=height;params[2]=width;this.logoParam=params;var top;logo=path+"/"+logo;if(logo&&logo.substring(logo.lastIndexOf(".")+1)=="swf"){top="<embed src='"+logo+"'";top+=" width='"+width+"' height='"+height+"' quality='high' pluginspage='http://www.macromedia.com/go/getflashplayer' ";top+="type='application/x-shockwave-flash' wmode='transparent'></embed>"}else{if(!Ext.isEmpty(logo)){top='<img src="'+logo+'" width="100%" height="100">'}else{top='<img src="'+path+'/resources/top.jpg" width="100%" height="100">'}}logoPath=logo;logoWidth=width;logoHeight=height;this.logoPanel=new Ext.Panel({border:false,applyTo:"toplogo",items:{border:false,Height:height,html:top}})},createTopPanel:function(){var logoUrl=portalArray[0].logo_url;var height;if(logoUrl){if(logoUrl.indexOf("|")>0){var logoUrlArray=logoUrl.split("|");if(logoUrlArray[2]){height=logoUrlArray[2]}else{height=100}}else{height=100}}else{height=100}var topPanel=new Ext.Panel({region:"north",id:"top",margins:"0 0 0 0",border:false,height:parseInt(height),items:[{border:false,region:"north",id:"toplogo",html:'<div id="toplogo"></div>'}]});return topPanel},createCenterPanel:function(orient){if(this.center){for(var p=this.center.items.length;p>0;p--){this.center.remove(this.center.items.items[p-1])}}if(orient==="2"||orient==="3"){this.center=new Ext.Panel({layout:"border",applyTo:"center",border:false,items:{border:false,region:"center",id:"mainPanel",html:'<div id="mainPanel"></div>'}})}else{this.center=new Ext.Panel({layout:"border",applyTo:"center",border:false,items:[{border:false,region:"north",id:"menuPanel",html:'<div id="menuPanel"></div>'},{border:false,region:"center",id:"mainPanel",html:'<div id="mainPanel"></div>'}]})}return center},createBlankBox:function(region,portalWidth){var box=new Ext.BoxComponent({region:region,el:region,margins:"0 0 0 0",style:"background:#ffffff",width:(Ext.getBody().getWidth()-portalWidth)/2,id:region,html:""});return box},createMainFrame:function(){var portalWidth=portalArray[0].suf_width;if(portalWidth===""){portalWidth="100%"}if(portalWidth.indexOf("%")>0){portalWidth=portalWidth.substring(0,portalWidth.indexOf("%"))/100}if(portalWidth<=1){portalWidth=Ext.getBody().getWidth()*portalWidth}var west=this.createBlankBox("west",portalWidth);var east=this.createBlankBox("east",portalWidth);var top=this.createTopPanel();var mainFrame=new Ext.Panel({region:"center",contentEl:"center",border:false,layout:"border",margins:"0 0 0 0",items:[top,{region:"south",margins:"5 0 0 0",height:30,id:"bottom",html:'<div id="bottom"></div>'},{region:"center",id:"center",margins:"0 0 0 0",html:'<div id="center"></div>'}]});new Ext.Viewport({layout:"border",items:[west,east,mainFrame]});window.onresize=function(){west.setWidth(0);west.setWidth((Ext.getBody().getWidth()-portalWidth)/2);west.syncSize();east.setWidth(0);east.setWidth((Ext.getBody().getWidth()-portalWidth)/2);east.syncSize()}},getMenuPanel:function(){MainPageIn.createLogoPanel();MainPageIn.createCenterPanel("2");var Menu=new ufgov.portal.common.Menu();MainPageIn.createNewMainPanel(groupName);Menu.createCellPage(groupId,groupId,"menuTree","MainPageIn.execCellPageUrl","MainPageIn.nodeRightClickUrl")},createNewMainPanel:function(menuTitle){MainPageIn.destroyPanel(MainPageIn.newMainPanel);MainPageIn.destroyPanel(MainPageIn.jspPanel);MainPageIn.destroyPanel(MainPageIn.rowPageRowMenu);MainPageIn.destroyPanel(MainPageIn.pageContPanel);var panel=new Ext.Panel({layout:"border",border:false,items:[{region:"west",title:menuTitle,id:"menuRegion",border:true,split:true,layout:"fit",collapsible:true,margins:"0 0 5 0",minSize:200,maxSize:300,width:200,items:{id:"menuTree",border:false,html:'<span id="menuTree" style="width:100%"></span>'}},{region:"center",header:false,layout:"fit",border:true,margins:"0 0 5 0",items:{id:"mainFrame",header:false,border:false,html:'<div id="mainFrame" style="width:100%"></div>'}}]});MainPageIn.newMainPanel=new Ext.Panel({layout:"fit",id:"newMainPanel",applyTo:"mainPanel",header:false,border:false,items:panel})},execCellPageUrl:function(node){if(node.attributes.isMenu){if(node.isLeaf()){MainPageIn.execCellMenuUrl(node)}else{node.toggle()}}else{pageId=node.attributes.id;if(!currentPageArray){currentPageArray=Ext.util.JSON.decode('{"page_id":"","column_ratio":"","page_url":"","page_title":"","page_desc":"","page_order":"","menu_orient":"","parent_id":"","page_title_img":"","is_always_new":"","column_count":"","group_id":""}')}currentPageArray.page_id=node.attributes.id;currentPageArray.page_title=node.attributes.text;currentPageArray.page_url=node.attributes.url;currentPageArray.column_ratio=node.attributes.columnRatio;currentPageArray.column_count=node.attributes.columnCount;currentPageArray.is_always_new=node.attributes.isAlwaysNew;currentPageArray.menu_orient=node.attributes.menuOrient;if(node.attributes.menuOrient=="1"){MainPageIn.createRowMenuPanel()}else{MainPageIn.getPagePortletInfo("","mainFrame")}}},execListPageUrl:function(pageInfo,menuOrient){currentPageArray=pageInfo;pageId=currentPageArray.page_id;if(menuOrient&&menuOrient=="1"){MainPageIn.createRowMenuPanel()}else{MainPageIn.getPagePortletInfo("","mainFrame")}},createRowMenuPanel:function(){MainPageIn.destroyPanel(MainPageIn.jspPanel);MainPageIn.destroyPanel(MainPageIn.newMainFrame);MainPageIn.destroyPanel(MainPageIn.pageContPanel);MainPageIn.destroyPanel(MainPageIn.cellMenu);var panel=new Ext.Panel({layout:"border",border:false,items:[{region:"north",id:"rowMenuRegion",header:false,border:false,height:30,tbar:[{xtype:"tbsplit",iconCls:"add"}]},{region:"center",header:false,layout:"fit",border:false,margins:"0 0 0 0",items:{id:"newPanel",header:false,border:false,html:'<div id="newPanel" style="width:100%"></div>'}}]});MainPageIn.newMainFrame=new Ext.Panel({applyTo:"mainFrame",header:false,border:false,id:"newMainFrame",layout:"fit",items:panel});MainPageIn.getPagePortletInfo("","newPanel");Ext.Ajax.request({url:"getMenuListAction.action",params:{pageId:pageId,isRemoveEmpty:true,isOnlyInMenu:true},callback:function(option,success,response){if(success){var result=Ext.util.JSON.decode(response.responseText);var Menu=new ufgov.portal.common.Menu();var menuItem=Menu.getMenuItem(result,pageId,"MainPageIn.execCellPageRowMenu");var restMenuItem=new Array();if(menuItem.length>0){var level=0;for(var i=0;i<menuItem.length;i++){var tempWidth=Ext.getCmp("rowMenuRegion").tbar.getWidth();if(tempWidth>panel.getInnerWidth()){level=i-2;break}else{Ext.getCmp("rowMenuRegion").getTopToolbar().add(menuItem[i])}}if(level==0){level=menuItem.length-1}Ext.getCmp("rowMenuRegion").tbar.remove();var newMenu=new Ext.Panel({applyTo:"rowMenuRegion",border:false,id:"newRowMenu",tbar:[]});for(var m=0;m<menuItem.length;m++){if(m>level){restMenuItem[restMenuItem.length]=menuItem[m]}else{Ext.getCmp("newRowMenu").getTopToolbar().add(menuItem[m])}}if(restMenuItem.length>0){Ext.getCmp("newRowMenu").getTopToolbar().add("->",{xtype:"tbsplit",iconCls:"add",id:"moreTool",menu:restMenuItem})}}else{Ext.getCmp("rowMenuRegion").tbar.remove();Ext.getCmp("rowMenuRegion").destroy()}}}})},getBottomPanel:function(){var copyright=portalArray[0].copyright;var bottomTable='<table border="0" align="center" height="30" width="100%">';bottomTable+='<tr><td class="thbody" align="center">';bottomTable+=copyright;bottomTable+="</td></tr></table>";new Ext.Panel({layout:"fit",applyTo:"bottom",border:false,html:bottomTable})},createMainPanel:function(newMainPanel){var pageUrl=currentPageArray.page_url;var isAlwaysNew=currentPageArray.is_always_new;if(Ext.isEmpty(pageUrl)){var columnCount=currentPageArray.column_count;var columnRatio=currentPageArray.column_ratio;var columnWidth=new Array();if(columnCount>1){if(!Ext.isEmpty(columnRatio)){columnWidth=columnRatio.split(",")}else{columnWidth[columnWidth.length]=(100/columnCount)/100}}MainPageIn.showPortletColumn(columnCount,columnWidth,newMainPanel)}else{if(isAlwaysNew=="Y"){window.open(pageUrl,"new","menubar=no,scrollbars=yes,status=yes,toolbar=no,resizable=yes,titlebar=no,scrollbars=yes,location=no,height="+(screen.availHeight-30)+",width="+(screen.availWidth-10)+",top=0,left=0")}else{if(pageOrient=="1"){MainPageIn.destroyPanel(MainPageIn.jspPanel);MainPageIn.destroyPanel(MainPageIn.pageContPanel);MainPageIn.destroyPanel(MainPageIn.newMainPanel);MainPageIn.destroyPanel(MainPageIn.rowPageRowMenu)}else{MainPageIn.destroyPanel(MainPageIn.jspPanel);MainPageIn.destroyPanel(MainPageIn.newMainFrame);MainPageIn.destroyPanel(MainPageIn.pageContPanel);MainPageIn.destroyPanel(MainPageIn.cellMenu)}if(Ext.isEmpty(newMainPanel)){newMainPanel="mainPanel"}MainPageIn.jspPanel=new Ext.Panel({applyTo:newMainPanel,border:false,id:"jspPanel",items:{border:false,html:'<div id="newJspPanel"></div>'}});if(pageUrl.indexOf("/")==0||pageUrl.indexOf("http://")==0){pageUrl=PF.addParameterToUrl(pageUrl,"groupId",groupId);pageUrl=PF.addParameterToUrl(pageUrl,"logoPath",logoPath);pageUrl=PF.addParameterToUrl(pageUrl,"logoWidth",logoWidth);pageUrl=PF.addParameterToUrl(pageUrl,"logoHeight",logoHeight);MainPageIn.jspPanel=new Ext.Panel({applyTo:newMainPanel,border:false,id:"jspPanel",items:{border:false,height:400,html:'<iframe frameborder="0" src="'+pageUrl+'" id="newJspPanel" name="newJspPanel" scrolling="yes" style="width:100%;height:100%"></iframe>'}})}else{pageUrl="html/themes/"+portalArray[0].theme_code+"/"+pageUrl;MainPageIn.jspPanel=new Ext.Panel({applyTo:newMainPanel,border:false,id:"jspPanel",items:{border:false,html:'<div id="newJspPanel"></div>'}});var main=Ext.get("newJspPanel");main.load({url:pageUrl,scripts:true,text:"数据装载中，请稍候..."})}}}},showPortletColumn:function(columnCount,columnWidth,newMainPanel){var style="";if(columnCount>1){var pagePortletColumn="[";for(var i=0;i<columnCount;i++){if(newMainPanel=="mainPanel"||Ext.isEmpty(newMainPanel)){if(i==columnCount-1){style='style: "padding:10px 0px 10px 0px"'}else{style='style: "padding:10px 10px 10px 0px"'}}else{if(i==columnCount-1){style='style: "padding:10px 10px 10px 0px"'}else{style='style: "padding:10px 10px 10px 10px"'}}pagePortletColumn+="{";pagePortletColumn+="columnWidth:";if(columnWidth.length>1){pagePortletColumn+=columnWidth[i]}else{pagePortletColumn+=columnWidth[0]}pagePortletColumn+=",";pagePortletColumn+=style;pagePortletColumn+="}";pagePortletColumn+=","}if(pagePortletColumn.indexOf(",")>0){pagePortletColumn=pagePortletColumn.substring(0,pagePortletColumn.length-1)}pagePortletColumn+="]";pagePortletColumn=Ext.util.JSON.decode(pagePortletColumn)}else{if(newMainPanel=="mainPanel"||Ext.isEmpty(newMainPanel)){style='style: "padding:10px 0px 10px 0px"'}else{style='style: "padding:10px 10px 10px 10px"'}var pagePortletColumn="[";pagePortletColumn+="{";pagePortletColumn+=style;pagePortletColumn+="}";pagePortletColumn+="]";pagePortletColumn=Ext.util.JSON.decode(pagePortletColumn)}if(pageOrient=="1"){if(Ext.isEmpty(newMainPanel)){MainPageIn.destroyPanel(MainPageIn.pageContPanel);this.destroyPanel(MainPageIn.newMainPanel);this.destroyPanel(MainPageIn.jspPanel);MainPageIn.destroyPanel(MainPageIn.rowPageRowMenu);this.pageContPanel=null;newMainPanel="mainPanel"}}else{if(newMainPanel!="newPanel"){MainPageIn.destroyPanel(MainPageIn.pageContPanel);MainPageIn.destroyPanel(MainPageIn.jspPanel);MainPageIn.destroyPanel(MainPageIn.cellMenu);MainPageIn.destroyPanel(MainPageIn.newMainFrame)}else{MainPageIn.destroyPanel(MainPageIn.pageContPanel);MainPageIn.destroyPanel(MainPageIn.cellPageRowMenu)}}MainPageIn.pagePortletPanel=new ufgov.portal.Template({border:false,items:pagePortletColumn});MainPageIn.pageContPanel=new Ext.Panel({applyTo:newMainPanel,id:"pageContPanel",border:false,header:false,layout:"fit",items:MainPageIn.pagePortletPanel});this.showPortlet()},showPortlet:function(){var ppanel=MainPageIn.pagePortletPanel;var m=0;for(var i=0;i<portletInfo.length;i++){var portletId=portletInfo[i].portlet_id;var portletUrl=portletInfo[i].portlet_url.trim();var portletClassName=portletInfo[i].portlet_class.trim();var ext=String(portletUrl.match(/[^\.]+$/));var portlet;if(portletInfo[i].col_no>=ppanel.items.items.length){continue}var showTitle=true;if(portletId=="blank"){showTitle=false}var panelWidth=ppanel.items.itemAt(portletInfo[i].col_no).columnWidth*ppanel.getInnerWidth();if(ext&&ext.toLowerCase()=="js"){if(!Ext.isEmpty(portletClassName)){var item={};var title="";try{var portletObj;if((" "+portletClassName).indexOf(" new ")==0){portletObj=eval("("+portletClassName+")")}else{var portletClass=eval(portletClassName);portletObj=new portletClass()}portletInfo[i].theme=portalArray[0].theme_code;portletInfo[i].panelWidth=panelWidth;if(portletObj&&portletObj.passParam){portletObj.passParam(portletInfo[i])}if(!Ext.isEmpty(portletObj)){item=portletObj.panel?portletObj.panel:{}}if(item.title){item.setTitle(portletInfo[i].title);title=""}else{title=portletInfo[i].title}var conf={border:false,autoHeight:true,items:item};if(showTitle){conf.title=title}portlet=new ufgov.portal.Portlet(conf)}catch(e){portlet=new ufgov.portal.Portlet({border:true,autoHeight:true,title:portletInfo[i].title,html:"出现异常，可能是该频道对应的js文件没有定义类名，或者是没有正确导入js文件"})}}else{portlet=new ufgov.portal.Portlet({border:true,autoHeight:true,title:portletInfo[i].title,html:"没有定义该频道js文件对应的类名，请在数据库中添加"})}}else{portletUrl=PF.addParameterToUrl(portletUrl,"groupId",groupId);portletUrl=PF.addParameterToUrl(portletUrl,"logoPath",logoPath);portletUrl=PF.addParameterToUrl(portletUrl,"logoWidth",logoWidth);portletUrl=PF.addParameterToUrl(portletUrl,"logoHeight",logoHeight);var config={border:false,html:"<iframe src="+portletUrl+' frameborder="0" id="mainFrame" name="mainFrame" scrolling="auto" style="width:100%;height:100%"></iframe>'};if(showTitle){config.title=portletInfo[i].title}var recordSize=0;try{recordSize=parseInt(portletInfo[i].record_size)}catch(e){}if(recordSize>0){config.height=recordSize}else{config.autoHeight=true}portlet=new ufgov.portal.Portlet(config)}ppanel.items.itemAt(portletInfo[i].col_no).add(portlet);m++}ppanel.doLayout()},getPagePortletInfo:function(pageInfo,newMainPanel){if(!Ext.isEmpty(pageInfo)){currentPageArray=Ext.util.JSON.decode(pageInfo);pageId=currentPageArray.page_id}Ext.Ajax.request({url:"getJsonData.action",params:{ruleID:"portal-common.getPagePortlet",pageId:pageId},success:function(response){portletInfo=Ext.util.JSON.decode(response.responseText);MainPageIn.getReadyState("MainPageIn.createMainPanel",newMainPanel)},failure:function(response){var result=Ext.util.JSON.decode(response.responseText);var Base=new ufgov.portal.Base();Base.showMsg("温馨提示",result)}})},getReadyState:function(execFunc,newMainPanel){if(document.readyState!="undefined"){if(document.readyState=="complete"){eval(execFunc)(newMainPanel)}else{window.setTimeout(this.getReadyState(execFunc,newMainPanel),1)}}else{eval(execFunc)(newMainPanel)}},destroyPanel:function(panel){if(panel){if(panel.items){for(var p=panel.items.length;p>0;p--){panel.remove(panel.items.items[p-1])}}if(panel.tbar){panel.tbar.remove()}if(panel.tools.items){for(var i=panel.tools.items.length;i>0;i--){panel.tools.remove(panel.tools.items.items[i-1])}}if(panel.header){panel.header.remove()}}},setStatusScroll:function(){var statusText="";var svOrgCode=document.getElementById("svOrgCode").getAttribute("value");var svOrgName=document.getElementById("svOrgName").getAttribute("value");if(!Ext.isEmpty(svOrgCode)){statusText+="   内部机构:["+svOrgCode+"]"+svOrgName}var svAccountId=document.getElementById("svAccountId").getAttribute("value");var svAccountName=document.getElementById("svAccountName").getAttribute("value");if(!Ext.isEmpty(svAccountId)){statusText+="   账套:["+svAccountId+"]"+svAccountName}var svTransDate=document.getElementById("svTransDate").getAttribute("value");if(!Ext.isEmpty(svTransDate)){statusText+="   业务日期:"+svTransDate}var svFiscalPeriod=document.getElementById("svFiscalPeriod").getAttribute("value");if(!Ext.isEmpty(svFiscalPeriod)){statusText+="   会计期间:"+svFiscalPeriod}var svNd=document.getElementById("svNd").getAttribute("value");if(!Ext.isEmpty(svNd)){statusText+="   年度:"+svNd}var svRpType=document.getElementById("svRpType").getAttribute("value");var svRpTypeName=document.getElementById("svRpTypeName").getAttribute("value");if(!Ext.isEmpty(svRpType)){statusText+="   表套:["+svRpType+"]"+svRpTypeName}var svPoCode=document.getElementById("svPoCode").getAttribute("value");var svPoName=document.getElementById("svPoName").getAttribute("value");if(!Ext.isEmpty(svPoCode)){statusText+="   职位:["+svPoCode+"]"+svPoName}PF.statusScroll(statusText)}}};var MainPageIn=new ufgov.portal.MainPageIn();Ext.onReady(function(){Ext.Ajax.request({url:"getJsonData.action",params:{ruleID:"portal-common.getBasicConfig"},success:function(b){var a=Ext.util.JSON.decode(b.responseText);portalArray=a;if(document.title.length==0){document.title=portalArray[0].portal_name}$import("html/themes/"+portalArray[0].theme_code+"/css/portal.css");MainPageIn.pageInit()}})});