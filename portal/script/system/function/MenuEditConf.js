var treeName=null;var isNew=true;var currentNode=null;var serialNo=null;ufgov.portal.system.MenuEditConf=function(){};Ext.extend(ufgov.portal.system.MenuEditConf,ufgov.portal.Base,{getCurrentNodeInfo:function(){var a=Ext.getCmp("treePanel").items;for(var b=0;b<a.items.length;b++){currentNode=a.items[b].getNodeById(treeId);if(currentNode!=undefined){serialNo=b;break}}if(currentNode==undefined){alert("没有选中菜单，请重新选择菜单！")}else{if(currentNode.isLeaf()){isNew=false}treeName=currentNode.attributes.text}},showNodeInfo:function(){new Ext.Panel({layout:"fit",applyTo:"selectedNodeInfo",border:false,width:Ext.getBody().getWidth(),height:40,html:'<p><b>当前编辑的结点：<font color="#ff0000">'+treeName+"</font></b></p>"})},getProductItems:function(){new Ext.form.ComboBox({store:new Ext.data.JsonStore({autoLoad:true,url:"getJsonData.action",baseParams:{ruleID:"portal-common.getProductInfo"},fields:[{name:"productId",mapping:"productid"},{name:"productName",mapping:"productname"}]}),tpl:'<tpl for="."><div class="x-combo-list-item">{productId} {productName}</div></tpl>',displayField:"productName",valueField:"productId",hiddenName:"productId",typeAhead:true,mode:"local",forceSelection:true,triggerAction:"all",editable:false,allowBlank:false,emptyText:"选择产品类型...",width:150,height:30,selectOnFocus:true,applyTo:"productItems",listeners:{select:function(e,c,d){a.reset();b.baseParams={ruleID:"portal-common.getCompoInfo",productId:c.data.productId+"%"};b.reload()}}});var b=new Ext.data.JsonStore({autoLoad:true,url:"getJsonData.action",baseParams:{ruleID:"portal-common.getCompoInfo",productId:""},fields:[{name:"compoId",mapping:"compoid"},{name:"compoName",mapping:"componame"},{name:"compoUrl",mapping:"compourl"},{name:"isGotoEdit",mapping:"isgotoedit"},{name:"isInMenu",mapping:"isinmenu"},{name:"isAlwaysNew",mapping:"isalwaysnew"}]});var a=new Ext.form.ComboBox({store:b,name:"compoItems",tpl:'<tpl for="."><div class="x-combo-list-item">{compoId} {compoName}</div></tpl>',displayField:"compoName",valueField:"compoId",hiddenName:"compoId",typeAhead:true,mode:"local",forceSelection:true,triggerAction:"all",allowBlank:false,emptyText:"选择部件...",width:150,height:120,listWidth:250,listAlign:"tl-bl",minHeight:120,editable:false,selectOnFocus:true,applyTo:"compoItems"});a.on({select:{fn:function(e,c,d){var f=Ext.get("componame").dom;f.value=c.data.compoName;Ext.get("compoUrl").dom.value=c.data.compoUrl;Ext.getCmp("editIsAlwaysNew").setValue(c.data.isAlwaysNew);Ext.getCmp("editIsInMenu").setValue(c.data.isInMenu);Ext.getCmp("editIsGotoEdit").setValue(c.data.isGotoEdit)},scope:this}})},editMenu:function(){var a=this;new Ext.Panel({layout:"table",applyTo:"editMenuDiv",border:false,width:Ext.getBody().getWidth(),height:Ext.getBody().getHeight(),defaults:{bodyStyle:"padding:10px"},layoutConfig:{columns:1},items:[new Ext.form.FormPanel({title:"添加部件",id:"addCompoForm",border:false,collapsible:true,autoHeight:true,items:{layout:"table",collapsible:true,border:false,layoutConfig:{columns:2},defaults:{bodyStyle:"padding:5px"},width:Ext.getBody().getWidth(),items:[{border:false,layout:"form",items:{xtype:"textfield",fieldLabel:"请选择产品",name:"productItems",width:150}},{border:false,layout:"form",items:{xtype:"textfield",fieldLabel:"请选择部件",labelStyle:"width:120",name:"compoItems",width:150}},{border:false,layout:"form",items:{xtype:"textfield",fieldLabel:"部件名称",name:"compoName",width:150}},{border:false,layout:"form",items:{xtype:"combo",fieldLabel:"是否在新窗口打开",labelStyle:"width:120;",store:new Ext.data.SimpleStore({autoLoad:true,data:[["N","否"],["Y","是"]],fields:["isAlwaysNew","showName"]}),id:"editIsAlwaysNew",displayField:"showName",valueField:"isAlwaysNew",hiddenName:"isAlwaysNew",typeAhead:true,mode:"local",forceSelection:true,triggerAction:"all",allowBlank:false,value:"N",width:150,height:30,selectOnFocus:true}},{border:false,layout:"form",items:{xtype:"combo",fieldLabel:"是否在菜单中显示",labelStyle:"width:105;",store:new Ext.data.SimpleStore({autoLoad:true,data:[["N","否"],["Y","是"]],fields:["isInMenu","showName"]}),id:"editIsInMenu",displayField:"showName",valueField:"isInMenu",hiddenName:"isInMenu",typeAhead:true,mode:"local",forceSelection:true,allowBlank:false,triggerAction:"all",value:"Y",width:150,height:30,selectOnFocus:true}},{border:false,layout:"form",items:{xtype:"combo",fieldLabel:"是否打开到编辑页面",labelStyle:"width:120;",store:new Ext.data.SimpleStore({autoLoad:true,data:[["N","否"],["Y","是"]],fields:["isGotoEdit","showName"]}),id:"editIsGotoEdit",displayField:"showName",valueField:"isGotoEdit",hiddenName:"isGotoEdit",typeAhead:true,mode:"local",forceSelection:true,allowBlank:false,triggerAction:"all",value:"N",width:150,height:30,selectOnFocus:true}},{border:false,layout:"form",items:{xtype:"textfield",fieldLabel:"部件链接地址URL",name:"compoUrl",width:150}},{border:false,layout:"form",items:{xtype:"button",id:"saveCompoButton",text:"保存部件",width:120,listeners:{click:function(){var b=Ext.getCmp("addCompoForm");if(b.getForm().isValid()&&b.getForm().isDirty()){b.getForm().submit({url:"saveMenuInfo.action",params:{action:"saveCompo",menuId:treeId},waitMsg:"正在保存数据，请稍候...",success:function(c,d){a.showMsg("提示信息",d.result.sign);currentNode.reload()}})}else{a.showMsg("提示信息","数据没有改变，不需保存")}}}}}]}}),new Ext.form.FormPanel({id:"impExpMenuInfo",title:"导入导出菜单信息",border:false,layout:"form",autoHeight:true,width:Ext.getBody().getWidth(),fileUpload:true,items:[{border:false,id:"menuInfo",xtype:"textarea",hideLabel:true,width:550,height:100},{border:false,id:"file",xtype:"textfield",inputType:"file",fieldLabel:"请选择导入文件",value:"",width:400,height:20}],buttonAlign:"left",buttons:[{xtype:"button",text:"从文件导入",id:"impFromFile",name:"impFromFile",listeners:{click:function(){if(Ext.getCmp("file").getValue()==""){alert("请选择导入文件！");return}var b=Ext.getCmp("impExpMenuInfo");if(b.getForm().isValid()){b.getForm().submit({url:"importMenuAction.action",params:{menuId:currentNode.id,pageId:Ext.getCmp("treePanel").items.get(serialNo).getRootNode().attributes.id},success:function(c,d){a.showMsg("提示信息","导入成功！")},failure:function(c,d){}})}}}},{xtype:"button",text:"导入",id:"impMenuInfo",name:"impMenuInfo",listeners:{click:function(){if(Ext.getCmp("file").getValue()!=""){alert("请清空导入文件！");return}var b=Ext.getCmp("impExpMenuInfo");if(b.getForm().isValid()){b.getForm().submit({url:"importMenuAction.action",params:{menuId:currentNode.id,pageId:Ext.getCmp("treePanel").items.get(serialNo).getRootNode().attributes.id},waitMsg:"正在导入菜单数据，请稍候...",success:function(c,d){a.showMsg("提示信息","导入成功！")},failure:function(c,d){a.showMsg("提示信息",d.result.sign)}})}}}},{xtype:"button",text:"导出",name:"ExpMenuInfo",listeners:{click:function(){var b=document.getElementById("expMenuForm");if(!b){b=document.createElement("form");b.id="expMenuForm"}var c=document.getElementById("iPageId");if(!c){c=document.createElement("input");c.id="iPageId";c.name="pageId";c.type="text"}c.value=Ext.getCmp("treePanel").items.get(serialNo).getRootNode().attributes.id;b.appendChild(c);c=document.getElementById("iMenuId");if(!c){c=document.createElement("input");c.id="iMenuId";c.name="menuId";c.type="text"}c.value=currentNode.id;b.appendChild(c);c=document.getElementById("iIsOnlyInMenu");if(!c){c=document.createElement("input");c.id="iIsOnlyInMenu";c.name="isOnlyInMenu";c.type="text"}c.value="true";b.appendChild(c);b.action=path+"/exportMenuAction.action";b.target="_blank";document.documentElement.appendChild(b);b.submit()}}}]})]}).show()},editCompo:function(){var a=this;new Ext.form.FormPanel({title:"编辑部件",id:"editCompoForm",layout:"table",applyTo:"editMenuDiv",border:false,layoutConfig:{columns:2},defaults:{bodyStyle:"padding:5px"},width:Ext.getBody().getWidth(),autoHeight:true,items:[{border:false,layout:"form",items:{xtype:"textfield",fieldLabel:"部件名称",name:"compoName",value:treeName,width:150}},{border:false,layout:"form",items:{xtype:"combo",fieldLabel:"是否在新窗口打开",labelStyle:"width:120;",store:new Ext.data.SimpleStore({autoLoad:true,data:[["N","否"],["Y","是"]],fields:["isAlwaysNew","showName"]}),id:"editIsAlwaysNew",displayField:"showName",valueField:"isAlwaysNew",hiddenName:"isAlwaysNew",typeAhead:true,mode:"local",forceSelection:true,triggerAction:"all",allowBlank:false,value:"N",width:150,height:30,selectOnFocus:true}},{border:false,layout:"form",items:{xtype:"combo",fieldLabel:"是否在菜单中显示",labelStyle:"width:105;",store:new Ext.data.SimpleStore({autoLoad:true,data:[["N","否"],["Y","是"]],fields:["isInMenu","showName"]}),id:"editIsInMenu",displayField:"showName",valueField:"isInMenu",hiddenName:"isInMenu",typeAhead:true,mode:"local",forceSelection:true,allowBlank:false,triggerAction:"all",value:"Y",width:150,height:30,selectOnFocus:true}},{border:false,layout:"form",items:{xtype:"combo",fieldLabel:"是否打开到编辑页面",labelStyle:"width:120;",store:new Ext.data.SimpleStore({autoLoad:true,data:[["N","否"],["Y","是"]],fields:["isGotoEdit","showName"]}),id:"editIsGotoEdit",displayField:"showName",valueField:"isGotoEdit",hiddenName:"isGotoEdit",typeAhead:true,mode:"local",forceSelection:true,allowBlank:false,triggerAction:"all",value:"N",width:150,height:30,selectOnFocus:true}},{border:false,layout:"form",items:{xtype:"textfield",fieldLabel:"部件链接地址URL",name:"compoUrl",width:150}}],buttonAlign:"left",buttons:[{border:false,xtype:"button",id:"updateCompoButton",text:"更新部件",width:120,listeners:{click:function(){var b=Ext.getCmp("editCompoForm");if(b.getForm().isValid()){b.getForm().submit({url:"saveMenuInfo.action",params:{action:"editCompo",menuId:currentNode.parentNode.id,compoId:treeId},waitMsg:"正在保存更新，请稍候...",success:function(c,d){a.showMsg("提示信息",d.result.sign)},failure:function(c,d){a.showMsg("提示信息",d.result.sign)}})}}}},{border:false,xtype:"button",id:"deleteCompoButton",text:"删除部件",width:120,listeners:{click:function(){var b=Ext.getCmp("editCompoForm");if(b.getForm().isValid()){Ext.Msg.confirm("确认删除","确实要删除该部件吗？",function(c){if(c=="yes"){b.getForm().submit({url:"saveMenuInfo.action",params:{action:"deleteCompo",menuId:currentNode.parentNode.id,compoId:treeId},waitMsg:"正在删除部件，请稍候...",success:function(d,e){a.showMsg("提示信息",e.result.sign);treeId=currentNode.parentNode.id;currentNode.remove();Ext.get("menuConf").getUpdater().update({url:"html/system/function/menuEditConf.jsp",scripts:true,params:{id:treeId},text:"页面刷新中，请稍候...",scope:this})},failure:function(d,e){a.showMsg("提示信息",e.result.sign)}})}})}}}}]})},getCompoData:function(){Ext.Ajax.request({url:"getJsonData.action",params:{ruleID:"portal-common.getCompoData",compoId:treeId,menuId:currentNode.parentNode.id},success:function(b){var a=Ext.util.JSON.decode(b.responseText);if(a.length>0){Ext.getCmp("editIsAlwaysNew").setValue(a[0].is_always_new);Ext.getCmp("editIsInMenu").setValue(a[0].is_in_menu);Ext.getCmp("editIsGotoEdit").setValue(a[0].is_goto_edit);Ext.get("compoUrl").dom.value=a[0].url}}})},initPage:function(){this.getCurrentNodeInfo();this.showNodeInfo();if(treeName!=undefined){if(isNew){this.editMenu();this.getProductItems();if(groupId=="admin"||groupId=="sa"){Ext.getCmp("saveCompoButton").setDisabled(true);Ext.getCmp("impFromFile").setDisabled(true);Ext.getCmp("impMenuInfo").setDisabled(true)}}else{this.editCompo();this.getCompoData();if(groupId=="admin"||groupId=="sa"){Ext.getCmp("updateCompoButton").setDisabled(true);Ext.getCmp("deleteCompoButton").setDisabled(true)}}}}});Ext.onReady(function(){Ext.QuickTips.init();var a=new ufgov.portal.system.MenuEditConf();a.initPage()});