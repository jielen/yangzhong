var menuOrient=null;ufgov.portal.system.PageEdit=function(){};Ext.extend(ufgov.portal.system.PageEdit,ufgov.portal.Base,{pageInit:function(){this.createMainFrame();this.getUserGroup()},createMainFrame:function(){var b=new Ext.Panel({layout:"border",border:false,items:[{region:"north",border:false,height:40,html:'<div id="pageGroup" style="width:100%;height:60"></div>'},{region:"west",border:true,id:"userGroupPage",title:"用户组栏目",split:true,layout:"fit",collapsible:true,margins:"0 0 5 5",minSize:150,maxSize:200,width:150,items:{id:"pageInfo",border:false,html:'<span id="pageInfo" style="width:100%"></span>'}},{region:"center",border:false,layout:"fit",margins:"0 0 5 0",items:[{border:true,xtype:"pageTemp",region:"center",title:"栏目内容定制",id:"pageCont",html:'<span id="pageCont" style="width:100%"></span>'}]},{region:"east",border:true,title:"选择频道",split:true,collapsible:true,margins:"0 5 5 0",layout:"fit",minSize:150,maxSize:200,width:150,items:[{id:"portletInfo",border:false,html:'<span id="portletInfo" style="width:100%"></span>'}]}]});var a=new Ext.Panel({layout:"fit",id:"pageConfMain",applyTo:"pageConfMain",border:false,items:b});Ext.getCmp("mainFrame").on("resize",function(){b.setWidth(0);b.setWidth(Ext.getCmp("pageConfMain").getInnerWidth());b.syncSize()});window.onresize=function(){b.setWidth(0);b.setWidth(Ext.getCmp("pageConfMain").getInnerWidth())}},getUserGroup:function(){var a=new Ext.Panel({layout:"fit",border:false,applyTo:"pageGroup",items:{layout:"table",defaults:{bodyStyle:"padding:10px"},layoutConfig:{columns:3},border:false,items:[{width:120,border:false,html:"&nbsp;&nbsp;&nbsp;&nbsp;请选择用户组："},{width:200,border:false,html:'<input type="text" id="userPageGroup" size="20"/>'},{xtype:"button",width:120,name:"addUserGroup",text:"新增用户组",handler:function(){var c="/admin/getpage_AS_GROUP.action?function=geteditpage&componame=AS_GROUP&tablename=AS_GROUP&condition=1=0&token="+token;window.open(c,"_blank","left=0px,top=0px,width="+screen.availWidth+",height="+screen.availHeight+",menubar=no,scrollbars=no,status=no,toolbar=no,resizable=no")}}]}});var b=new Ext.form.ComboBox({store:new Ext.data.JsonStore({autoLoad:true,url:"getJsonData.action",baseParams:{ruleID:"portal-common.getGroup"},fields:[{name:"groupId",mapping:"groupid"},{name:"groupName",mapping:"groupname"}]}),id:"groupId",displayField:"groupName",valueField:"groupId",hiddenName:"groupId",typeAhead:true,mode:"local",forceSelection:true,editable:false,triggerAction:"all",allowBlank:false,emptyText:"选择用户组...",width:120,height:30,selectOnFocus:true,applyTo:"userPageGroup"});b.on({select:{fn:function(f,c,d){var e=c.data.groupId;var g=c.data.groupName;Ext.getCmp("userGroupPage").setTitle(g);PageEdit.createPageWindow(e,g)},scope:this}});return a},createPage:function(a,c){var b=new Ext.tree.TreePanel({id:a+"_Panel",header:true,xtype:"treepanel",border:false,autoScroll:true,split:true,singleExpand:true,hideCollapseTool:true,useArrows:true,tools:[{id:"gear",qtip:"定制栏目显示样式",handler:function(f,e,d){PageEdit.pageShowConfig()}},{id:"refresh",qtip:"栏目重新排序",handler:function(f,e,d){PageEdit.pageSort()}},{id:"plus",qtip:"添加栏目",handler:function(f,e,d){PageEdit.doPageInfo()}}],loader:new Ext.tree.TreeLoader({dataUrl:"getGroupPage.action?groupId="+a+"&hasMenu=N"}),rootVisible:false,root:new Ext.tree.AsyncTreeNode({id:a,text:"根结点"}),listeners:{click:function(d){PageEdit.pageTreeClick(d)},contextmenu:function(e,d){d.preventDefault();var f=new Ext.menu.Menu({id:"rightClickCont",items:[{id:"newPage",text:"添加子栏目",iconCls:"add",handler:function(){if(e.attributes.menuOrient=="1"||e.attributes.menuOrient=="2"){PageEdit.showMsg("温馨提示","已经定制了菜单，不能再定制子栏目");return false}PageEdit.doPageInfo(e,"add")}},{id:"editPage",text:"编辑栏目",iconCls:"grid",handler:function(){PageEdit.doPageInfo(e,"edit")}},{id:"deletePage",text:"删除栏目",iconCls:"delete",handler:function(){PageEdit.deletePageInfo(e)}},{id:"sortPage",text:"子栏目排序",iconCls:"grid",handler:function(){PageEdit.pageSort(e)}},{id:"selectTemp",text:"选择模板",iconCls:"add",handler:function(){PageEdit.selectPageTemp()}}]});f.showAt(d.getXY())}}});return b},createPageWindow:function(a,d){var c=PageEdit.createPage(a,d);if(this.panel!=null){for(var b=this.panel.items.length;b>0;b--){this.panel.remove(this.panel.items.items[b-1])}}this.panel=new Ext.Panel({layout:"fit",id:"pagePanel",applyTo:"pageInfo",autoScroll:false,layout:"accordion",layoutConfig:{animate:true,titleCollapse:false},items:c}).show()},createPortlet:function(d,b,c,a){var e=new Ext.tree.TreePanel({id:"panel"+d,title:b,xtype:"treepanel",border:false,ddGroup:"tempDDGroup",autoScroll:true,split:true,singleExpand:true,useArrows:true,enableDD:true,loader:new Ext.tree.TreeLoader({dataUrl:"getPortletInfo.action?groupId="+c+"&portletType="+d}),rootVisible:false,root:new Ext.tree.AsyncTreeNode({id:"root"+d,text:"根结点"}),listeners:{click:function(f){}}});return e},createPortletWindow:function(a){var b=Ext.getCmp("groupId").getValue();var d=this;if(this.portlet!=null){for(var c=this.portlet.items.length;c>0;c--){this.portlet.remove(this.portlet.items.items[c-1])}}Ext.Ajax.request({url:"getJsonData.action",params:{ruleID:"portal-common.getValSet",valsetId:"VS_AP_PORTLET_TYPE"},callback:function(g,k,j){if(k){var e=Ext.util.JSON.decode(j.responseText);var h=new Array();if(e.length>0){for(var f=0;f<e.length;f++){h[f]=PageEdit.createPortlet(e[f].val_id,e[f].val,b,a)}d.portlet=new Ext.Panel({layout:"fit",id:"portletPanel",applyTo:"portletInfo",border:true,autoScroll:false,layout:"accordion",layoutConfig:{animate:true},items:h}).show()}}}})},createPagePortlet:function(c,a){var b=new ufgov.portal.system.PagePortlet({title:c.title,id:c.id,tools:[{id:"gear",qtip:"修改频道属性",handler:function(h,g,d){var f=new Ext.Window({title:"修改频道属性",width:600,height:530,layout:"fit",closable:false,border:true,items:new Ext.form.FormPanel({border:false,id:"modifyNode",layout:"table",defaults:{bodyStyle:"padding:5px"},layoutConfig:{columns:2},buttonAlign:"center",items:[{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"频道标题",labelStyle:"text-align:right",name:"portletTitle",value:d.title,width:150}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"标题字体大小",labelStyle:"text-align:right",name:"titleFontSize",value:c.title_font_size,width:150}]},{border:false,layout:"form",items:[{xtype:"combo",fieldLabel:"标题字体",labelStyle:"text-align:right",store:new Ext.data.SimpleStore({autoLoad:true,data:[["Arial","Arial"],["Arial Black","Arial Black"],["Comic Sans Ms","Comic Sans Ms"],["Times New Roman","Times New Roman"],["宋体","宋体"],["黑体","黑体"],["楷体","楷体"],["篆体","篆体"]],fields:["titleFont","showName"]}),id:"titleFontCombo",displayField:"showName",valueField:"titleFont",hiddenName:"titleFont",typeAhead:true,mode:"local",editable:false,triggerAction:"all",emptyText:"请选择...",value:c.title_font,width:150,height:30,selectOnFocus:true}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"标题字体颜色",labelStyle:"text-align:right",name:"titleFontColor",value:c.title_font_color,width:150,listeners:{focus:function(e){colordialog(e.el.getX(),e.el.getY())}}}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"标题背景",labelStyle:"text-align:right",name:"titleBgColor",value:c.title_bg_color,width:150,listeners:{focus:function(e){colordialog(e.el.getX(),e.el.getY())}}}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"标题背景图片",labelStyle:"text-align:right",name:"titleBgImg",value:c.title_bg_img,width:150}]},{border:false,layout:"form",items:[{xtype:"combo",fieldLabel:"内容字体",labelStyle:"text-align:right",store:new Ext.data.SimpleStore({autoLoad:true,data:[["Arial","Arial"],["Arial Black","Arial Black"],["Comic Sans Ms","Comic Sans Ms"],["Times New Roman","Times New Roman"],["宋体","宋体"],["黑体","黑体"],["楷体","楷体"],["篆体","篆体"]],fields:["contentFont","showName"]}),id:"contentFontCombo",displayField:"showName",valueField:"contentFont",hiddenName:"contentFont",typeAhead:true,mode:"local",editable:false,triggerAction:"all",emptyText:"请选择...",value:c.content_font,width:150,height:30,selectOnFocus:true}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"内容字体大小",labelStyle:"text-align:right",name:"contentFontSize",value:c.content_font_size,width:150}]},{border:false,layout:"form",items:[{xtype:"combo",fieldLabel:"有无边界",labelStyle:"text-align:right",store:new Ext.data.SimpleStore({autoLoad:true,data:[["0","无"],["1","有"]],fields:["portletBorder","showName"]}),id:"borderCombo",displayField:"showName",valueField:"portletBorder",hiddenName:"portletBorder",typeAhead:true,mode:"local",editable:false,triggerAction:"all",emptyText:"请选择...",value:c.border,width:150,height:30,selectOnFocus:true}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"内容背景颜色",labelStyle:"text-align:right",name:"contentBgColor",value:c.content_bg_color,width:150,listeners:{focus:function(e){colordialog(e.el.getX(),e.el.getY())}}}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"内容字体颜色",labelStyle:"text-align:right",name:"contentFontColor",value:c.content_font_color,width:150,listeners:{focus:function(e){colordialog(e.el.getX(),e.el.getY())}}}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"内容背景图片",labelStyle:"text-align:right",name:"contentBgImg",value:c.content_bg_img,width:150}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"页面显示记录",labelStyle:"text-align:right",name:"recordSize",value:c.record_size,width:150}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"频道固定高度",labelStyle:"text-align:right",name:"portletHeight",value:c.portlet_height,width:150}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"列索引",labelStyle:"text-align:right",name:"colNo",value:c.col_no,width:150}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"行索引",labelStyle:"text-align:right",name:"rowNo",value:c.rowno,width:150}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"页签号",labelStyle:"text-align:right",name:"tabIndex",value:c.tab_index,width:150}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"页签标识",labelStyle:"text-align:right",name:"tabSign",value:c.tab_sign,width:150}]},{border:false,colspan:2,html:"<font color=#ff0000>*注意：以上两项只在使用页签时设置！页签号为页签显示时顺序，页签标示表示属于哪个页签。</font>"},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"宽度比率",labelStyle:"text-align:right",name:"colRatio",value:c.col_ratio,width:150}]},{border:false,html:"<font color=#ff0000>*注意：只在频道需要不规则宽度时设置！</font>"},{border:false,colspan:2,html:"<font color=#ff0000>重要提示：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;页面信息填完并点击“确定”按钮后，数据只是暂时缓存，并没有保存到数据库中，必须点击栏目内容定制右上角“保存”图标进行保存！！！</font>"}],buttons:[{xtype:"button",text:"确定",width:150,handler:function(){d.setTitle(Ext.get("portletTitle").dom.value);var e=a.getSerialNoById(d.id);a.textArray[e]=d.title;if(null==Ext.get("colNo").dom.value||""==Ext.get("colNo").dom.value){PageEdit.showMsg("温馨提示","列索引不能为空，请填写后保存！");return}a.titleFontSize[e]=Ext.get("titleFontSize").dom.value;a.titleFont[e]=Ext.get("titleFont").dom.value;a.titleFontColor[e]=Ext.get("titleFontColor").dom.value;a.titleBgColor[e]=Ext.get("titleBgColor").dom.value;a.titleBgImg[e]=Ext.get("titleBgImg").dom.value;a.contentFont[e]=Ext.get("contentFont").dom.value;a.contentFontSize[e]=Ext.get("contentFontSize").dom.value;a.portletBorder[e]=Ext.get("portletBorder").dom.value;a.contentBgColor[e]=Ext.get("contentBgColor").dom.value;a.contentFontColor[e]=Ext.get("contentFontColor").dom.value;a.contentBgImg[e]=Ext.get("contentBgImg").dom.value;a.recordSize[e]=Ext.get("recordSize").dom.value;a.portletHeight[e]=Ext.get("portletHeight").dom.value;a.colNo[e]=Ext.get("colNo").dom.value;a.rowNo[e]=Ext.get("rowNo").dom.value;a.tabIndex[e]=Ext.get("tabIndex").dom.value;a.colRatio[e]=Ext.get("colRatio").dom.value;a.tabSign[e]=Ext.get("tabSign").dom.value;if(a.isExist[e]=="1"){a.isChanged[e]="2"}else{a.isChanged[e]="1"}f.close()}},{xtype:"button",text:"取消",width:150,handler:function(){f.close()}}]})});f.show();f.center()}},{id:"close",handler:function(j,h,d){d.ownerCt.remove(d,true);var f=a.getSerialNoById(d.id);var g=new Ext.tree.TreeNode({id:d.id,text:a.nameArray[f],leaf:true});a.isChanged[f]="3"}}]});return b},showTempView:function(g,b,c){var d=c.attributes.id;var f=c.attributes.text;f=f+"--栏目内容定制";var h;if(g>1){var j="[";for(var e=0;e<g;e++){j+="{";j+="columnWidth:";if(b.length>1){j+=b[e]}else{j+=b[0]}j+=",";j+='style: "padding:0px 10px 10px 10px"';j+="}";j+=","}if(j.indexOf(",")>0){j=j.substring(0,j.length-1)}j+="]";h=Ext.util.JSON.decode(j)}else{var j="[";j+="{";j+='style: "padding:0px 10px 10px 10px"';j+="}";j+="]";h=Ext.util.JSON.decode(j)}if(this.pageContPanel!=null){for(var a=this.pageContPanel.items.length;a>0;a--){this.pageContPanel.remove(this.pageContPanel.items.items[a-1])}this.pageContPanel.tools.save.remove();this.pageContPanel.tools.restore.remove()}this.pageContPanel=new ufgov.portal.system.PageTemplate({applyTo:"pageCont",id:"pageContPanel",title:f,tools:[{id:"restore",qtip:"预览栏目模板",handler:function(l,k,i){PageEdit.showMsg("温馨提示","预览栏目模板功能以后提供，敬请关注！")}},{id:"save",qtip:"保存栏目定制信息",handler:function(l,k,i){PageEdit.savePageTempInfo(l,k,i,c)}}],border:true,width:Ext.get("pageCont").getWidth(),items:h});PageEdit.getPagePortletInfo(c)},savePageTempInfo:function(h,g,a,f){var b=f.attributes.id;var d="[";for(var c=0;c<a.idArray.length;c++){if(a.isChanged[c]=="0"){continue}if(a.isChanged[c]=="3"&&a.isExist[c]=="0"){continue}d+="{";d+="id:'"+a.idArray[c]+"',";d+="pageId:'"+b+"',";d+="portletId:'"+a.portletIdArray[c]+"',";d+="pageTitle:'"+a.textArray[c]+"',";d+="colNo:'"+a.colArray[c]+"',";d+="ordIndex:'"+a.indexArray[c]+"',";d+="isChanged:'"+a.isChanged[c]+"',";d+="titleFontSize:'"+a.titleFontSize[c]+"',";d+="titleFont:'"+a.titleFont[c]+"',";d+="titleFontColor:'"+a.titleFontColor[c]+"',";d+="titleBgColor:'"+a.titleBgColor[c]+"',";d+="titleBgImg:'"+a.titleBgImg[c]+"',";d+="contentFont:'"+a.contentFont[c]+"',";d+="contentFontSize:'"+a.contentFontSize[c]+"',";d+="portletBorder:'"+a.portletBorder[c]+"',";d+="contentBgColor:'"+a.contentBgColor[c]+"',";d+="contentFontColor:'"+a.contentFontColor[c]+"',";d+="contentBgImg:'"+a.contentBgImg[c]+"',";d+="recordSize:'"+a.recordSize[c]+"',";d+="portletHeight:'"+a.portletHeight[c]+"',";d+="colNo:'"+a.colNo[c]+"',";d+="rowNo:'"+a.rowNo[c]+"',";d+="tabIndex:'"+a.tabIndex[c]+"',";d+="colRatio:'"+a.colRatio[c]+"',";d+="tabSign:'"+a.tabSign[c]+"',";d+="}";d+=","}if(d.indexOf(",")>=0){d=d.substring(0,d.length-1)}d+="]";if(d=="[]"){PageEdit.showMsg("温馨提示","栏目没有改变，不需保存")}else{Ext.MessageBox.show({title:"保存",msg:"正在保存中，请稍候...",progressText:"保存中...",width:300,wait:true,waitConfig:{interval:50},icon:"download"});Ext.Ajax.request({url:"savePageInfo.action",params:{action:"savePagePortlet",jsonData:d},success:function(i){PageEdit.createTempWindow(f);Ext.MessageBox.hide();var e=Ext.util.JSON.decode(i.responseText);PageEdit.showMsg("温馨提示",e.sign)},failure:function(i){Ext.MessageBox.hide();var e=Ext.util.JSON.decode(i.responseText);PageEdit.showMsg("温馨提示",e.sign)}})}},getPagePortletInfo:function(b){var a=b.attributes.id;Ext.Ajax.request({url:"getJsonData.action",params:{ruleID:"portal-common.getPagePortlet",pageId:a},success:function(f){var d=Ext.util.JSON.decode(f.responseText);var e=PageEdit.pageContPanel;var c=0;for(var g=0;g<d.length;g++){var h=PageEdit.createPagePortlet(d[g],e);if(d[g].col_no>=e.items.items.length){continue}e.items.itemAt(d[g].col_no).add(h);e.idArray[c]=d[g].id;e.portletIdArray[c]=d[g].portlet_id;e.textArray[c]=d[g].title;e.nameArray[c]=d[g].portlet_name;e.typeArray[c]=d[g].portlet_type;e.indexArray[c]=d[g].ord_index;e.colArray[c]=d[g].col_no;e.isExist[c]="1";e.isChanged[c]="0";e.titleFontSize[c]=d[g].title_font_size;e.titleFont[c]=d[g].title_font;e.titleFontColor[c]=d[g].title_font_color;e.titleBgColor[c]=d[g].title_bg_color;e.titleBgImg[c]=d[g].title_bg_img;e.contentFont[c]=d[g].content_font;e.contentFontSize[c]=d[g].content_font_size;e.portletBorder[c]=d[g].border;e.contentBgColor[c]=d[g].content_bg_color;e.contentFontColor[c]=d[g].content_font_color;e.contentBgImg[c]=d[g].content_bg_img;e.recordSize[c]=d[g].record_size;e.portletHeight[c]=d[g].portlet_height;e.colNo[c]=d[g].col_no;e.rowNo[c]=d[g].rowno;e.tabIndex[c]=d[g].tab_index;e.colRatio[c]=d[g].col_ratio;e.tabSign[c]=d[g].tab_sign;c++}e.doLayout()},failure:function(d){var c=Ext.util.JSON.decode(d.responseText);PageEdit.showMsg("温馨提示",c)}})},createTempWindow:function(b){var a=b.attributes.id;Ext.Ajax.request({url:"getJsonData.action",params:{ruleID:"portal-common.getGroupPage",groupId:Ext.getCmp("groupId").getValue(),pageId:a},callback:function(e,i,d){if(i){var c=Ext.util.JSON.decode(d.responseText);var h=c[0].column_count;var g=c[0].column_ratio;var f=new Array();if(h>1){if(!Ext.isEmpty(g)){f=g.split(",")}else{f[f.length]=(100/h)/100}}PageEdit.showTempView(h,f,b)}}})},pageShowConfig:function(){var a=new Ext.Window({title:"定制栏目显示样式",width:400,height:100,layout:"fit",closable:true,defaults:{bodyStyle:"padding:5px"},border:true,items:new Ext.form.FormPanel({border:false,id:"menuType",layout:"form",items:[{xtype:"combo",fieldLabel:"栏目显示样式",store:new Ext.data.SimpleStore({autoLoad:true,data:[["1","横向"],["2","纵向"],["3","列表"]],fields:["orientation","showName"]}),id:"pageOrient",displayField:"showName",valueField:"orientation",hiddenName:"orientation",typeAhead:true,mode:"local",editable:false,allowBlank:false,triggerAction:"all",emptyText:"请选择...",width:100,height:30,selectOnFocus:true},{xtype:"hidden",id:"action",value:"add"}],buttonAlign:"center",buttons:[{text:"保存",handler:function(){Ext.MessageBox.show({title:"保存",msg:"正在保存中，请稍候...",progressText:"保存中...",width:300,wait:true,waitConfig:{interval:50},icon:"download"});Ext.Ajax.request({url:"saveGroupConfig.action",params:{groupId:Ext.getCmp("groupId").getValue(),pageOrient:Ext.getCmp("pageOrient").getValue(),action:Ext.getCmp("action").getValue()},callback:function(d,e,c){Ext.MessageBox.hide();var b=c.responseText;PageEdit.showMsg("温馨提示",b);a.close()}})}}]})});Ext.Ajax.request({url:"getJsonData.action",params:{ruleID:"portal-common.getGroupConfig",groupId:Ext.getCmp("groupId").getValue()},callback:function(d,e,c){if(e){var b=Ext.util.JSON.decode(c.responseText);if(b.length>0){Ext.getCmp("pageOrient").setValue(b[0].page_orient);Ext.getCmp("action").setValue("edit")}}else{var b=c.responseText;PageEdit.showMsg("温馨提示",b)}}});a.show();a.center()},doPageInfo:function(a,f){var b="addPageInfo";var d="添加栏目信息";var e="";if(a!=null){if(f=="edit"){b="editPageInfo";d="编辑栏目信息"}else{b="addPageInfo";d="添加子栏目信息";e=a.attributes.id}}else{e=Ext.getCmp("groupId").getValue()}var c=new Ext.Window({title:d,width:600,height:300,layout:"fit",closable:true,border:true,items:new Ext.form.FormPanel({id:"pageInfoForm",border:false,layout:"table",defaults:{bodyStyle:"padding:5px"},layoutConfig:{columns:2},buttonAlign:"center",items:[{layout:"form",border:false,items:{xtype:"textfield",fieldLabel:"栏目代码",labelStyle:"text-align:right;",name:"pageId",disabled:true,value:(new Date()).getTime(),width:150}},{layout:"form",border:false,items:[{xtype:"textfield",fieldLabel:"栏目标题",labelStyle:"text-align:right;",name:"pageTitle",width:150},{xtype:"hidden",name:"parentId",value:e}]},{layout:"form",border:false,items:{xtype:"textfield",fieldLabel:"标题图片",labelStyle:"text-align:right;",name:"pageTitleImg",width:150}},{layout:"form",border:false,items:{xtype:"textfield",fieldLabel:"栏目链接",labelStyle:"text-align:right;",name:"pageUrl",width:150}},{layout:"form",border:false,items:{xtype:"combo",fieldLabel:"在新窗口打开",labelStyle:"text-align:right;",store:new Ext.data.SimpleStore({autoLoad:true,data:[["N","否"],["Y","是"]],fields:["isAlwaysNew","showName"]}),id:"isNew",displayField:"showName",valueField:"isAlwaysNew",hiddenName:"isAlwaysNew",typeAhead:true,mode:"local",forceSelection:true,editable:false,triggerAction:"all",allowBlank:true,value:"N",width:150,height:30,selectOnFocus:true}},{layout:"form",border:false,items:{xtype:"combo",fieldLabel:"菜单显示样式",labelStyle:"text-align:right;",store:new Ext.data.SimpleStore({autoLoad:true,data:[["0","无菜单"],["1","横向"],["2","纵向"]],fields:["menuOrient","showName"]}),id:"pageMenuCombo",displayField:"showName",valueField:"menuOrient",hiddenName:"menuOrient",typeAhead:true,mode:"local",editable:false,triggerAction:"all",emptyText:"请选择...",width:150,height:30,selectOnFocus:true,listeners:{select:function(j,g,h){var i=g.data.menuOrient;if(menuOrient!=0&&i==0){Ext.Ajax.request({url:"getJsonData.action",params:{ruleID:"portal-common.getSubMenu",menuId:Ext.get("pageId").dom.value},callback:function(m,n,l){if(n){var k=Ext.util.JSON.decode(l.responseText);if(k.length>0){PageEdit.showMsg("温馨提示","该栏目已经挂接了菜单，请先删除挂接的菜单！");Ext.getCmp("pageMenuCombo").setValue(menuOrient)}}}})}}}}},{layout:"form",border:false,items:{xtype:"numberfield",fieldLabel:"模板列数",labelStyle:"text-align:right;",name:"columnCount",value:3,width:150}},{layout:"form",border:false,items:{xtype:"textfield",fieldLabel:"各列比例",labelStyle:"text-align:right;",name:"columnRatio",width:150}},{layout:"form",border:false,colspan:2,items:{xtype:"combo",fieldLabel:"是否显示栏目",labelStyle:"text-align:right;",store:new Ext.data.SimpleStore({autoLoad:true,data:[["N","否"],["Y","是"]],fields:["isDisplay","showName"]}),id:"isItemDisplay",displayField:"showName",valueField:"isDisplay",hiddenName:"isDisplay",typeAhead:true,mode:"local",forceSelection:true,editable:false,triggerAction:"all",allowBlank:true,value:"Y",width:150,Height:30,selectOnFocus:true}},{layout:"form",border:false,colspan:2,html:"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color='#ff0000'>备注：各列比例用‘，’分隔开，如三列的比例 '0.25,0.25,0.5' ，允许为空，默认均分</font>"}],buttons:[{text:"保存",handler:function(){var k=Ext.getCmp("pageInfoForm");if(k.getForm().isValid()){if(Ext.get("pageTitle").dom.value==""){alert("栏目标题不能为空");return false}if(Ext.get("pageUrl").dom.value==""){if(Ext.get("columnCount").dom.value==""){alert("模板列数和栏目链接必须填一项");return false}if(Ext.get("columnCount").dom.value==0){alert("模板列数必须大于0");return false}}if(Ext.get("columnRatio").dom.value!=""){var j=Ext.get("columnRatio").dom.value.split(",");var h=0;for(var g=0;g<j.length;g++){h+=parseInt(j[g].substring(2,j[g].length))}if(100!=h){alert("各列比率之和必须为一！");return false}}var l=Ext.getCmp("pageMenuCombo").getValue();if(a&&!a.isLeaf()){if(l=="1"||l=="2"){alert("栏目已经设置了子栏目，不能再有菜单");return false}}k.getForm().submit({url:"savePageInfo.action",params:{action:b,groupId:Ext.getCmp("groupId").getValue(),pageId:Ext.get("pageId").dom.value,oldMenuOrient:menuOrient},waitMsg:"正在保存数据，请稍候...",success:function(m,i){PageEdit.showMsg("提示信息",i.result.sign);c.close();Ext.getCmp(Ext.getCmp("groupId").getValue()+"_Panel").getRootNode().reload()},failure:function(m,i){PageEdit.showMsg("提示信息",i.result.sign);c.close()}})}}},{text:"关闭",handler:function(){c.close()}}]})});c.show();c.center();if(b=="editPageInfo"){Ext.Ajax.request({url:"getJsonData.action",params:{groupId:Ext.getCmp("groupId").getValue(),pageId:a.attributes.id,ruleID:"portal-common.getGroupPage"},success:function(g){var h=Ext.util.JSON.decode(g.responseText);Ext.get("pageId").dom.value=h[0].page_id;Ext.get("pageTitle").dom.value=h[0].page_title;if(h[0].parent_id==null||h[0].parent_id==""){Ext.get("parentId").dom.value=Ext.getCmp("groupId").getValue()}else{Ext.get("parentId").dom.value=h[0].parent_id}Ext.getCmp("isNew").setValue(h[0].is_always_new);Ext.getCmp("pageMenuCombo").setValue(h[0].menu_orient);Ext.get("pageUrl").dom.value=h[0].page_url;Ext.get("pageTitleImg").dom.value=h[0].page_title_img;Ext.get("columnCount").dom.value=h[0].column_count;Ext.get("columnRatio").dom.value=h[0].column_ratio;Ext.getCmp("isItemDisplay").setValue(h[0].is_display);if(h[0].menu_orient){menuOrient=h[0].menu_orient}else{menuOrient=0}}})}},deletePageInfo:function(a){Ext.Msg.confirm("确认删除","删除该结点将同时删除所有该结点的子结点，另外，如果子结点挂接了菜单，也将同时删除挂接的菜单，确实要删除该结点吗？",function(b){if(b=="yes"){Ext.Ajax.request({url:"savePageInfo.action?action=deletePageInfo&pageId="+a.attributes.id+"&groupId="+Ext.getCmp("groupId").getValue(),success:function(d){var c=Ext.util.JSON.decode(d.responseText);Ext.getCmp(Ext.getCmp("groupId").getValue()+"_Panel").getRootNode().reload();alert(c.sign)},failure:function(d){var c=d.responseText;alert(c.sign)}})}})},pageSort:function(a){var b=new Ext.Window({title:"栏目重新排序",width:550,height:400,layout:"fit",id:"sortPanel",defaults:{bodyStyle:"padding:0px"},border:false,items:new Ext.grid.EditorGridPanel({store:new Ext.data.JsonStore({autoLoad:true,url:"getJsonData.action",baseParams:{ruleID:"portal-common.getGroupPage",groupId:Ext.getCmp("groupId").getValue(),parentId:a?a.attributes.id:Ext.getCmp("groupId").getValue()},fields:[{name:"page_id"},{name:"page_title"},{name:"page_order"}]}),columns:[{id:"pageId",header:"栏目代码",align:"center",width:100,sortable:true,dataIndex:"page_id"},{id:"pageName",header:"名称",align:"center",width:200,sortable:true,dataIndex:"page_title"},{id:"ordIndex",header:"排序",align:"center",sortable:true,dataIndex:"page_order",editor:new Ext.form.TextField({allowBlank:false})}],id:"sortGrid",viewConfig:{forceFit:true},frame:false,clicksToEdit:2,buttonAlign:"center",buttons:[{id:"saveSort",text:"保存",handler:function(){var c=Ext.getCmp("sortGrid").getStore().getModifiedRecords();if(c.length>0){var e="[";for(var f=0;f<c.length;f++){var d="{pageId: '"+c[f].data.page_id+"',";d+="groupId: '"+Ext.getCmp("groupId").getValue()+"',";d+="pageOrder: '"+c[f].data.page_order+"'}";e+=d+","}if(e.length>1){e=e.substring(0,e.length-1)}e+="]";Ext.Ajax.request({url:"savePageInfo.action",params:{action:"sortPage",jsonData:e},success:function(h){var g=Ext.util.JSON.decode(h.responseText);alert(g.sign);b.close();Ext.getCmp(Ext.getCmp("groupId").getValue()+"_Panel").getRootNode().reload()}})}else{PageEdit.showMsg("提示信息","栏目没有修改信息，不用保存！")}}},{text:"关闭",handler:function(){b.close()}}]})});b.show();b.center()},pageTreeClick:function(a){if(Ext.isEmpty(a.attributes.url)){PageEdit.createPortletWindow(a.attributes.id);PageEdit.createTempWindow(a)}else{PageEdit.showMsg("温馨提示","已经有栏目链接，不需要再定制栏目")}},selectPageTemp:function(){PageEdit.showMsg("温馨提示","该功能尚未实现")}});var PageEdit=new ufgov.portal.system.PageEdit();Ext.onReady(function(){Ext.QuickTips.init();PageEdit.pageInit()});