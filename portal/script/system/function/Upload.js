Ext.onReady(function(){var x=new Ext.TabPanel({renderTo:"uploadSearch",collapsible:true,activeTab:0,resizable:true,autoWidth:true,items:[{contentEl:"divUploadFast",title:"搜索",id:"tabSrFast"},{contentEl:"divUploadAdv",title:"高级搜索",id:"tabSrAdv"}]});x.remove("tabSrAdv");var o=new Ext.form.FormPanel({id:"frmSrFast",renderTo:"divUploadFast",title:"",hideLabels:false,buttonAlign:"center",labelAlign:"right",labelWidth:70,border:false,frame:false,items:[{layout:"column",bodyStyle:"padding:3px 3px 3px 3px;border:1px solid;border-width:0 0 1 0",items:[{columnWidth:0.5,layout:"form",border:false},{columnWidth:0.5,layout:"form",border:false}]}],buttons:[{text:"搜索",handler:m},{text:"重置",handler:y}]});var j=[{name:"valId"},{name:"val"}];var n=new ufgov.portal.Base();var u=n.getDs(j,"asService.getListByValsetId_AsVal","valsetId",new ufgov.portal.common.Param("VS_AP_RESOURCE_TYPE","","valsetId"));var F=new Ext.form.TextField({fieldLabel:"资源编码",name:"fileId",width:150});var E=new Ext.form.TextField({fieldLabel:"资源名称",name:"fileName",width:150});var C=new Ext.form.TextField({fieldLabel:"创建者",name:"fileCreator",width:150});var B=new Ext.form.DateField({fieldLabel:"上传日期",name:"fileUploadtime",format:"Y-m-d",width:150});var A=new Ext.form.ComboBox({fieldLabel:"资源类型",store:u,valueField:"valId",displayField:"val",name:"type",typeAhead:true,mode:"local",triggerAction:"all",emptyText:"请选择资源类型",editable:false,width:150});o.items.get(0).items.get(0).items.add(F);o.items.get(0).items.get(1).items.add(E);o.items.get(0).items.get(0).items.add(A);var H=document.getElementById("svUserID").getAttribute("value");if("sa"==H){o.items.get(0).items.get(1).items.add(C)}o.doLayout();function y(){for(nn=0;nn<o.items.get(0).items.length;nn++){for(jj=0;jj<o.items.get(0).items.get(nn).items.length;jj++){var R=o.items.get(0).items.get(nn).items.items[jj];R.setValue("")}}}var D=new Ext.form.FormPanel({id:"fmSrAdv",renderTo:"divUploadAdv",title:"",hideLabels:false,height:80,buttonAlign:"center",labelAlign:"right",labelWidth:40,frame:false,hideLabels:true,bodyStyle:"padding:5 5 5 5;",items:[{xtype:"radio",boxLabel:"新增 ",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",checked:true,anchor:"45%"},{xtype:"radio",boxLabel:"高级搜索1",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",anchor:"45%"},{xtype:"radio",boxLabel:"高级搜索6",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",anchor:"45%"}],buttons:[{text:"搜索",handler:M,id:"execSrAdv"},{text:"设计",handler:p,id:"createSrAdv"}]});var i=new Ext.grid.CheckboxSelectionModel();var k=new Ext.grid.ColumnModel([i,{header:"资源编码",dataIndex:"fileId"},{header:"资源名称",width:250,dataIndex:"fileName"},{header:"资源类型",width:120,dataIndex:"type",renderer:function(R){var S=u.find("valId",R,0,false,false);return(S<0)?"":u.getAt(S).data.val}},{header:"描述",dataIndex:"fileDesc",id:"fileDesc"},{header:"创建者",dataIndex:"fileCreator"},{header:"上传时间",width:120,dataIndex:"fileUploadtime"},{header:"图片链接",width:120,dataIndex:"linkUrl"}]);k.defaultSortable=true;var a=[{name:"fileId"},{name:"fileName"},{name:"type"},{name:"fileDesc"},{name:"fileCreator"},{name:"fileUploadtime"},{name:"linkUrl"}];var n=new ufgov.portal.Base();var d=n.getInitDs(a,"asService.getListPage_AsUpload","conditions,start,limit,sort,dir");d.on("beforeload",function(){n.showSaveProgressBar("正在装载/刷新数据...")});Ext.Ajax.on("requestcomplete",function(T,R,S){n.hideSaveProgressBar()});var f=10;var I=new Ext.PagingToolbar({pageSize:f,store:d,displayInfo:true,displayMsg:"显示第 {0} 条到 {1} 条数据，共 {2} 条",emptyMsg:"没有数据",items:["-",{tooltip:"刪除",iconCls:"new-tab",icon:"/style/img/gp5/ico/delete_style_g.jpg",handler:J},{tooltip:"新增",iconCls:"new-tab",icon:"/style/img/gp5/ico/add_g.jpg",handler:function(){e(null)}},"-",{tooltip:"发布",iconCls:"new-tab",icon:"/style/img/gp5/ico/show_instance_trace_g.jpg",handler:c}]});function h(T,V,W){var S=document.getElementById("mainFrame");var R=640;var X=700;if(S){R=S.contentDocument?S.offsetHeight:(S.document?S.scrollHeight-10:R)}if(W&&S){X=S.contentDocument?S.offsetWidth:(S.document?S.scrollWidth:X);x.el.setWidth(X-10)}var U=0;if("tabSrFast"==x.getActiveTab().id){U=o.el.getSize().height;T.width=o.el.getSize().width}else{U=D.el.getSize().height;T.width=D.el.getSize().width}if(V){T.setWidth(x.el.getSize().width);T.setHeight(R-U-50);T.syncSize()}else{T.width=x.el.getSize().width;T.height=R-U-50;T.render()}}grid=new Ext.grid.EditorGridPanel({el:"uploadContent",ds:d,cm:k,sm:i,autoExpandColumn:"fileDesc",resizable:true,bbar:I});h(grid,false);window.onresize=function(){h(grid,true)};x.on("tabchange",function(S,R){h(grid,true)});x.on("collapse",function(R){h(grid,true)});x.on("expand",function(R){h(grid,true)});Ext.getCmp("mainFrame").on("resize",function(){h(grid,true,true)});function m(){d.baseParams.limit=f;var S=new Object();for(nn=0;nn<o.items.get(0).items.length;nn++){for(jj=0;jj<o.items.get(0).items.get(nn).items.length;jj++){var R=o.items.get(0).items.get(nn).items.items[jj];if(""!=R.getValue()){S[R.name]=R.getValue()}}}if("sa"!=H){S.fileCreator=H}d.baseParams.conditions=Ext.util.JSON.encode(S);var T=new Object();T.start=0;d.load({params:T})}function M(){alert("onSearchAdv")}function p(){showWin("高级搜索",context_g+"/jsp/platform/searchPage.jsp?componame=AS_PORTLET&pageType=listPage")}function J(S,U){var T=grid.getSelectionModel();var R=T.getSelected();if(R==null){return}Ext.Msg.confirm("系統提示","确认删除吗?(注意,这个物理删除的动作！)",function(V){if(V!="yes"){return}grid.stopEditing();d.remove(R);grid.startEditing(0,0)})}var b=new Ext.form.TextField({fieldLabel:"资源编码",name:"fileIdE",readOnly:true,style:"background:orange",maxlength:10,width:255});var g=new Ext.form.TextField({fieldLabel:"资源描述",maxlength:25,name:"fileDescE",hasFocus:true,allowBlank:false,width:255});var Q=new Ext.form.Field({fieldLabel:"附件",name:"fileDescE",hasFocus:true,width:120,value:"下载该文件",inputType:"button"});var s=new Ext.form.FileUploadField({fieldLabel:"附件",name:"fileE",id:"fileE",buttonText:"浏览...",width:255});var t=new Ext.form.FieldSet({title:"",layout:"table",border:false,width:350,id:"fieldSetFile"});var O=new Ext.form.TextField({fieldLabel:"资源名称",name:"fileNameE",readOnly:true,style:"background:orange",maxlength:10,width:255});var K=new Ext.form.ComboBox({fieldLabel:"资源类型",store:u,valueField:"valId",displayField:"val",hiddenName:"typeE",typeAhead:true,mode:"local",triggerAction:"all",emptyText:"请选择资源类型",editable:false,width:235});var z=new Ext.form.TextField({fieldLabel:"图片链接",name:"linkUrl",maxlength:10,width:255});var q=new Ext.form.Field({name:"fileNameHidden",id:"fileNameHidden",inputType:"hidden"});grid.on("rowdblclick",function(S){var R=S.getSelectionModel().getSelected();if(!R){return}v(R.get("fileId"))});function v(R){n.showSaveProgressBar("正在查询,请稍候......");n.executeAjax(function(S){n.hideSaveProgressBar();if(S.fileId){e(S)}else{alert(S.msg)}},"asService.selectByPrimaryKey_AsUpload",new ufgov.portal.common.Param(R))}var P=null;var w=new Ext.form.FormPanel({id:"uploadform",renderTo:"divUploadEditor",title:"",labelAlign:"left",hideLabels:false,buttonAlign:"center",labelWidth:60,bodyStyle:"padding:15px 15px 0 ",border:true,frame:false,fileUpload:true,items:[{layout:"form",border:false}],buttons:[{text:"发布",handler:function(){var R=b.getValue();if(Boolean(R)){c(R)}else{alert("保存后才可以发布！")}}},{text:"保存",handler:function(){if(Ext.isEmpty(g.getValue())){alert("文件描述不能为空!");g.focus(false);return}Ext.Msg.confirm("系統提示","确认上传该资源吗?(建议资源文件大小不要超过10M！)",function(R){if(R!="yes"){return}G()})}},{text:"关闭",handler:function(){P.hide();P=null}}]});w.items.get(0).items.add(b);w.items.get(0).items.add(O);w.items.get(0).items.add(K);w.items.get(0).items.add(g);w.items.get(0).items.add(z);w.items.get(0).items.add(Q);w.items.get(0).items.add(s);w.items.get(0).items.add(q);w.render();s.on("fileselected",function(){if(Ext.isEmpty(g.getValue())){var S=q.getValue();S=s.getValue();var R=S.lastIndexOf("\\");g.setValue(S.substring(R+1))}});function e(R){b.setValue(R==null?"":R.fileId);s.reset();g.setValue(R==null?"":R.fileDesc);O.setValue(R==null?null:R.fileName);K.setValue(R==null?null:R.type);s.setVisible(!Boolean(R)||!Boolean(R.fileId));Q.setVisible(R!=null&&R.fileId!=null);Q.getEl().up(".x-form-item").setDisplayed(R!=null&&R.fileId!=null);s.getEl().up(".x-form-item").setDisplayed(R==null||R.fileId==null);P=new Ext.Window({title:"上传资源窗口",xtype:"window",layout:"fit",modal:"true",width:400,height:260,closeAction:"hide",items:[Ext.getCmp("uploadform")]});P.show()}function J(R,U){var T=grid.getSelectionModel();var S=T.getSelections();if(S.length==0){alert("请选择要删除的资源");return}Ext.Msg.confirm("系統提示","确认删除吗?(注意,该删除不可恢复！)",function(X){if(X!="yes"){return}var Y=[];for(var W=0;W<S.length;W++){var V=S[W];Y.push(V.get("fileId"))}n.showSaveProgressBar("正在删除中，请稍候...");n.executeAjax(function(ab){n.hideSaveProgressBar();alert(ab.message);if(ab.ret){for(var aa=0;aa<S.length;aa++){var Z=S[aa];d.remove(Z)}}},"asService.delAsUploadByIds",new ufgov.portal.common.Param(Y,"0:java.lang.Long"))})}Q.getEl().on("click",function(){var R=document.createElement("form");var S=document.createElement("input");S.name="fileid";S.type="text";S.value=b.getValue();R.action=path+"/fileDownload.action";R.target="_blank";document.documentElement.appendChild(R);R.appendChild(S);R.submit();document.documentElement.removeChild(R)});function G(){var S=q.getValue();if(Q.isVisible()){s.setValue("");q.setValue("")}else{S=s.getValue();var R=S.lastIndexOf("\\");q.setValue(encodeURIComponent(S.substring(R+1)));if(!S){alert("文件不存在!");s.focus(false);return}}n.showSaveProgressBar("保存过程中，请稍候...");w.getForm().submit({url:path+"/uploadSaveAction.action",success:function(T,U){n.hideSaveProgressBar();if(!U||!U.result){alert("保存失败,可能上传的文件不符合要求！");return false}alert(U.result.msg);if(!U.result.fileId){return}if(b.getValue()){d.load()}b.setValue(U.result.fileId);if(Boolean(U.result.fileId)){Q.setVisible(true);Q.getEl().up(".x-form-item").setDisplayed(true);s.getEl().up(".x-form-item").setDisplayed(false);s.reset();O.setValue(U.result.fileName)}},failure:function(){n.hideSaveProgressBar();alert("系统错误，操作失败,可能上传的文件不符合要求！")}})}var L=null;var l=null;var N=null;function c(T){N=[];var R="";if(typeof T=="string"||typeof T=="number"){R=K.getValue();N.push(T)}else{var Y=grid.getSelectionModel().getSelections();R=Y[0].get("type");for(var U=0;U<Y.length;U++){var W=Y[U];if(R!=W.get("type")){alert("请您选择单一类型的资源发布！");return}N.push(W.get("fileId"))}}if(N.length==0){alert("请选择要发布的资源");return}function Z(aa,ac,ab){if(Boolean(ab.msg)){alert(ab.msg);return}ac.beginUpdate();for(ii=0;ii<ab.length;ii++){var ad=aa.createNode(ab[ii]);if(ad){if(ab[ii].pgPletIdFlag){if(!S(ab[ii])){continue}ad.checkModel="multiple";ad.checkStyle="checkbox";ad.attributes.checked=ab[ii].portletCheck;ad.on("checkchange",function(){var ae=ad.parentNode;while(ae!=L.root){if(ae.checkStyle=="radio"){ae.getUI().toggleCheck(true)}ae=ae.parentNode}})}else{if(ac==L.root){ad.checkModel="multiple";ad.checkStyle="radio"}}ac.appendChild(ad)}}ac.endUpdate()}function S(aa){if("03"==R){return"educationOnLine"==aa.portletId}else{if("02"==R){return"sysPicture"==aa.portletId}else{return true}}}var V=N.length==1?N[0]:"";L=new Ext.tree.TreePanel({id:"portlet_treePanel",header:false,border:false,autoScroll:true,split:true,singleExpand:false,useArrows:true,height:500,hideCollapseTool:true,tools:[{id:"refresh",handler:function(ac,ab,aa){}}],loader:n.getCustomTreeLoader(Z,"apService.getApPagePortletBeans","node,articleFileId,portletType,menuId,compoId,userId",new ufgov.portal.common.Param(V,"","articleFileId"),new ufgov.portal.common.Param("03","","portletType"),new ufgov.portal.common.Param("","","menuId"),new ufgov.portal.common.Param("","","compoId"),new ufgov.portal.common.Param(document.getElementById("svUserId").getAttribute("value"),"","userId")),rootVisible:false,root:new Ext.tree.AsyncTreeNode({id:"0",text:"全部"})});function X(ad,ae,aa){var ac=[];if((!ae||ad.isLeaf())&&ad.getUI().isChecked()&&ad.checkStyle!="radio"){ac.push(ad)}if(!ad.isLeaf()){for(var ab=0;ab<ad.childNodes.length;ab++){if(!aa||ad.childNodes[ab].checkStyle=="radio"&&ad.childNodes[ab].getUI().isChecked()){ac=ac.concat(X(ad.childNodes[ab],ae,false))}}}return ac}l=new Ext.Window({title:"资源发布取消发布频道",xtype:"window",layout:"fit",modal:"true",width:450,height:450,closeAction:"close",bodyStyle:"padding:5 5 0 5;",items:[L],buttons:[{text:"保存",handler:function(){var aa=[];for(var ab=0;ab<L.root.childNodes.length;ab++){if(L.root.childNodes[ab].attributes.checked){aa=aa.concat(L.root.childNodes[ab].attributes.id)}}if(aa.length==0){alert("至少选中一个用户组！");return}var ac=X(L.root,true,true);Ext.Msg.confirm("系統提示",ac.length==0?"没有选中频道,确认取消发布这些选择的资源吗?":"确认发布这些选择的资源到选中的频道吗(注意，以前在选中频道发布的资源将无效)?",function(ad){if(ad!="yes"){return}r(N,aa,ac)})}},{text:"返回",handler:function(){l.hide()}}]});l.show()}function r(S,R,W){var V=[];for(var T=0;T<W.length;T++){var U=W[T];V.push(U.attributes.parentId);V.push(U.attributes.id);V.push(U.attributes.portletId)}n.showSaveProgressBar("正在发布/取消中，请稍候...");n.executeAjax(function(X){n.hideSaveProgressBar();alert(X.message)},"apService.updatePublishUpload",new ufgov.portal.common.Param(S,"0:java.lang.String"),new ufgov.portal.common.Param(R,"0:java.lang.String"),new ufgov.portal.common.Param(V,"0:java.lang.String"))}m()});