Ext.onReady(function(){var j=new ufgov.portal.Base();var e=new Ext.TabPanel({renderTo:"portletSearch",collapsible:true,activeTab:0,resizable:true,autoWidth:true,items:[{contentEl:"divPortletFast",title:"搜索",id:"tabSrFast"},{contentEl:"divPortletAdv",title:"高级搜索",id:"tabSrAdv"}]});e.remove("tabSrAdv");var s=new Ext.form.FormPanel({id:"frmSrFast",renderTo:"divPortletFast",title:"",hideLabels:false,buttonAlign:"center",labelAlign:"right",labelWidth:70,border:false,frame:false,items:[{layout:"column",bodyStyle:"padding:3px 3px 3px 3px;border:1px solid;border-width:0 0 1 0",items:[{columnWidth:0.5,layout:"form",border:false},{columnWidth:0.5,layout:"form",border:false}]}],buttons:[{text:"搜索",handler:k},{text:"重置",handler:p}]});var c=new Ext.form.TextField({fieldLabel:"频道编号",width:180,name:"portletId"});var b=new Ext.form.TextField({fieldLabel:"频道名称",width:180,name:"portletName"});var F=new Ext.form.TextField({fieldLabel:"频道URL",width:180,name:"portletUrl"});var E=new Ext.form.TextField({fieldLabel:"频道描述",width:180,name:"portletDesc"});var u=[{name:"valId"},{name:"val"}];var C=j.getDs(u,"asService.getListByValsetId_AsVal","valsetId",new ufgov.portal.common.Param("VS_AP_PORTLET_TYPE","","valsetId"));var D=new Ext.form.ComboBox({fieldLabel:"频道类型",width:180,store:C,valueField:"valId",displayField:"val",typeAhead:true,name:"portletType",mode:"local",triggerAction:"all",editable:false,emptyText:"请选择频道类型"});s.items.get(0).items.get(0).items.add(c);s.items.get(0).items.get(1).items.add(b);s.items.get(0).items.get(0).items.add(F);s.items.get(0).items.get(1).items.add(E);s.items.get(0).items.get(0).items.add(D);s.doLayout();function p(){for(nn=0;nn<s.items.get(0).items.length;nn++){for(jj=0;jj<s.items.get(0).items.get(nn).items.length;jj++){var G=s.items.get(0).items.get(nn).items.items[jj];G.setValue("")}}}var v=new Ext.form.FormPanel({id:"fmSrAdv",renderTo:"divPortletAdv",title:"",hideLabels:false,height:80,buttonAlign:"center",labelAlign:"right",labelWidth:40,frame:false,hideLabels:true,bodyStyle:"padding:5 5 5 5;",items:[{xtype:"radio",boxLabel:"新增 ",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",checked:true,anchor:"45%"},{xtype:"radio",boxLabel:"高级搜索1",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",anchor:"45%"},{xtype:"radio",boxLabel:"高级搜索6",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",anchor:"45%"}],buttons:[{text:"搜索",handler:n,id:"execSrAdv"},{text:"设计",handler:m,id:"createSrAdv"}]});var x=new Ext.form.ComboBox({store:C,valueField:"valId",displayField:"val",typeAhead:true,mode:"local",triggerAction:"all",editable:false,emptyText:"请选择频道类型"});var g=new Ext.form.Checkbox({fieldLabel:"Active",name:"ckIsSystem",value:"Y"});var l=new Ext.form.ComboBox({store:new Ext.data.SimpleStore({fields:["key","val"],data:[["Y","是"],["N","否"]]}),valueField:"key",displayField:"val",typeAhead:true,mode:"local",triggerAction:"all",editable:false,emptyText:"请选择..."});var B=new Ext.grid.CheckboxSelectionModel();var o=new Ext.grid.ColumnModel([B,{header:"频道编号",dataIndex:"portletId",id:"portletId",editor:new Ext.grid.GridEditor(new Ext.form.TextField({allowBlank:false,listeners:{beforestartedit:function(H,G,I){if(I.length>0){return false}}},maxLength:25}))},{header:"频道名称",dataIndex:"portletName",editor:new Ext.grid.GridEditor(new Ext.form.TextField({allowBlank:false,maxLength:25}))},{header:"频道URL",dataIndex:"portletUrl",id:"portletUrl",editor:new Ext.grid.GridEditor(new Ext.form.TextField({allowBlank:false,maxLength:50}))},{header:"频道描述",dataIndex:"portletDesc",id:"portletDesc",editor:new Ext.grid.GridEditor(new Ext.form.TextField({allowBlank:false,maxLength:250}))},{header:"频道类型",dataIndex:"portletType",id:"portletType",editor:x,renderer:function(G){var H=C.find("valId",G,0,false,false);return(H<0)?"":C.getAt(H).data.val}},{header:"数据抽取类",dataIndex:"portletClass",editor:new Ext.grid.GridEditor(new Ext.form.TextField({allowBlank:false,maxLength:100}))},{header:"MORE页面URL",dataIndex:"portletMoreUrl",editor:new Ext.grid.GridEditor(new Ext.form.TextField({allowBlank:false,maxLength:50}))},{header:"DETAIL页面URL",dataIndex:"portletDetailUrl",editor:new Ext.grid.GridEditor(new Ext.form.TextField({allowBlank:false,maxLength:50}))},{header:"是否系统预置",dataIndex:"isSystem",renderer:function(G){return(G=="y"||G=="Y")?"是":"否"}}]);o.defaultSortable=true;var f=[{name:"id"},{name:"portletId"},{name:"portletName"},{name:"portletUrl"},{name:"portletDesc"},{name:"portletType"},{name:"portletClass"},{name:"portletMoreUrl"},{name:"portletDetailUrl"},{name:"isSystem"}];var r=j.getInitDs(f,"apService.getListPage_ApPortlet","conditions,start,limit,sort,dir");r.on("beforeload",function(){if(r.modified.length>0){var G=confirm("数据被修改，确认继续操作吗?");if(G){r.modified.length=0}else{return false}}j.showSaveProgressBar("正在装载/刷新数据...")});Ext.Ajax.on("requestcomplete",function(I,G,H){j.hideSaveProgressBar()});var A=10;var z=new Ext.PagingToolbar({pageSize:A,store:r,displayInfo:true,displayMsg:"显示第 {0} 条到 {1} 条数据，共 {2} 条",emptyMsg:"没有数据",items:["-",{tooltip:"刪除",iconCls:"new-tab",icon:"/style/img/gp5/ico/delete_style_g.jpg",handler:y},{tooltip:"新增",iconCls:"new-tab",icon:"/style/img/gp5/ico/add_g.jpg",handler:h},{tooltip:"保存",iconCls:"new-tab",icon:"/style/img/gp5/ico/commit_w.jpg",handler:w}]});function q(I,K,L){var H=document.getElementById("mainFrame");var G=640;var M=700;if(H){G=H.contentDocument?H.offsetHeight:(H.document?H.scrollHeight-10:G)}if(L&&H){M=H.contentDocument?H.offsetWidth:(H.document?H.scrollWidth:M);e.el.setWidth(M-10)}var J=0;if("tabSrFast"==e.getActiveTab().id){J=s.el.getSize().height;I.width=s.el.getSize().width}else{J=v.el.getSize().height;I.width=v.el.getSize().width}if(K){I.setWidth(e.el.getSize().width);I.setHeight(G-J-50);I.syncSize()}else{I.width=e.el.getSize().width;I.height=G-J-50;I.render()}}var a=new Ext.grid.EditorGridPanel({el:"portletContent",ds:r,cm:o,sm:B,autoExpandColumn:"portletDesc",resizable:true,bbar:z});q(a,false);window.onresize=function(){q(a,true)};e.on("tabchange",function(H,G){q(a,true)});e.on("collapse",function(G){q(a,true)});e.on("expand",function(G){q(a,true)});Ext.getCmp("mainFrame").on("resize",function(){q(a,true,true)});a.on("beforeedit",function(G){G.cancel=G.record.data.isSystem=="Y"||G.record.data.isSystem=="y";if(G.cancel||"portletId"!=G.field){return}return !Boolean(G.record.data.id)});function k(){r.baseParams.limit=A;var H=new Object();for(nn=0;nn<s.items.get(0).items.length;nn++){for(jj=0;jj<s.items.get(0).items.get(nn).items.length;jj++){var G=s.items.get(0).items.get(nn).items.items[jj];if(""!=G.getValue()){H[G.name]=G.getValue()}}}r.baseParams.conditions=Ext.util.JSON.encode(H);var I=new Object();I.start=0;r.load({params:I})}var d=Ext.data.Record.create([{name:"id",type:"int"},{name:"portletId",type:"String"},{name:"portletName",type:"String"},{name:"portletUrl",type:"String"},{name:"portletDesc",type:"String"},{name:"portletType",type:"String"},{name:"portletClass",type:"String"},{name:"portletMoreUrl",type:"String"},{name:"portletDetailUrl",type:"String"},{name:"isSystem",type:"String"},{name:"oper_type",type:"String"}]);function n(){alert("onSearchAdv")}function m(){showWin("高级搜索",context_g+"/jsp/platform/searchPage.jsp?componame=AS_PORTLET&pageType=listPage")}function h(J,M){var G={oper_type:"add",portletId:"",portletName:"",portletUrl:"",portletDesc:"",portletType:"",portletClass:"",portletMoreUrl:"",portletDetailUrl:"",isSystem:"N"};var K=a.getSelectionModel();var L=0;var I=K.getSelected();L=I==null?0:a.store.indexOf(I);var H=new d(G);a.stopEditing();r.insert(L,H);var N=a.colModel.getIndexById("portletId");if(a.colModel.isHidden(N)){a.colModel.setHidden(N,false)}a.startEditing(L,N);H.dirty=true;H.modified=G;if(r.modified.indexOf(H)==-1){r.modified.push(H)}K.selectRow(L,true)}function y(G,J){var I=a.getSelectionModel();var H=I.getSelections();if(H.length==0){alert("请选择要删除的数据");return}Ext.Msg.confirm("系統提示","确认删除吗?\n(注意,这个客户端删除的动作,数据没有正式提交！)",function(M){if(M!="yes"){return}var N=0;a.stopEditing();for(var L=0;L<H.length;L++){var K=H[L];if(K.data.isSystem=="Y"||K.data.isSystem=="y"){N++;continue}K.data.oper_type="del";if(r.modified.indexOf(K)==-1){r.modified.push(K)}r.remove(K)}a.startEditing(0,1);if(N>0){alert("提示:有"+N+"条数据系统不允许删除!")}})}function w(I,L){var G=r.modified.slice(0);var J=[];var H=[];var M=[];var K=false;Ext.each(G,function(N){if(N.data.oper_type=="add"){if(N.data.portletId==""){alert("频道编号不能为空");var O=a.colModel.getIndexById("portletId");if(a.colModel.isHidden(O)){a.colModel.setHidden(O,false)}a.startEditing(a.store.indexOf(N),O);K=true;return false}H.push(N.data)}else{if(N.data.oper_type=="del"){if(N.data.id){J.push(N.data)}}else{if(N.data.portletId==""){alert("频道编号不能为空");var O=a.colModel.getIndexById("portletId");if(a.colModel.isHidden(O)){a.colModel.setHidden(O,false)}a.startEditing(a.store.indexOf(N),O);K=true;return false}M.push(N.data)}}});if(K){return}if(H.length+M.length+J.length==0){alert("你没有对数据做任何变动,不需要要保存!");return}Ext.Msg.confirm("系統提示","你新增"+H.length+"条数据,编辑"+M.length+"条数据,删除"+J.length+"条数据。确认这些操作吗?",function(N){if(N!="yes"){return}j.showSaveProgressBar();j.executeAjax(function(R){j.hideSaveProgressBar();alert(R.message);if(R.ret){var Q=(R.insertIds).split(",");var O=0;for(i=0,cnt=r.getCount();i<cnt;i+=1){var P=r.getAt(i);if(P.data.oper_type=="add"){P.data.id=Q[O];O++}P.data.oper_type="";P.dirty=false}r.pruneModifiedRecords=true;r.modified=[];a.view.refresh()}},"apService.savePortlet",new ufgov.portal.common.Param(H,"0:com.ufgov.portal.tools.ap.domain.ApPortlet"),new ufgov.portal.common.Param(J,"0:com.ufgov.portal.tools.ap.domain.ApPortlet"),new ufgov.portal.common.Param(M,"0:com.ufgov.portal.tools.ap.domain.ApPortlet"))})}Ext.override(Ext.grid.RowSelectionModel,{onEditorKey:function(L,K){var I=K.getKey(),M,J=this.grid,H=J.activeEditor;var G=K.shiftKey;if(I==K.ENTER){K.stopEvent();H.completeEdit();if(G){M=J.walkCells(H.row,H.col-1,-1,this.acceptsNav,this)}else{M=J.walkCells(H.row,H.col+1,1,this.acceptsNav,this)}}else{if(I==K.TAB){K.stopEvent();H.completeEdit();if(this.moveEditorOnEnter!==false){if(G){M=J.walkCells(H.row-1,H.col,-1,this.acceptsNav,this)}else{M=J.walkCells(H.row+1,H.col,1,this.acceptsNav,this)}}}else{if(I==K.ESC){H.cancelEdit()}}}if(M){J.startEditing(M[0],M[1])}}});var t=new Ext.grid.RowSelectionModel({moveEditorOnEnter:true,singleSelect:true,listeners:{rowselect:function(I,H,G){centerForm.getForm().loadRecord(G)}}});k()});