ufgov.portal.system.PageTemplate=Ext.extend(Ext.Panel,{layout:"column",autoScroll:true,cls:"x-portal",defaultType:"tempcolumn",initComponent:function(){ufgov.portal.system.PageTemplate.superclass.initComponent.call(this);this.addEvents({validatedrop:true,beforedragover:true,dragover:true,beforedrop:true,drop:true})},initEvents:function(){ufgov.portal.system.PageTemplate.superclass.initEvents.call(this);this.dd=new ufgov.portal.system.PageTemplate.DropZone(this,this.dropConfig);this.idArray=new Array();this.portletIdArray=new Array();this.textArray=new Array();this.nameArray=new Array();this.typeArray=new Array();this.indexArray=new Array();this.colArray=new Array();this.isChanged=new Array();this.isExist=new Array();this.titleFontSize=new Array();this.titleFont=new Array();this.titleFontColor=new Array();this.titleBgColor=new Array();this.titleBgImg=new Array();this.contentFont=new Array();this.contentFontSize=new Array();this.portletBorder=new Array();this.contentBgColor=new Array();this.contentFontColor=new Array();this.contentBgImg=new Array();this.recordSize=new Array();this.portletHeight=new Array();this.colNo=new Array();this.rowNo=new Array();this.tabIndex=new Array();this.colRatio=new Array();this.tabSign=new Array()},beforeDestroy:function(){if(this.dd){this.dd.unreg()}ufgov.portal.system.PageTemplate.superclass.beforeDestroy.call(this)},getSerialNoById:function(c){var a=-1;for(var b=0;b<this.idArray.length;b++){if(this.idArray[b]==c){a=b;break}}return a}});Ext.reg("pageTemp",ufgov.portal.system.PageTemplate);ufgov.portal.system.PageTemplate.DropZone=function(a,b){this.portal=a;Ext.dd.ScrollManager.register(a.body);ufgov.portal.system.PageTemplate.DropZone.superclass.constructor.call(this,a.bwrap.dom,b);a.body.ddScrollConfig=this.ddScrollConfig};Ext.extend(ufgov.portal.system.PageTemplate.DropZone,Ext.dd.DropTarget,{ddScrollConfig:{vthresh:50,hthresh:-1,animate:true,increment:200},ddGroup:"tempDDGroup",createEvent:function(a,f,d,b,h,g){return{portal:this.portal,panel:d.panel,columnIndex:b,column:h,position:g,data:d,source:a,rawEvent:f,status:this.dropAllowed}},notifyEnter:function(a,c,b){this.portal.body.stopFx();this.portal.body.highlight()},notifyOver:function(u,s,v){var f=s.getXY(),a=this.portal,m=u.proxy;if(!this.grid){this.grid=this.getGrid()}var b=a.body.dom.clientWidth;if(!this.lastCW){this.lastCW=b}else{if(this.lastCW!=b){this.lastCW=b;a.doLayout();this.grid=this.getGrid()}}var d=0,k=this.grid.columnX,l=false;for(var q=k.length;d<q;d++){if(f[0]<(k[d].x+k[d].w)){l=true;break}}if(!l){d--}var o,j=false,i=0,t=a.items.itemAt(d),n=t.items.items;for(var q=n.length;i<q;i++){o=n[i];var r=o.el.getHeight();if(r!==0&&(o.el.getY()+(r/2))>f[1]){j=true;break}}var g=this.createEvent(u,s,v,d,t,j&&o?i:t.items.getCount());if(a.fireEvent("validatedrop",g)!==false&&a.fireEvent("beforedragover",g)!==false){this.lastPos={c:t,col:d,p:j&&o?i:false};this.scrollPos=a.body.getScroll();a.fireEvent("dragover",g);return g.status}else{return g.status}},notifyOut:function(){delete this.grid},notifyDrop:function(n,g,f){delete this.grid;if(!this.lastPos){return}var l=this.portal;var m=new ufgov.portal.system.PagePortlet({title:n.dragData.node.text,id:new Date().getTime(),tools:[{id:"gear",qtip:"修改频道标题",handler:function(r,q,c){var d=new Ext.Window({title:"修改频道标题",width:600,height:530,layout:"fit",closable:false,defaults:{bodyStyle:"padding:5px"},border:true,items:new Ext.form.FormPanel({border:false,id:"modifyNode",layout:"table",defaults:{bodyStyle:"padding:5px"},layoutConfig:{columns:2},buttonAlign:"center",items:[{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"频道标题",labelStyle:"text-align:right",name:"portletTitle",value:c.title,width:150}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"标题字体大小",labelStyle:"text-align:right",name:"titleFontSize",width:150}]},{border:false,layout:"form",items:[{xtype:"combo",fieldLabel:"标题字体",labelStyle:"text-align:right",store:new Ext.data.SimpleStore({autoLoad:true,data:[["Arial","Arial"],["Arial Black","Arial Black"],["Comic Sans Ms","Comic Sans Ms"],["Times New Roman","Times New Roman"],["宋体","宋体"],["黑体","黑体"],["楷体","楷体"],["篆体","篆体"]],fields:["titleFont","showName"]}),id:"titleFontCombo",displayField:"showName",valueField:"titleFont",hiddenName:"titleFont",typeAhead:true,mode:"local",editable:false,triggerAction:"all",emptyText:"请选择...",value:"宋体",width:150,height:30,selectOnFocus:true}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"标题字体颜色",labelStyle:"text-align:right",name:"titleFontColor",width:150,listeners:{focus:function(e){colordialog(e.el.getX(),e.el.getY())}}}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"标题背景",labelStyle:"text-align:right",name:"titleBgColor",width:150,listeners:{focus:function(e){colordialog(e.el.getX(),e.el.getY())}}}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"标题背景图片",labelStyle:"text-align:right",name:"titleBgImg",width:150}]},{border:false,layout:"form",items:[{xtype:"combo",fieldLabel:"内容字体",labelStyle:"text-align:right",store:new Ext.data.SimpleStore({autoLoad:true,data:[["Arial","Arial"],["Arial Black","Arial Black"],["Comic Sans Ms","Comic Sans Ms"],["Times New Roman","Times New Roman"],["宋体","宋体"],["黑体","黑体"],["楷体","楷体"],["篆体","篆体"]],fields:["contentFont","showName"]}),id:"contentFontCombo",displayField:"showName",valueField:"contentFont",hiddenName:"contentFont",typeAhead:true,mode:"local",editable:false,triggerAction:"all",emptyText:"请选择...",value:"宋体",width:150,height:30,selectOnFocus:true}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"内容字体大小",labelStyle:"text-align:right",name:"contentFontSize",width:150}]},{border:false,layout:"form",items:[{xtype:"combo",fieldLabel:"有无边界",labelStyle:"text-align:right",store:new Ext.data.SimpleStore({autoLoad:true,data:[["0","无"],["1","有"]],fields:["portletBorder","showName"]}),id:"borderCombo",displayField:"showName",valueField:"portletBorder",hiddenName:"portletBorder",typeAhead:true,mode:"local",editable:false,triggerAction:"all",emptyText:"请选择...",value:"0",width:150,height:30,selectOnFocus:true}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"内容背景颜色",labelStyle:"text-align:right",name:"contentBgColor",width:150,listeners:{focus:function(e){colordialog(e.el.getX(),e.el.getY())}}}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"内容字体颜色",labelStyle:"text-align:right",name:"contentFontColor",width:150,listeners:{focus:function(e){colordialog(e.el.getX(),e.el.getY())}}}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"内容背景图片",labelStyle:"text-align:right",name:"contentBgImg",width:150}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"页面显示记录",labelStyle:"text-align:right",name:"recordSize",value:"5",width:150}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"频道固定高度",labelStyle:"text-align:right",name:"portletHeight",value:"",width:150}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"列索引",labelStyle:"text-align:right",name:"colNo",value:"0",width:150}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"行索引",labelStyle:"text-align:right",name:"rowNo",value:"",width:150}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"页签号",labelStyle:"text-align:right",name:"tabIndex",value:"",width:150}]},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"页签标识",labelStyle:"text-align:right",name:"tabSign",value:"",width:150}]},{border:false,colspan:2,html:"<font color=#ff0000>*注意：以上两项只在使用页签时设置！页签号为页签显示时顺序，页签标示表示属于哪个页签。</font>"},{border:false,layout:"form",items:[{xtype:"textfield",fieldLabel:"宽度比率",labelStyle:"text-align:right",name:"colRatio",value:"1",width:150}]},{border:false,html:"<font color=#ff0000>*注意：只在频道需要不规则宽度时设置，为小数形式！</font>"},{border:false,colspan:2,html:"<font color=#ff0000>重要提示：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;页面信息填完并点击“确定”按钮后，数据只是暂时缓存，并没有保存到数据库中，必须点击栏目内容定制右上角“保存”图标进行保存！！！</font>"}],buttons:[{xtype:"button",text:"确定",width:150,handler:function(){c.setTitle(Ext.get("portletTitle").dom.value);var e=l.getSerialNoById(c.id);l.textArray[e]=c.title;if(null==Ext.get("colNo").dom.value||""==Ext.get("colNo").dom.value){PageEdit.showMsg("温馨提示","列索引不能为空，请填写后保存！");return}l.titleFontSize[e]=Ext.get("titleFontSize").dom.value;l.titleFont[e]=Ext.get("titleFont").dom.value;l.titleFontColor[e]=Ext.get("titleFontColor").dom.value;l.titleBgColor[e]=Ext.get("titleBgColor").dom.value;l.titleBgImg[e]=Ext.get("titleBgImg").dom.value;l.contentFont[e]=Ext.get("contentFont").dom.value;l.contentFontSize[e]=Ext.get("contentFontSize").dom.value;l.portletBorder[e]=Ext.get("portletBorder").dom.value;l.contentBgColor[e]=Ext.get("contentBgColor").dom.value;l.contentFontColor[e]=Ext.get("contentFontColor").dom.value;l.contentBgImg[e]=Ext.get("contentBgImg").dom.value;l.recordSize[e]=Ext.get("recordSize").dom.value;l.portletHeight[e]=Ext.get("portletHeight").dom.value;l.colNo[e]=Ext.get("colNo").dom.value;l.rowNo[e]=Ext.get("rowNo").dom.value;l.tabIndex[e]=Ext.get("tabIndex").dom.value;l.colRatio[e]=Ext.get("colRatio").dom.value;l.tabSign[e]=Ext.get("tabSign").dom.value;if(l.isExist[e]=="1"){l.isChanged[e]="2"}else{l.isChanged[e]="1"}d.close()}},{xtype:"button",text:"取消",width:150,handler:function(){if("0"==Ext.get("colNo").dom.value){PageEdit.showMsg("温馨提示","列索引默认取值为0，请确认！")}d.close()}}]})});d.show();d.center()}},{id:"close",handler:function(s,r,c){c.ownerCt.remove(c,true);var d=l.getSerialNoById(c.id);var q=new Ext.tree.TreeNode({id:c.id,text:l.nameArray[d],leaf:true});l.isChanged[d]="3"}}]});var i=this.lastPos.c,b=this.lastPos.col,k=this.lastPos.p;var j=k!==false?k:i.items.getCount();var a=this.createEvent(n,g,f,b,i,j);if(this.portal.fireEvent("validatedrop",a)!==false&&this.portal.fireEvent("beforedrop",a)!==false){if(k!==false){i.insert(k,m)}else{i.add(m)}i.doLayout();var p=l.getSerialNoById(m.id);if(p==-1){this.portal.idArray[this.portal.idArray.length]=m.id;this.portal.portletIdArray[this.portal.portletIdArray.length]=n.dragData.node.id;this.portal.textArray[this.portal.textArray.length]=n.dragData.node.text;this.portal.nameArray[this.portal.nameArray.length]=n.dragData.node.text;this.portal.indexArray[this.portal.indexArray.length]=j;this.portal.colArray[this.portal.colArray.length]=b;this.portal.isChanged[this.portal.isChanged.length]="1";this.portal.isExist[this.portal.isExist.length]="0";this.portal.titleFontSize[this.portal.titleFontSize.length]="";this.portal.titleFont[this.portal.titleFont.length]="";this.portal.titleFontColor[this.portal.titleFontColor.length]="";this.portal.titleBgColor[this.portal.titleBgColor.length]="";this.portal.titleBgImg[this.portal.titleBgImg.length]="";this.portal.contentFont[this.portal.contentFont.length]="";this.portal.contentFontSize[this.portal.contentFontSize.length]="";this.portal.portletBorder[this.portal.portletBorder.length]="";this.portal.contentBgColor[this.portal.contentBgColor.length]="";this.portal.contentFontColor[this.portal.contentFontColor.length]="";this.portal.contentBgImg[this.portal.contentBgImg.length]="";this.portal.recordSize[this.portal.recordSize.length]="";this.portal.portletHeight[this.portal.portletHeight.length]="";this.portal.colNo[this.portal.colNo.length]="0";this.portal.rowNo[this.portal.rowNo.length]="";this.portal.tabIndex[this.portal.tabIndex.length]="";this.portal.colRatio[this.portal.colRatio.length]="";this.portal.tabSign[this.portal.tabSign.length]=""}else{if(this.portal.isExist[p]=="1"){if(this.portal.idArray[p]==m.id&&this.portal.portletIdArray[p]==n.dragData.node.id&&this.portal.textArray[p]==n.dragData.node.text&&this.portal.indexArray[p]==j&&this.portal.colArray[p]==b){this.portal.isChanged[p]="0"}else{this.portal.idArray[p]=m.id;this.portal.portletIdArray[p]==n.dragData.node.id;this.portal.textArray[p]=n.dragData.node.text;this.portal.indexArray[p]=j;this.portal.colArray[p]=b;this.portal.isChanged[p]="2"}}else{this.portal.isChanged[p]="1";this.portal.idArray[p]=m.id;this.portal.portletIdArray[p]==n.dragData.node.id;this.portal.textArray[p]=n.dragData.node.text;this.portal.nameArray[p]=n.dragData.node.text;this.portal.indexArray[p]=j;this.portal.colArray[p]=b;this.portal.isExist[p]="0"}}var o=this.scrollPos.top;if(o){var h=this.portal.body.dom;setTimeout(function(){h.scrollTop=o},10)}}delete this.lastPos},getGrid:function(){var a=this.portal.bwrap.getBox();a.columnX=[];this.portal.items.each(function(b){a.columnX.push({x:b.el.getX(),w:b.el.getWidth()})});return a},unreg:function(){ufgov.portal.system.PageTemplate.DropZone.superclass.unreg.call(this)}});