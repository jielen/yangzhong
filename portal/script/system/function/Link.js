Ext.onReady(function(){var g=new ufgov.portal.Base();var c=new Ext.TabPanel({renderTo:"linkSearch",collapsible:true,activeTab:0,resizable:true,autoWidth:true,items:[{contentEl:"divLinkFast",title:"搜索",id:"tabSrFast"}]});var p=new Ext.form.FormPanel({id:"frmSrFast",renderTo:"divLinkFast",title:"",hideLabels:false,buttonAlign:"center",labelAlign:"right",labelWidth:70,border:false,frame:false,items:[{layout:"column",bodyStyle:"padding:3px 3px 3px 3px;border:1px solid;border-width:0 0 1 0",items:[{columnWidth:0.5,layout:"form",border:false},{columnWidth:0.5,layout:"form",border:false}]}],buttons:[{text:"搜索",handler:h},{text:"重置",handler:m}]});var b=new Ext.form.TextField({fieldLabel:"链接标题",name:"title"});var a=new Ext.form.TextField({fieldLabel:"链接图片",name:"img"});var x=new Ext.form.TextField({fieldLabel:"链接URL",name:"url"});p.items.get(0).items.get(0).items.add(b);p.items.get(0).items.get(1).items.add(a);p.items.get(0).items.get(0).items.add(x);p.doLayout();function m(){for(nn=0;nn<p.items.get(0).items.length;nn++){for(jj=0;jj<p.items.get(0).items.get(nn).items.length;jj++){var y=p.items.get(0).items.get(nn).items.items[jj];y.setValue("")}}}var r=new Ext.form.FormPanel({id:"fmSrAdv",renderTo:"divLinkAdv",title:"",hideLabels:false,height:80,buttonAlign:"center",labelAlign:"right",labelWidth:40,frame:false,hideLabels:true,bodyStyle:"padding:5 5 5 5;",items:[{xtype:"radio",boxLabel:"新增 ",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",checked:true,anchor:"45%"},{xtype:"radio",boxLabel:"高级搜索1",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",anchor:"45%"},{xtype:"radio",boxLabel:"高级搜索6",name:"rdSearchAdv",itemCls:"float1",clearCls:"allow-float",anchor:"45%"}],buttons:[{text:"搜索",handler:k,id:"execSrAdv"},{text:"设计",handler:j,id:"createSrAdv"}]});var w=new Ext.grid.CheckboxSelectionModel();var l=new Ext.grid.ColumnModel([w,{hidden:true,header:"链接顺序",dataIndex:"id",id:"id",editor:new Ext.grid.GridEditor(new Ext.form.NumberField({allowNegative:false}))},{header:"链接标题",dataIndex:"title",id:"title",editor:new Ext.grid.GridEditor(new Ext.form.TextField({allowBlank:false,maxLength:100}))},{header:"链接图片",dataIndex:"img",id:"img",editor:new Ext.grid.GridEditor(new Ext.form.TextField({allowBlank:true,maxLength:100}))},{header:"链接URL",dataIndex:"url",id:"url",editor:new Ext.grid.GridEditor(new Ext.form.TextField({allowBlank:false,maxLength:200}))},{header:"链接顺序",dataIndex:"ordIndex",id:"ordIndex",editor:new Ext.grid.GridEditor(new Ext.form.NumberField({allowNegative:false}))}]);l.defaultSortable=true;var e=[{name:"id"},{name:"title"},{name:"img"},{name:"url"},{name:"ordIndex"}];var o=g.getInitDs(e,"apService.getListPage_ApLink","conditions,start,limit,sort,dir");o.on("beforeload",function(){if(o.modified.length>0){var y=confirm("数据被修改，确认继续操作吗?");if(y){o.modified.length=0}else{return false}}g.showSaveProgressBar("正在装载刷新数据...")});Ext.Ajax.on("requestcomplete",function(A,y,z){g.hideSaveProgressBar()});var v=10;var u=new Ext.PagingToolbar({pageSize:v,store:o,displayInfo:true,displayMsg:"显示第 {0} 条到 {1} 条数据，共 {2} 条",emptyMsg:"没有数据",items:["-",{tooltip:"刪除",iconCls:"new-tab",icon:"/style/img/gp5/ico/delete_style_g.jpg",handler:t},{tooltip:"新增",iconCls:"new-tab",icon:"/style/img/gp5/ico/add_g.jpg",handler:f},{tooltip:"保存",iconCls:"new-tab",icon:"/style/img/gp5/ico/commit_w.jpg",handler:s}]});function n(A,C,D){var z=document.getElementById("mainFrame");var y=640;var E=700;if(z){y=z.contentDocument?z.offsetHeight:(z.document?z.scrollHeight-10:y)}if(D&&z){E=z.contentDocument?z.offsetWidth:(z.document?z.scrollWidth:E);c.el.setWidth(E-10)}var B=0;if("tabSrFast"==c.getActiveTab().id){B=p.el.getSize().height;A.width=p.el.getSize().width}else{B=r.el.getSize().height;A.width=r.el.getSize().width}if(C){A.setWidth(c.el.getSize().width);A.setHeight(y-B-50);A.syncSize()}else{A.width=c.el.getSize().width;A.height=y-B-50;A.render()}}grid=new Ext.grid.EditorGridPanel({el:"linkContent",ds:o,cm:l,sm:w,autoExpandColumn:"url",resizable:true,bbar:u});n(grid,false);window.onresize=function(){n(grid,true)};c.on("tabchange",function(z,y){n(grid,true)});c.on("collapse",function(y){n(grid,true)});c.on("expand",function(y){n(grid,true)});Ext.getCmp("mainFrame").on("resize",function(){n(grid,true,true)});function h(){o.baseParams.limit=v;var z=new Object();for(nn=0;nn<p.items.get(0).items.length;nn++){for(jj=0;jj<p.items.get(0).items.get(nn).items.length;jj++){var y=p.items.get(0).items.get(nn).items.items[jj];if(""!=y.getValue()){z[y.name]=y.getValue()}}}o.baseParams.conditions=Ext.util.JSON.encode(z);var A=new Object();A.start=0;o.load({params:A})}var d=Ext.data.Record.create([{name:"id",type:"int"},{name:"title",type:"String"},{name:"img",type:"String"},{name:"url",type:"String"},{name:"ordIndex",type:"int"}]);function k(){alert("onSearchAdv")}function j(){showWin("高级搜索",context_g+"/jsp/platform/searchPage.jsp?componame=AS_LINK&pageType=listPage")}function f(B,E){var y={oper_type:"add",id:"",title:"",img:"",url:"",ordIndex:""};var C=grid.getSelectionModel();var D=0;var A=C.getSelected();D=A==null?0:grid.store.indexOf(A);var z=new d(y);grid.stopEditing();o.insert(D,z);grid.startEditing(0,0);z.dirty=true;z.modified=y;if(o.modified.indexOf(z)==-1){o.modified.push(z)}C.selectRow(D,true)}function t(y,B){var A=grid.getSelectionModel();var z=A.getSelections();if(z.length==0){alert("请选择要删除的数据");return}Ext.Msg.confirm("系統提示","确认删除吗?\n(注意,这个客户端删除的动作,数据没有正式提交！)",function(E){if(E!="yes"){return}grid.stopEditing();for(var D=0;D<z.length;D++){var C=z[D];C.data.oper_type="del";if(o.modified.indexOf(C)==-1){o.modified.push(C)}s();o.remove(C)}grid.startEditing(0,0)})}function s(){var y=o.modified.slice(0);var A=[];var z=[];var C=[];var B=false;Ext.each(y,function(D){if(D.data.oper_type=="add"){if(""==D.data.title&&""==D.data.img){alert("链接标题和链接图片不能同时为空");var E=grid.colModel.getIndexById("id");if(grid.colModel.isHidden(E)){grid.colModel.setHidden(E,false)}grid.startEditing(grid.store.indexOf(D),E);B=true;return false}z.push(D.data)}else{if(D.data.oper_type=="del"){if(D.data.id){A.push(D.data)}}else{if(""==D.data.title&&""==D.data.img){alert("链接标题和链接图片不能同时为空");var E=grid.colModel.getIndexById("id");if(grid.colModel.isHidden(E)){grid.colModel.setHidden(E,false)}grid.startEditing(grid.store.indexOf(D),E);B=true;return false}C.push(D.data)}}});if(B){return}if(z.length+C.length+A.length==0){alert("你没有对数据做任何变动,不需要要保存!");return}Ext.Msg.confirm("系統提示","你新增"+z.length+"条数据,编辑"+C.length+"条数据,删除"+A.length+"条数据。确认这些操作吗?",function(D){if(D!="yes"){return}g.showSaveProgressBar();g.executeAjax(function(H){g.hideSaveProgressBar();alert(H.message);if(H.ret){var G=(H.insertIds).split(",");var E=0;for(i=0,cnt=o.getCount();i<cnt;i+=1){var F=o.getAt(i);if(F.data.oper_type=="add"){F.data.id=G[E];E++}F.data.oper_type="";F.dirty=false}o.pruneModifiedRecords=true;o.modified=[];grid.view.refresh()}},"apService.saveLink",new ufgov.portal.common.Param(z,"0:com.ufgov.portal.tools.ap.domain.ApLink"),new ufgov.portal.common.Param(A,"0:com.ufgov.portal.tools.ap.domain.ApLink"),new ufgov.portal.common.Param(C,"0:com.ufgov.portal.tools.ap.domain.ApLink"))})}Ext.override(Ext.grid.RowSelectionModel,{onEditorKey:function(D,C){var A=C.getKey(),E,B=this.grid,z=B.activeEditor;var y=C.shiftKey;if(A==C.ENTER){C.stopEvent();z.completeEdit();if(y){E=B.walkCells(z.row,z.col-1,-1,this.acceptsNav,this)}else{E=B.walkCells(z.row,z.col+1,1,this.acceptsNav,this)}}else{if(A==C.TAB){C.stopEvent();z.completeEdit();if(this.moveEditorOnEnter!==false){if(y){E=B.walkCells(z.row-1,z.col,-1,this.acceptsNav,this)}else{E=B.walkCells(z.row+1,z.col,1,this.acceptsNav,this)}}}else{if(A==C.ESC){z.cancelEdit()}}}if(E){B.startEditing(E[0],E[1])}}});var q=new Ext.grid.RowSelectionModel({moveEditorOnEnter:true,singleSelect:true,listeners:{rowselect:function(A,z,y){centerForm.getForm().loadRecord(y)}}});h()});function showWin(c,b){var a=new Ext.Window({title:c,xtype:"window",modal:"true",width:650,height:500,collapsible:false,closable:true,maximizable:true,closeAction:"hide",plain:true,items:[{layout:"fit",autoScroll:true,height:400,autoLoad:{url:b}}]});a.show();return a};